<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="ovk">
<title>Silverbox: GNU/Linux Home Server</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Silverbox: GNU/Linux Home Server</h1>
<div class="details">
<span id="author" class="author">ovk</span><br>
<span id="email" class="email"><a href="https://github.com/ovk">@ovk</a></span><br>
<span id="revnumber">version 1.3.2,</span>
<span id="revdate">May 29, 2022</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#_document_overview">1.1. Document Overview</a></li>
<li><a href="#generating_custom_document">1.2. Generating Custom Document</a></li>
<li><a href="#_getting_involved">1.3. Getting Involved</a></li>
<li><a href="#_license">1.4. License</a></li>
</ul>
</li>
<li><a href="#server_overview">2. Server Overview</a>
<ul class="sectlevel2">
<li><a href="#server_overview_goals">2.1. Goals</a></li>
<li><a href="#_high_level_overview">2.2. High Level Overview</a></li>
<li><a href="#_software_and_services">2.3. Software and Services</a></li>
<li><a href="#hardware">2.4. Hardware</a></li>
</ul>
</li>
<li><a href="#_basic_configuration">3. Basic Configuration</a>
<ul class="sectlevel2">
<li><a href="#_os_installation">3.1. OS Installation</a></li>
<li><a href="#_post_installation_configuration">3.2. Post-Installation Configuration</a></li>
<li><a href="#_ssd_optimization">3.3. SSD Optimization</a></li>
<li><a href="#_ups_configuration">3.4. UPS Configuration</a></li>
<li><a href="#openssh_server_configuration">3.5. OpenSSH Server Configuration</a></li>
<li><a href="#_basic_firewall_configuration">3.6. Basic Firewall Configuration</a></li>
</ul>
</li>
<li><a href="#_monitoring">4. Monitoring</a>
<ul class="sectlevel2">
<li><a href="#_monit">4.1. Monit</a></li>
<li><a href="#_summary_email">4.2. Summary Email</a></li>
<li><a href="#_login_notification">4.3. Login Notification</a></li>
</ul>
</li>
<li><a href="#dns_server">5. DNS Server</a>
<ul class="sectlevel2">
<li><a href="#_installation_2">5.1. Installation</a></li>
<li><a href="#_configuration_2">5.2. Configuration</a></li>
<li><a href="#_updating_dhcp_server_configuration">5.3. Updating DHCP Server Configuration</a></li>
<li><a href="#_monitoring_2">5.4. Monitoring</a></li>
</ul>
</li>
<li><a href="#docker">6. Docker</a>
<ul class="sectlevel2">
<li><a href="#_installation_3">6.1. Installation</a></li>
<li><a href="#_monitoring_3">6.2. Monitoring</a></li>
</ul>
</li>
<li><a href="#socks5_over_vpn">7. SOCKS5 Over VPN</a>
<ul class="sectlevel2">
<li><a href="#_image">7.1. Image</a></li>
<li><a href="#_container">7.2. Container</a></li>
<li><a href="#_monitoring_4">7.3. Monitoring</a></li>
<li><a href="#_client_configuration">7.4. Client Configuration</a></li>
</ul>
</li>
<li><a href="#domain_name">8. Domain Name</a>
<ul class="sectlevel2">
<li><a href="#_dynamic_dns_update">8.1. Dynamic DNS Update</a></li>
<li><a href="#_monitoring_5">8.2. Monitoring</a></li>
</ul>
</li>
<li><a href="#nfs_server">9. NFS Server</a>
<ul class="sectlevel2">
<li><a href="#_domain">9.1. Domain</a></li>
<li><a href="#_kerberos">9.2. Kerberos</a></li>
<li><a href="#_nfs_server_configuration">9.3. NFS Server Configuration</a></li>
<li><a href="#_nfs_client_configuration">9.4. NFS Client Configuration</a></li>
</ul>
</li>
<li><a href="#_transmission">10. Transmission</a>
<ul class="sectlevel2">
<li><a href="#_image_2">10.1. Image</a></li>
<li><a href="#_container_2">10.2. Container</a></li>
<li><a href="#_monitoring_6">10.3. Monitoring</a></li>
<li><a href="#_user_interface">10.4. User Interface</a></li>
</ul>
</li>
<li><a href="#_nextcloud">11. Nextcloud</a>
<ul class="sectlevel2">
<li><a href="#_overview">11.1. Overview</a></li>
<li><a href="#nextcloud_certificate">11.2. Certificate</a></li>
<li><a href="#_installation_4">11.3. Installation</a></li>
<li><a href="#_configuration_3">11.4. Configuration</a></li>
<li><a href="#_monitoring_7">11.5. Monitoring</a></li>
</ul>
</li>
<li><a href="#_git_server">12. Git Server</a>
<ul class="sectlevel2">
<li><a href="#_overview_2">12.1. Overview</a></li>
<li><a href="#_configuration_4">12.2. Configuration</a></li>
</ul>
</li>
<li><a href="#reverse_proxy">13. Reverse Proxy</a>
<ul class="sectlevel2">
<li><a href="#_overview_3">13.1. Overview</a></li>
<li><a href="#_certificate">13.2. Certificate</a></li>
<li><a href="#_installation_5">13.3. Installation</a></li>
<li><a href="#_monitoring_8">13.4. Monitoring</a></li>
</ul>
</li>
<li><a href="#_firefly_iii">14. Firefly III</a>
<ul class="sectlevel2">
<li><a href="#_overview_4">14.1. Overview</a></li>
<li><a href="#_installation_6">14.2. Installation</a></li>
<li><a href="#_monitoring_9">14.3. Monitoring</a></li>
</ul>
</li>
<li><a href="#backup">15. Backup</a>
<ul class="sectlevel2">
<li><a href="#_overview_5">15.1. Overview</a></li>
<li><a href="#_disk_preparation">15.2. Disk Preparation</a></li>
<li><a href="#_configuration_5">15.3. Configuration</a></li>
<li><a href="#_monitoring_10">15.4. Monitoring</a></li>
<li><a href="#_restore_procedure">15.5. Restore Procedure</a></li>
<li><a href="#_references">15.6. References</a></li>
</ul>
</li>
<li><a href="#_maintenance">16. Maintenance</a>
<ul class="sectlevel2">
<li><a href="#_keeping_system_up_to_date">16.1. Keeping System Up to Date</a></li>
<li><a href="#_monitoring_11">16.2. Monitoring</a></li>
<li><a href="#_keeping_system_clean">16.3. Keeping System Clean</a></li>
</ul>
</li>
<li><a href="#_references_2">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock text-center">
<div class="content">
<img src="https://user-images.githubusercontent.com/693072/70379633-1406bd80-18fd-11ea-82d6-209c2bb80f24.png" alt="Logo">
</div>
</div>
<div class="paragraph">
<p>This document describes my setup for a simple home server running GNU/Linux (Ubuntu 18.04).
The server is based on Intel NUC hardware and runs DNS server, NFS server, Nextcloud, SOCKS5 over VPN proxy server,
Transmission (over VPN), Git server and some other services (see <a href="#server_overview">Server Overview</a> for detailed list).</p>
</div>
<div class="paragraph">
<p>The document is always updated to reflect the current state of the software. The revision history can be found in changelog <a href="#changelog">[1]</a>.</p>
</div>
<div class="paragraph">
<p>The document is hosted via GitHub Pages and the source is available at <a href="https://github.com/ovk/silverbox" class="bare">https://github.com/ovk/silverbox</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction">1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_document_overview">1.1. Document Overview</h3>
<div class="paragraph">
<p>Please note that this document is <em>not</em> an exhaustive guide on building a home server,
that deeply explores all different options and possibilities, and explains every single step great in detail.
It is more or less just a documentation for the setup I choose, and it can be opinionated at times.
Whenever there was a choice, I leaned towards secure and simple solutions, rather than fancy and "feature-rich".</p>
</div>
<div class="paragraph">
<p>Following this guide is probably not the most efficient way to build home server,
and you&#8217;d be better off finding some Ansible playbooks that will do everything for you,
or even just a virtual machine image with all the services already configured.
However, I think reading through this guide can be useful if you want to understand how everything works,
especially if you are planning on running and maintaining your server for a long time.</p>
</div>
<div class="paragraph">
<p>While some decisions I had to make were influenced by the specific hardware I use (see <a href="#hardware">Hardware</a> section),
where possible, this document tries to stay hardware agnostic.
You don&#8217;t have to use the exact same hardware as I did (you can even do it all in a virtual machine).
I just wouldn&#8217;t recommend using Raspberry Pi for performance reasons.</p>
</div>
<div class="sect3">
<h4 id="_required_knowledge">1.1.1. Required Knowledge</h4>
<div class="paragraph">
<p>This document expects reader to have some GNU/Linux experience and at least some knowledge in the following areas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Be comfortable in the GNU/Linux terminal and familiar with SSH.</p>
</li>
<li>
<p>Understand simple shell scripting (e.g. <code>sh</code> or <code>bash</code> scripts).</p>
</li>
<li>
<p>Be familiar with basic GNU/Linux command line utilities, such as: <code>sudo</code>, <code>cp/mv/rm</code>, <code>find</code>, <code>grep</code>, <code>sed</code> etc.</p>
</li>
<li>
<p>Be familiar with <code>man</code> pages and be able to explore them on your own.</p>
</li>
<li>
<p>Be at least somewhat familiar with Docker.</p>
</li>
<li>
<p>Be at least somewhat familiar with systemd.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The document doesn&#8217;t try to explain everything, as I believe it is simply impractical are a lot of good documentation already written.
Instead, it provides references to the existing documentation where needed.</p>
</div>
</div>
<div class="sect3">
<h4 id="_structure">1.1.2. Structure</h4>
<div class="paragraph">
<p>The document is split into few top-level chapters, where each chapter (with a few exceptions) represents a separate,
standalone feature, for example: NFS Server, Nextcloud, Torrent Client etc.
While it is possible to skip some chapters, some may have a dependency on another chapters.</p>
</div>
<div class="paragraph">
<p>The document is structured more or less in the order of the configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_formatting_and_naming_conventions">1.1.3. Formatting and Naming Conventions</h4>
<div class="paragraph">
<p>In this document, parts of the sentence that require extra attention are marked with <strong>bold</strong> font.</p>
</div>
<div class="paragraph">
<p>Inline system commands, arguments and file names are formatted with <code>monospace</code> font.</p>
</div>
<div class="paragraph">
<p>Commands that need to be executed in a shell are formatted in monospace blocks.
Command output is formatted as italic (if there is any output).</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">some-command --with --some --arguments
<em>example command output</em></pre>
</div>
</div>
<div class="paragraph">
<p>When a file needs to be edited, the file content is formatted in a similar monospace block.
However, in this case the block will also have header with a file name, indicating what file is edited:</p>
</div>
<div class="listingblock">
<div class="title">example-file.txt</div>
<div class="content">
<pre class="nowrap">File content goes here</pre>
</div>
</div>
<div class="paragraph">
<p>By default, all parameters that are specific to the concrete setup are displayed as placeholders in a curly braces,
for example: <code>{SERVER_IP_ADDR}</code> is what you should replace with your server IP address.
However, you can generate version of this document where all such placeholders replaced with the actual values you want,
more on this in next section.</p>
</div>
<div class="paragraph">
<p>There are also few blocks that are used to draw attention to a specific statement:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This is a note.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This is some useful tip.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This is very important point.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This is a warning.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the document, the server itself is referred as either <em>"the server"</em> or <em>"silverbox"</em>.
<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
When discussing client(s) that communicate to the server, the client device is usually referred as <em>"client PC"</em>,
even though it could be laptop, tablet, smartphone or any other device.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="generating_custom_document">1.2. Generating Custom Document</h3>
<div class="paragraph">
<p>This document contains a lot of placeholder values that will have to be replaced with the actual values,
specific to your setup. Some examples of such values are host names, IP addresses, subnets, usernames etc.
It may be cumbersome to manually keep track of what needs to be replaced with what,
especially when copying scripts or configuration files.</p>
</div>
<div class="paragraph">
<p>Fortunately, you can generate your own version of this document
where all placeholders will be automatically replaced with the actual values that you want.</p>
</div>
<div class="paragraph">
<p>This can easily be done in three steps using Docker:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get the source code of this document from Git:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">git clone https://github.com/ovk/silverbox.git</pre>
</div>
</div>
</li>
<li>
<p>Edit <code>silverbox/parameters.adoc</code> file and replace placeholder values with the values you want.</p>
</li>
<li>
<p>Run disposable Docker container with Asciidoctor to compile the document to desired output:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>For HTML output:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">docker run -it --rm -v $(pwd)/silverbox:/documents asciidoctor/docker-asciidoctor asciidoctor silverbox-server.adoc</pre>
</div>
</div>
</li>
<li>
<p>For PDF output:</p>
<div class="listingblock">
<div class="content">
<pre class="nowrap">docker run -it --rm -v $(pwd)/silverbox:/documents asciidoctor/docker-asciidoctor asciidoctor-pdf silverbox-server.adoc</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This should produce output file (<code>silverbox-server.html</code> or <code>silverbox-server.pdf</code>) in the <code>silverbox</code> directory,
where all the placeholders replaced with your values.</p>
</div>
<div class="paragraph">
<p>Now you can mostly just copy-paste code snippets without having to manually edit them first.</p>
</div>
</div>
<div class="sect2">
<h3 id="_getting_involved">1.3. Getting Involved</h3>
<div class="paragraph">
<p>If you find a typo or error in this document, or if you think that some part could be explained in more details,
updated, or improved in any way - please open an issue at <a href="https://github.com/ovk/silverbox/issues" class="bare">https://github.com/ovk/silverbox/issues</a> or make a pull request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_license">1.4. License</h3>
<div class="paragraph">
<p>This document is licensed under Creative Commons Attribution-NonCommercial 4.0 International (CC BY-NC 4.0).</p>
</div>
<div class="paragraph">
<p>For more details see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://creativecommons.org/licenses/by-nc/4.0" class="bare">https://creativecommons.org/licenses/by-nc/4.0</a></p>
</li>
<li>
<p><a href="https://creativecommons.org/licenses/by-nc/4.0/legalcode" class="bare">https://creativecommons.org/licenses/by-nc/4.0/legalcode</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server_overview">2. Server Overview</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="server_overview_goals">2.1. Goals</h3>
<div class="paragraph">
<p>Main goals that affected overall design of the server are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Simplicity</dt>
<dd>
<p>Where possible, this document prefers simple solutions, i.e. solutions that require less configuration,
fewer components and minimize bloat. Simple solutions are often more secure (due to limited attack surface),
easy to understand and maintain, easy to extend and use less resources.</p>
</dd>
<dt class="hdlist1">Stability</dt>
<dd>
<p>The server design is heavily focused on stability of configuration and setup.
While there are many new "fancy" and "feature-rich" tools and programs that could be used,
I find that vast majority of them have very short life span,
minimal to no backward/forward compatibility and meaningful upgrade path, often very poor support and documentation,
lack of security updates etc.
Instead, the choices were made in favor of mature, stable, proven software, that doesn&#8217;t break compatibility every
minor release.</p>
</dd>
<dt class="hdlist1">Security</dt>
<dd>
<p>Major considerations were given to security when designing the server setup.
While I think the solution in general is secure enough for home use, I still would not recommend to keep any
sensitive information on the server.</p>
</dd>
<dt class="hdlist1">Low Maintenance</dt>
<dd>
<p>Another major focus was keeping the server maintenance as small as possible.
This goes hand in hand with stability, and also relies on tools and automation to keep server maintenance as minimal
as possible.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It is important to mention that this server is <strong>not</strong> a:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">NAS</dt>
<dd>
<p>It is not intended to be used for safe storage of massive amounts of data (at least not in the described configuration).</p>
</dd>
<dt class="hdlist1">Media Server</dt>
<dd>
<p>It is not running anything related to the media server, no Kodi, not even X server.
Although, turning it into a media server is definitely possible
(I know of a person who added containerized Kodi on top of this guide and took advantage of NUCs infrared port).</p>
</dd>
<dt class="hdlist1">Proprietary Server</dt>
<dd>
<p>It is not running any proprietary, closed-source solutions, even if they are free (free as in beer).
So you won&#8217;t find anything like Plex or Mineraft server here, but you could definitely add these on your own if you wish.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_high_level_overview">2.2. High Level Overview</h3>
<div class="paragraph">
<p>The diagram below shows the server place in the home network:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">                            LAN
                           ---------------------------------
          --------        |                   -----------   |
   WAN   |  WiFi  |       |   -----------    | Client PC |  |
&lt;-------&gt;| Router |&lt;-----&gt;|  | Silverbox |    -----------   |
          --------        |   -----------     -----------   |
          - DHCP          |   - DNS          | Client PC |  |
                          |   - ...           -----------   |
                          |                   -----------   |
                          |                  |   .....   |  |
                          |                   -----------   |
                           ---------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>The server is on the Local Area Network (together with regular clients such as PCs, smartphones etc.) and
it acts as DNS server (apart from all the other services and programs it runs).
It is separated from the internet by the router (and thus sits behind NAT).</p>
</div>
<div class="paragraph">
<p>Of course, this is just one of the options (but probably one of the most common ones) and it can be adjusted to suit
your needs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In my case, all the clients are also Linux-based. This is not a requirement, and you may have clients running
Windows, MacOS or other OS, but in such case client configuration will obviously be different.
In some parts of this document it is assumed that your client is x86 64-bit PC running Desktop Ubuntu Linux 18.04.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_software_and_services">2.3. Software and Services</h3>
<div class="paragraph">
<p>This is the list of services running on the server that are described in this document:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Unbound</strong> as a forwarding DNS server that forwards queries to the DNS server of your choice and uses DNS-over-TLS and DNSSEC for
extra security and privacy.</p>
</li>
<li>
<p><strong>NFS server</strong> secured with Kerberos (clean NFSv4-only server).</p>
</li>
<li>
<p><strong>Nextcloud</strong> accessible over HTTPS with Let&#8217;s Encrypt certificates (renewed automatically using Certbot with DNS challenge).</p>
</li>
<li>
<p><strong>Transmission</strong> BitTorent client that communicates only over a VPN connection.</p>
</li>
<li>
<p><strong>SOCKS5 proxy server</strong> that proxies traffic securely over a VPN connection.</p>
</li>
<li>
<p><strong>Git server</strong> for hosting Git repositories.</p>
</li>
<li>
<p><strong>Borg and Rclone</strong> for automatic encrypted incremental backups (both on-site and off-site).</p>
</li>
<li>
<p><strong>Reverse proxy server</strong> with HTTPS (using wildcard certificate) and basic authentication to access internal services.</p>
</li>
<li>
<p><strong>Firefly III</strong> for personal finances management.</p>
</li>
<li>
<p><strong>Monit</strong> for system monitoring and notifications.</p>
</li>
<li>
<p>Script to automatically update DNS record pointing to server&#8217;s public IP address (in case of dynamic IP).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The server also runs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SSH server.</p>
</li>
<li>
<p>Docker engine (as most of the workloads are run as containers).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="hardware">2.4. Hardware</h3>
<div class="paragraph">
<p>Originally, the server was placed on a shelf inside a small apartment, so the main criteria for the hardware were
low noise (i.e. no fans, HDD or other moving parts), nice design (so no open PCBs or wires)
and reasonable power consumption for 24/7 operation.</p>
</div>
<div class="paragraph">
<p>Below is the list of hardware that was originally used for the server (just for the reference).</p>
</div>
<div class="sect3">
<h4 id="_computer">2.4.1. Computer</h4>
<div class="paragraph">
<p>Intel NUC (Next Unit of Computing) BOXNUC6CAYH Barebone Systems.</p>
</div>
<div class="paragraph">
<p>It uses Intel&#174; Celeron&#174; CPU J3455 (4 cores, up to 2.3 GHz).</p>
</div>
</div>
<div class="sect3">
<h4 id="_storage">2.4.2. Storage</h4>
<div class="paragraph">
<p>Main disk: WD Blue 500Gb Sata SSD.</p>
</div>
<div class="paragraph">
<p>External backup disk: Samsung T5 500Gb Portable SSD (USB 3.1 Gen2).</p>
</div>
</div>
<div class="sect3">
<h4 id="_memory">2.4.3. Memory</h4>
<div class="paragraph">
<p>8GB 1600mhz DDR3L SODIMM KVR16LS11/8.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ups">2.4.4. UPS</h4>
<div class="paragraph">
<p>While strictly speaking this is not a part of the server, and technically not required, UPS is highly recommended.</p>
</div>
<div class="paragraph">
<p>The UPS that was used: Eaton 3S US550VA 5-15P (8) 5-15R 4-UPS.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When choosing UPS, make sure you buy one that has decent Linux support.
Compatibility with Network UPS Tools can be checked on the NUT hardware compatibility list <a href="#nut_hcl">[2]</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_additional_hardware">2.4.5. Additional Hardware</h4>
<div class="paragraph">
<p>You will also need a monitor, USB keyboard, patch cord and USB flash drive for the OS installation and initial configuration.
Later on, you will probably want to have a separate keyboard attached to the server,
to type LUKS password after reboots.</p>
</div>
</div>
<div class="sect3">
<h4 id="_power_consumption">2.4.6. Power Consumption</h4>
<div class="paragraph">
<p>Since the server doesn&#8217;t have power-hungry devices attached (such as HDDs or monitors), it is fairly low power.
I didn&#8217;t measure power consumption precisely, but based on the rate of UPS battery discharge
my guess was around 8-12W at idle.
However, as reported by a Reddit user with a similar hardware, the power consumption at idle is around 6W.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_configuration">3. Basic Configuration</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_os_installation">3.1. OS Installation</h3>
<div class="paragraph">
<p>Ubuntu Server 18.04 was chosen as an operating system for the server.
The reasoning behind this choice is that it is pretty mature and stable server OS,
with lot of software and documentation available due to its popularity.</p>
</div>
<div class="paragraph">
<p>The Ubuntu installation itself is pretty straightforward, and there are many excellent guides available,
so it is not described in details in this document. Only some important points described here.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
At the moment of writing, the default Ubuntu image was using new installer
that was missing quite a few important features, including full disk encryption.
As a workaround, don&#8217;t download default Ubuntu Server installer,
and instead follow to the releases page and download <em>"Alternative Ubuntu Server installer"</em>.
This installer should have full support for LVM and disk encryption.
Hopefully, the new installer will be updated eventually and missing features will be added.
It&#8217;s a good idea to first try it on the virtual machine before installing on the real server.
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
While internet is not required during installation, it makes it a bit easier and more convenient.
So make sure you plug the server to the working internet connection.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Roughly, the installation process looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a bootable USB flash drive with Ubuntu installer image.</p>
</li>
<li>
<p>Connect server to power, monitor, network, keyboard, insert USB stick and power it on. Ubuntu installation will begin.</p>
</li>
<li>
<p>Partition disk manually according to your needs. For example, the following partitioning scheme was used:</p>
<div class="ulist">
<ul>
<li>
<p>Bootable EFI system partition</p>
</li>
<li>
<p>2GB <code>ext4</code> partition for <code>/boot</code> (to have some extra space for old kernels)</p>
</li>
<li>
<p><code>dm-crypt</code> partition with LVM on it in the following configuration:</p>
<div class="ulist">
<ul>
<li>
<p>One volume group (VG) with:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Root logical volume (LV) for <code>/</code> with <code>ext4</code> file system</p>
</li>
<li>
<p>Swap logical volume (LV). The size needs to be greater than size of RAM if you need hibernation support.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Some unallocated (free) space to (hopefully) prolong life of SSD.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Make sure you enable automatic security updates during installation.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>No additional software packages were chosen during installation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_post_installation_configuration">3.2. Post-Installation Configuration</h3>
<div class="sect3">
<h4 id="_set_correct_timezone">3.2.1. Set Correct Timezone</h4>
<div class="paragraph">
<p>If for whatever reason the correct time zone was not set during installation, set it now with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo timedatectl set-timezone {YOUR_TIMEZONE}</pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>{YOUR_TIMEZONE}</code> is your desired timezone (for example, <code>Europe/Athens</code>).
The list of available time zones can be obtained with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">timedatectl list-timezones</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_disable_unused_hardware">3.2.2. Disable Unused Hardware</h4>
<div class="paragraph">
<p>Optionally, you can disable hardware that you are not planning to use for security, privacy,
boot speed, power saving and other reasons. Some examples of what you can disable below.</p>
</div>
<div class="sect4">
<h5 id="_wifi">WiFi</h5>
<div class="paragraph">
<p>Wireless adapter can be easily disabled in BIOS.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
After disabling wireless adapter your wired adapter name will likely change
(due to the way Linux enumerates devices).
In this case, network connectivity can be fixed by editing the file <code>/etc/netplan/01-netcfg.yaml</code>
and updating wired interface name there.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_bluetooth">Bluetooth</h5>
<div class="paragraph">
<p>Disabling Bluetooth adapter wasn&#8217;t possible with default NUC BIOS and required BIOS update.
After the update Bluetooth can be disabled in the bios.</p>
</div>
</div>
<div class="sect4">
<h5 id="_digital_microphone">Digital Microphone</h5>
<div class="paragraph">
<p>Microphone can be disabled in the BIOS as well.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_disable_ipv6">3.2.3. Disable IPv6</h4>
<div class="paragraph">
<p>Unless you are planning on using IPv6, it is good idea to disable it for security reasons.
The rest of this document assumes IPv6 is disabled and thus all configuration is for IPv4 only.</p>
</div>
<div class="paragraph">
<p>To disable IPv6 edit the file <code>/etc/default/grub</code> and add (or set) the following parameters:</p>
</div>
<div class="listingblock">
<div class="title">/etc/default/grub</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="ini"><span class="py">GRUB_CMDLINE_LINUX</span><span class="p">=</span><span class="s">"ipv6.disable=1"</span>
<span class="py">GRUB_CMDLINE_LINUX_DEFAULT</span><span class="p">=</span><span class="s">"ipv6.disable=1"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Update Grub configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo update-grub</pre>
</div>
</div>
<div class="paragraph">
<p>And then reboot the system.</p>
</div>
<div class="paragraph">
<p>To check that IPv6 is disabled you can grep for <em>IPv6</em> in the <code>dmesg</code> output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">dmesg | grep IPv6
<em>IPv6: Loaded, but administratively disabled, reboot required to enable</em></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configure_static_ip">3.2.4. Configure Static IP</h4>
<div class="paragraph">
<p>To make lot of things easier and more predictable, a static network configuration is used for the server instead of DHCP.
This also helps to prevent DHPC server from accidentally changing network configuration (especially DNS).</p>
</div>
<div class="paragraph">
<p>From now on in this document when talking about the server network configuration the following conventions will be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Server IP address: <code>{SERVER_IP_ADDR}</code></p>
</li>
<li>
<p>Default gateway: <code>{SERVER_DEFAULT_GATEWAY}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, choose an IP address (<code>{SERVER_IP_ADDR}</code>) and create a DHCP reservation on the DHCP server (most likely router) for it.</p>
</div>
<div class="paragraph">
<p>To update network configuration, edit the <code>/etc/netplan/01-netcfg.yaml</code> file and update
the <code>ethernets</code> section in it so that it matches desired network configuration:</p>
</div>
<div class="listingblock">
<div class="title">/etc/netplan/01-netcfg.yaml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">ethernets</span><span class="pi">:</span>
  <span class="na">enp2s0</span><span class="pi">:</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">addresses</span><span class="pi">:</span> <span class="pi">[</span> <span class="pi">{</span><span class="nv">SERVER_IP_ADDR</span><span class="pi">}</span><span class="nv">/24</span> <span class="pi">]</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">gateway4</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">SERVER_DEFAULT_GATEWAY</span><span class="pi">}</span>
    <span class="na">nameservers</span><span class="pi">:</span>
      <span class="na">addresses</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">127.0.0.1</span> <span class="pi">]</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="na">dhcp4</span><span class="pi">:</span> <span class="s">no</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the wired interface name, it may be different on your system.
To find out what name to use check the <code>ifconfig</code> command output.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace this with your actual server IP address and your subnet size in bits (most likely 24).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Put your actual DNS server address here.
This is temporary, and will be set back to <code>127.0.0.1</code> once DNS server is configured.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To apply new configuration do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo netplan apply</pre>
</div>
</div>
<div class="paragraph">
<p>You can also reboot the system to double check that everything works.</p>
</div>
</div>
<div class="sect3">
<h4 id="_disable_icmp_redirects_and_source_routing">3.2.5. Disable ICMP Redirects and Source Routing</h4>
<div class="paragraph">
<p>To disable ICMP redirects and IP source routing (for security reasons), edit the <code>/etc/sysctl.conf</code> file
and uncomment the following lines:</p>
</div>
<div class="listingblock">
<div class="title">/etc/sysctl.conf</div>
<div class="content">
<pre class="nowrap">net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0</pre>
</div>
</div>
<div class="paragraph">
<p>The changes will be applied after reboot.</p>
</div>
</div>
<div class="sect3">
<h4 id="_remove_unneeded_software">3.2.6. Remove Unneeded Software</h4>
<div class="paragraph">
<p>Now is a good time to remove or disable any software that you are not planning to use.</p>
</div>
</div>
<div class="sect3">
<h4 id="_uninstall_snap">3.2.7. Uninstall Snap</h4>
<div class="paragraph">
<p>There are many, many issues with Snap (aka <code>snapd</code>) which I&#8217;m not going to describe here.</p>
</div>
<div class="paragraph">
<p>Unless you really need it, you can remove it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt autoremove --purge snapd</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_uninstall_lxclxd">3.2.8. Uninstall LXC/LXD</h4>
<div class="paragraph">
<p>Unless you are planning to use it, you can also remove LXC/LXD to free up some system resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt autoremove --purge lxd lxcfs liblxc-common lxd-client</pre>
</div>
</div>
<div class="paragraph">
<p>It can always be installed later on if required.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ssd_optimization">3.3. SSD Optimization</h3>
<div class="paragraph">
<p>Since the server is equipped with SSD, some configuration needs to be done in order to optimize SSD performance
and minimize the number of writes (thus prolonging SSD life).</p>
</div>
<div class="paragraph">
<p>A lot of useful information about SSD-related configuration in Linux
can be found in the Arch Wiki article about SSD <a href="#arch_wiki_ssd">[3]</a>.</p>
</div>
<div class="sect3">
<h4 id="_trim">3.3.1. TRIM</h4>
<div class="paragraph">
<p>A TRIM command informs an SSD about what blocks are no longer used and can be recycled.
Doing TRIM can improve SSD write performance.</p>
</div>
<div class="paragraph">
<p>First make sure that your SSD supports TRIM.
One way to do it is to check the output of the following command (replace <code>/dev/sda</code> with your disk device):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo hdparm -I /dev/sda | grep TRIM
<em>* Data Set Management TRIM supported (limit 8 blocks)</em></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If your disk doesn&#8217;t support TRIM, you can skip the rest of this section.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>TRIM needs to be enabled on all abstraction layers,
which in the case of the silverbox server means on the file system level, LVM level and dm-crypt level.</p>
</div>
<div class="sect4">
<h5 id="_enabling_trim_on_file_system_level">Enabling TRIM on File System Level</h5>
<div class="paragraph">
<p>Periodic file system TRIM should be enabled by default in Ubuntu 18.04.
There should be Systemd timer that performs <code>fstrim</code> every week.</p>
</div>
<div class="paragraph">
<p>To check its status, do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">systemctl status fstrim.timer</pre>
</div>
</div>
<div class="paragraph">
<p>Logs from previous runs can be viewed with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">journalctl -u fstrim.service</pre>
</div>
</div>
<div class="paragraph">
<p>You can run the service manually and inspect the logs to make sure it works.
To run the service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl start fstrim.service</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_enabling_trim_on_lvm_level">Enabling TRIM on LVM Level</h5>
<div class="paragraph">
<p>Edit the <code>/etc/lvm/lvm.conf</code> file and set <code>issue_discards</code> parameter to 1 (it should be under the <code>devices</code> section):</p>
</div>
<div class="listingblock">
<div class="title">/etc/lvm/lvm.conf</div>
<div class="content">
<pre class="nowrap">...
devices {
    ...
    issue_discards = 1
    ...
}
...</pre>
</div>
</div>
<div class="paragraph">
<p>Most likely it will already be there and set to 1 so you just need to double check.</p>
</div>
<div class="paragraph">
<p>Note that the <code>issue_discards</code> parameter here only controls whether to send discards during operations on LVM volumes,
such as resizing or removing.
Discards for deleted files should be passed through by default.</p>
</div>
</div>
<div class="sect4">
<h5 id="_enabling_trim_on_dm_crypt_level">Enabling TRIM on dm-crypt Level</h5>
<div class="paragraph">
<p>Edit the <code>/etc/crypttab</code> file and add <code>discard</code> option to options for your device.
Below is an example for <code>sda3</code>:</p>
</div>
<div class="listingblock">
<div class="title">/etc/crypttab</div>
<div class="content">
<pre class="nowrap">sda3_crypt UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX none luks,discard</pre>
</div>
</div>
<div class="paragraph">
<p>Most likely it will already be there so you just need to double check.</p>
</div>
</div>
<div class="sect4">
<h5 id="_verifying_that_trim_works">Verifying that TRIM Works</h5>
<div class="paragraph">
<p>A procedure for TRIM verification is described in this excellent StackOverflow answer:
<a href="https://unix.stackexchange.com/questions/85865/trim-with-lvm-and-dm-crypt/85880#85880" class="bare">https://unix.stackexchange.com/questions/85865/trim-with-lvm-and-dm-crypt/85880#85880</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_write_caching">3.3.2. Write Caching</h4>
<div class="paragraph">
<p>Write caching can greatly improve performance and minimize writes on SSD.
It should be enabled by default.</p>
</div>
<div class="paragraph">
<p>To check if write caching is enabled, check the output of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo hdparm -W /dev/sda <i class="conum" data-value="1"></i><b>(1)</b>
<em>/dev/sda:</em>
 <em>write-caching =  1 (on)</em></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/dev/sda</code> with your disk device.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Or alternatively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo hdparm -i /dev/sda | grep WriteCache <i class="conum" data-value="1"></i><b>(1)</b>
<em>... WriteCache=enabled ...</em></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/dev/sda</code> with your disk device.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_swappiness">3.3.3. Swappiness</h4>
<div class="paragraph">
<p>Lowering system swappiness can increase the threshold of when memory pages will be swapped to disk,
and thus potentially limit the number of writes to the SSD.
More about swapiness here: <a href="https://en.wikipedia.org/wiki/Paging#Swappiness" class="bare">https://en.wikipedia.org/wiki/Paging#Swappiness</a>.</p>
</div>
<div class="paragraph">
<p>Current (default) system swappiness can be checked with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sysctl vm.swappiness
<em>vm.swappiness = 60</em></pre>
</div>
</div>
<div class="paragraph">
<p>If you decide to change it, this can be done by editing the <code>/etc/sysctl.conf</code> file and adding (or chanigng)
parameter <code>vm.swappiness</code>, for example:</p>
</div>
<div class="listingblock">
<div class="title">/etc/sysctl.conf</div>
<div class="content">
<pre class="nowrap">...
vm.swappiness = 40
...</pre>
</div>
</div>
<div class="paragraph">
<p>Change will be in effect after reboot.</p>
</div>
</div>
<div class="sect3">
<h4 id="mounting_tmp_as_tmpfs">3.3.4. Mounting /tmp as tmpfs</h4>
<div class="paragraph">
<p>To minimize writes to SSD even further, the <code>/tmp</code> directory can be mounted as <code>tmpfs</code> (aka RAM file system) mount.
This can be either done with Systemd <code>tmp.mount</code> unit or by editing <code>fstab</code>.
According to the Systemd documentation (at least at the moment of writing), using the <code>fstab</code> is the preferred approach.</p>
</div>
<div class="paragraph">
<p>To automatically mount <code>/tmp</code> as <code>tmpfs</code>, add the following line to the <code>/etc/fstab</code> file:</p>
</div>
<div class="listingblock">
<div class="title">/etc/fstab</div>
<div class="content">
<pre class="nowrap">tmpfs /tmp tmpfs defaults,noatime,nosuid,nodev,noexec,mode=1777,size=2G 0 0</pre>
</div>
</div>
<div class="paragraph">
<p>In this example, its size is limited to 2G, but you can adjust it if needed.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
A <code>noexec</code> option can sometime cause issues with programs that put something under <code>/tmp</code> and then try to execute it.
If this happens, you can remove this option.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reboot the system and verify the output of <code>df -h</code> to make sure <code>/tmp</code> is now mounted as <code>tmpfs</code> with the limit you&#8217;ve set.
It should contain line similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">tmpfs    2.0G  0  2.0G   0% /tmp</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_monitoring_tools">3.3.5. Monitoring Tools</h4>
<div class="paragraph">
<p>There are some tools that are useful for SSD monitoring, and will be used in the next sections.</p>
</div>
<div class="paragraph">
<p>The first one is <code>hddtemp</code>, that is used to monitor disk temperature.
To install it do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install hddtemp</pre>
</div>
</div>
<div class="paragraph">
<p>The second one is <code>smartmontools</code>, that is used to monitor SSD wear (and other parameters) via SMART.
To install it do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install smartmontools --no-install-recommends</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ups_configuration">3.4. UPS Configuration</h3>
<div class="paragraph">
<p>For a graceful server shutdown in case of power outage, the server needs to be able to communicate to the UPS
to get its status.
Usually, UPS is connected to the server by USB and Network UPS Tools (NUT) is used to get UPS status.</p>
</div>
<div class="sect3">
<h4 id="_network_ups_tools_nut_installation">3.4.1. Network UPS Tools (NUT) Installation</h4>
<div class="paragraph">
<p>NUT can be easily installed by doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install nut</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nut_configuration">3.4.2. NUT Configuration</h4>
<div class="paragraph">
<p>The NUT configuration consists of three different parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configuring the <em>driver</em> (talks to UPS)</p>
</li>
<li>
<p>Configuring the <em>server</em> (<code>upsd</code> daemon, talks to the driver)</p>
</li>
<li>
<p>Configuring the <em>monitor</em> (<code>upsmon</code>, monitors the server and takes action based on the received information)</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="_configuring_nut_driver">Configuring NUT Driver</h5>
<div class="paragraph">
<p>The driver type for NUT can be checked on the NUT Compatibility Page <a href="#nut_hcl">[2]</a>.
In the case of Eaton 3S UPS the driver is <code>usbhid-ups</code>.</p>
</div>
<div class="paragraph">
<p>Edit the <code>/etc/nut/ups.conf</code> file and append section for your UPS, for example:</p>
</div>
<div class="listingblock">
<div class="title">/etc/nut/ups.conf</div>
<div class="content">
<pre class="nowrap">[eaton3s]
    driver=usbhid-ups
    port=auto</pre>
</div>
</div>
<div class="paragraph">
<p>Start the driver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo upsdrvctl start</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_nut_server">Configuring NUT Server</h5>
<div class="paragraph">
<p>General <code>upsd</code> configuration is done by editing the <code>/etc/nut/upsd.conf</code> file, if necessary.</p>
</div>
<div class="paragraph">
<p>Edit the <code>/etc/nut/nut.conf</code> file and change <code>MODE</code> to <code>standalone</code>:</p>
</div>
<div class="listingblock">
<div class="title">/etc/nut/nut.conf</div>
<div class="content">
<pre class="nowrap">MODE=standalone</pre>
</div>
</div>
<div class="paragraph">
<p>A user for the monitor needs to be added to the <code>/etc/nut/upsd.users</code> file (replace <code>{SOME_PASSWORD}</code> with some random password):</p>
</div>
<div class="listingblock">
<div class="title">/etc/nut/upsd.users</div>
<div class="content">
<pre class="nowrap">[upsmon]
    password = {SOME_PASSWORD}
    upsmon master</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>upsd</code> server can now be started with <code>sudo systemctl start nut-server</code> command.
Once started successfully, the UPS info can be queried with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">upsc eaton3s</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_configuring_nut_monitor">Configuring NUT Monitor</h5>
<div class="paragraph">
<p>Change the <code>MONITOR</code> value in the <code>/etc/nut/upsmon.conf</code> file like so (use the same password you used in the previous step):</p>
</div>
<div class="listingblock">
<div class="title">/etc/nut/upsmon.conf</div>
<div class="content">
<pre class="nowrap">MONITOR eaton3s@localhost 1 upsmon {SOME_PASSWORD} master</pre>
</div>
</div>
<div class="paragraph">
<p>Start the monitor service with <code>sudo systemctl start nut-monitor</code> command.</p>
</div>
<div class="paragraph">
<p>At this point system should be configured to do graceful shutdown when UPS is on battery and battery reaches <code>battery.charge.low</code> level.
The <code>battery.charge.low</code> value can be obtained with <code>upsc eaton3s | grep 'battery.charge.low'</code>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_useful_references">3.4.3. Useful References</h4>
<div class="paragraph">
<p>Some useful information to read about NUT:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Arch Wiki article about NUT: <a href="https://wiki.archlinux.org/index.php/Network_UPS_Tools" class="bare">https://wiki.archlinux.org/index.php/Network_UPS_Tools</a></p>
</li>
<li>
<p>NUT Documentation: <a href="https://networkupstools.org/docs/user-manual.chunked/ar01s06.html" class="bare">https://networkupstools.org/docs/user-manual.chunked/ar01s06.html</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="openssh_server_configuration">3.5. OpenSSH Server Configuration</h3>
<div class="paragraph">
<p>To access the server over SSH, an OpenSSH server needs to be installed and configured.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is important to make sure that server is on isolated network or directly connected to the PC
from which it will be accessed.
It is important to keep the server isolated until it is properly hardened and secured.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_openssh_server_installation">3.5.1. OpenSSH Server Installation</h4>
<div class="paragraph">
<p>OpenSSH server can be installed with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install openssh-server</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_generating_and_copying_key">3.5.2. Generating and Copying Key</h4>
<div class="paragraph">
<p>Only key authentication will be enabled for SSH server (with password and other authentication methods disabled).
However, it is convenient to copy the access key over SSH while password authentication still enabled.
The following steps need to be performed on the client PC.</p>
</div>
<div class="paragraph">
<p>Generate key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh-keygen -t ed25519 -f ~/.ssh/silverbox-key -C "Silverbox key"</pre>
</div>
</div>
<div class="paragraph">
<p>Copy generated key to the server (<code>{SERVER_USER}</code> assumed to be your used on the server):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh-copy-id -i ~/.ssh/silverbox-key {SERVER_USER}@{SERVER_IP_ADDR}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ssh_server_configuration_security_hardening">3.5.3. SSH Server Configuration &amp; Security Hardening</h4>
<div class="paragraph">
<p>The next step is to perform some basic configuration and security hardening for the SSH server.</p>
</div>
<div class="paragraph">
<p>SSH server is configured by modifying the <code>/etc/ssh/sshd_config</code> file.
Change (or add, if not present) the following parameters in this file:</p>
</div>
<div class="listingblock">
<div class="title">/etc/ssh/sshd_config</div>
<div class="content">
<pre class="nowrap">AddressFamily inet
Protocol 2

HostKey /etc/ssh/ssh_host_ed25519_key
HostKey /etc/ssh/ssh_host_rsa_key

KexAlgorithms curve25519-sha256@libssh.org
Ciphers chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes256-ctr
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com

LogLevel VERBOSE

LoginGraceTime 1m
PermitRootLogin no
MaxAuthTries 4
MaxSessions 5

ClientAliveCountMax 2
ClientAliveInterval 60
TCPKeepAlive no

AuthenticationMethods publickey

PubkeyAuthentication yes

HostbasedAuthentication no
IgnoreRhosts yes

PasswordAuthentication no
PermitEmptyPasswords no

ChallengeResponseAuthentication no

X11Forwarding no
AllowAgentForwarding no
AllowTcpForwarding local

Banner none
DebianBanner none

AllowUsers {SERVER_USER}</pre>
</div>
</div>
<div class="paragraph">
<p>Restart SSH server service for the changes to take effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart sshd</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_additional_resources">3.5.4. Additional Resources</h4>
<div class="paragraph">
<p>Below are some useful resources related to SSH server configuration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mozilla SSH server configuration guide: <a href="https://infosec.mozilla.org/guidelines/openssh" class="bare">https://infosec.mozilla.org/guidelines/openssh</a></p>
</li>
<li>
<p>Good overview of SSH server cryptography: <a href="https://stribika.github.io/2015/01/04/secure-secure-shell.html" class="bare">https://stribika.github.io/2015/01/04/secure-secure-shell.html</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Additionally, you can run SSH audit script <a href="#ssh_audit">[4]</a> against your SSH server. It haven&#8217;t been updated since 2016 though.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_firewall_configuration">3.6. Basic Firewall Configuration</h3>
<div class="paragraph">
<p>By default, Ubuntu will already have Uncomplicated Firewall (UFW) installed, but it will be disabled (inactive).</p>
</div>
<div class="paragraph">
<p>Its status can be checked with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw status verbose</pre>
</div>
</div>
<div class="paragraph">
<p>Before activating firewall, first enable rate limiting for SSH (so that the server can be accessed over SSH).
Rate limiting will allow access over the port, but will limit connection attempts to 6 attempts within 30 seconds.
For more flexible configuration (e.g. different number of attempts or duration) the <code>iptables</code> have to be used directly,
as  UFW doesn&#8217;t allow this kind of flexibility.</p>
</div>
<div class="paragraph">
<p>To enable SSH access with rate limiting do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw limit ssh comment "SSH Access"</pre>
</div>
</div>
<div class="paragraph">
<p>You can optionally disable UFW logs (sometimes they can flood syslog if you have some service discovery protocols running):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw logging off</pre>
</div>
</div>
<div class="paragraph">
<p>Now UFW can be enabled with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw enable</pre>
</div>
</div>
<div class="paragraph">
<p>In this configuration UFW will startup automatically and block all incoming connections (by default) but allow (rate limited) SSH.
All outgoing connections are allowed.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monitoring">4. Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A monitoring system is needed to monitor server&#8217;s hardware, system, environment, services
and send notifications if something goes wrong or looks suspicious.
As mentioned in the <a href="#server_overview_goals">Goals</a> section, the server needs to be as automated as possible,
so the monitoring systems needs to be as autonomous as possible, and not require any supervision or maintenance.</p>
</div>
<div class="paragraph">
<p>A number of solutions was considered for the server monitoring (and quite few of them I tried),
but most of them were discarded due to being too complicated to install and configure (and thus being an overkill for a home server),
or due to having too many dependencies and bloat, or being outdated and not well supported,
or the opposite - changing at insane pace.
Some of the solutions that were considered are: Nagios, Zabbix, Netdata, Munin, Cacti
and some combination of Prometheus/Grafana/Collectd/Graphite/Telegraf/InfluxDB.</p>
</div>
<div class="paragraph">
<p>Eventually, Monit was chosen as the main monitoring tool.
While it may seem very limited at the first glance, it is actually quite powerful tool to monitor wide range of parameters
and react to specific conditions.
Monit is easy to extend and customize, it is maintained, very lightweight, with minimum dependencies and very low
runtime overhead.
The only significant downside is that it has no support for time series, and thus it is not possible to see
historical data, graphs or analyze trends.</p>
</div>
<div class="paragraph">
<p>In addition to Monit, a simple script was created to generate and deliver regular emails
with system summary information.</p>
</div>
<div class="sect2">
<h3 id="_monit">4.1. Monit</h3>
<div class="paragraph">
<p>This section describes Monit installation and configuration for monitoring basic system parameters (such as
CPU and RAM utilization, temperatures, etc.).
Monitoring of specific services (e.g. DNS server, Docker, Nextcloud) is described in the corresponding sections.
For example, section on DNS server setup describes how to add DNS server monitoring to Monit.</p>
</div>
<div class="sect3">
<h4 id="_installation">4.1.1. Installation</h4>
<div class="paragraph">
<p>Monit can be installed directly from the repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install monit</pre>
</div>
</div>
<div class="paragraph">
<p>This will create and start Systemd service for Monit. Its status can be checked with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">systemctl status monit</pre>
</div>
</div>
<div class="paragraph">
<p>After installation, create a directory where custom scripts for Monit will be stored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir -p /usr/local/etc/monit/scripts</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration">4.1.2. Configuration</h4>
<div class="paragraph">
<p>The main Monit configuration file is located at <code>/etc/monit/monitrc</code>.
The defaults there are pretty sensible, but of course you can adjust them if you need to.
For example, to set check interval and startup delay to one minute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">set daemon 60
  with start delay 60</pre>
</div>
</div>
<div class="sect4">
<h5 id="_cpu_temperature_script">CPU Temperature Script</h5>
<div class="paragraph">
<p>System temperatures can be read directly from <code>procfs</code>, but using <code>lm-sensors</code> package makes it more convenient to parse.
To install the <code>lm-sensors</code> package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install lm-sensors</pre>
</div>
</div>
<div class="paragraph">
<p>As <code>root</code> user, create CPU temperature monitoring script <code>/usr/local/etc/monit/scripts/cpu_temp.sh</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/etc/monit/scripts/cpu_temp.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">RET</span><span class="o">=</span><span class="sb">`</span>sensors <span class="nt">-Au</span> 2&gt; /dev/null | <span class="nb">sed</span> <span class="nt">-n</span> <span class="s1">'s/_input//p'</span> | <span class="nb">sed</span> <span class="s1">'s/.\+:\s\+\([0-9]\+\).\+/\1/'</span> | <span class="nb">sort</span> <span class="nt">-n</span> | <span class="nb">tail</span> <span class="nt">-1</span><span class="sb">`</span>
<span class="nb">exit</span> <span class="nv">$RET</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/etc/monit/scripts/cpu_temp.sh</pre>
</div>
</div>
<div class="paragraph">
<p>This script simply finds the maximum temperature reported by all temperature sensors and returns it as exit code.
If you using different hardware, you may need to modify this script.</p>
</div>
</div>
<div class="sect4">
<h5 id="_disk_temperature_script">Disk Temperature Script</h5>
<div class="paragraph">
<p>As <code>root</code> user, create disk temperature monitoring script <code>/usr/local/etc/monit/scripts/disk_temp.sh</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/etc/monit/scripts/disk_temp.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">UUID</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="nv">DEV</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> /dev/disk/by-uuid/<span class="s2">"</span><span class="nv">$UUID</span><span class="s2">"</span><span class="si">)</span>
<span class="nv">RET</span><span class="o">=</span><span class="sb">`</span>hddtemp <span class="nt">-n</span> SATA:<span class="s2">"</span><span class="nv">$DEV</span><span class="s2">"</span> 2&gt; /dev/null<span class="sb">`</span>
<span class="nb">exit</span> <span class="nv">$RET</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/etc/monit/scripts/disk_temp.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Similarly to previous script, this one also reads the temperature and returns it as the exit code.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For some SSDs (notably for Samsung EVO ones), the temperature data is returned in different smart field.
Some extra configuration may be required for <code>hddtemp</code> to read temperature data from such drives.
More details can be found in the Arch Wiki article on <code>hddtemp</code> <a href="#arch_wiki_hddtemp">[5]</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_ups_battery_charge_script">UPS Battery Charge Script</h5>
<div class="paragraph">
<p>As <code>root</code> user, create UPS battery monitoring script <code>/usr/local/etc/monit/scripts/ups_charge.sh</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/etc/monit/scripts/ups_charge.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">RET</span><span class="o">=</span><span class="sb">`</span>upsc eaton3s battery.charge 2&gt; /dev/null<span class="sb">`</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nb">exit</span> <span class="nv">$RET</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>eaton3s</code> with your UPS name, exactly as it was configured in NUT.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/etc/monit/scripts/ups_charge.sh</pre>
</div>
</div>
<div class="paragraph">
<p>This script simply returns UPS battery charge value (in percents) as the exit code.</p>
</div>
</div>
<div class="sect4">
<h5 id="basic_system_monitoring">Basic System Monitoring</h5>
<div class="paragraph">
<p>To configure basic system monitoring with Monit, as <code>root</code> user create <code>/etc/monit/conf.d/10-system</code> file
and set its permissions to 600, so that only <code>root</code> can read and edit it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo touch /etc/monit/conf.d/10-system
sudo chmod 600 /etc/monit/conf.d/10-system</pre>
</div>
</div>
<div class="paragraph">
<p>Below is a working example of what you can put in this file to establish basic system monitoring with Monit.
Read this file carefully, replace placeholders with the actual values and tweak the parameters as you need:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/10-system</div>
<div class="content">
<pre class="nowrap"># Log to syslog instead of monit.log
set log syslog

# Set global SSL options
set ssl {
    verify     : enable,
    selfsigned : reject
}

# Listen only locally
set httpd
    port {MONIT_PORT} <i class="conum" data-value="1"></i><b>(1)</b>
    use address 127.0.0.1
    allow localhost

# Email address to receive alerts. Ignore trivial alerts.
set alert {YOUR_EMAIL_ADDR} not on { instance, action } <i class="conum" data-value="2"></i><b>(2)</b>

# Set email format
set mail-format {
  from:    Monit &lt;monit@$HOST&gt;
  subject: $EVENT: $SERVICE
  message: $EVENT: $SERVICE
           Date:        $DATE
           Action:      $ACTION
           Host:        $HOST
           Description: $DESCRIPTION
}

# Set mail server
set mailserver {SMTP_SERVER_ADDR} port {SMTP_SERVER_PORT} <i class="conum" data-value="3"></i><b>(3)</b>
    using tls

# System performance
check system $HOST
    if loadavg (1min) &gt; 20 then alert
    if loadavg (5min) &gt; 10 then alert
    if loadavg (15min) &gt; 5 then alert
    if memory usage &gt; 70% for 5 cycles then alert
    if swap usage &gt; 5% then alert
    if cpu usage &gt; 70% for 5 cycles then alert

# Filesystem
check filesystem rootfs with path /
    if space usage &gt; 80% then alert
    if inode usage &gt; 70% then alert
    if read rate &gt; 2 MB/s for 10 cycles then alert
    if write rate &gt; 1 MB/s for 10 cycles then alert

# Network
check network wired with interface {NET_INTERFACE_NAME} <i class="conum" data-value="4"></i><b>(4)</b>
    if saturation &gt; 90% for 5 cycles then alert
    if total uploaded &gt; 10 GB in last day then alert
    if total downloaded &gt; 10 GB in last day then alert

# CPU Temperature
check program cpu_temp with path "/usr/local/etc/monit/scripts/cpu_temp.sh"
    if status &gt; 70 then alert
    if status &lt; 15 then alert

# Disk temperature
check program disk_temp with path "/usr/local/etc/monit/scripts/disk_temp.sh {PART_UUID}" <i class="conum" data-value="5"></i><b>(5)</b>
    if status &gt; 60 then alert
    if status &lt; 15 then alert

# UPS battery
check program ups_charge with path "/usr/local/etc/monit/scripts/ups_charge.sh"
    if status &lt; 95 then alert</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{MONIT_PORT}</code> with the port number on which you want Monit to listen for web interface connections.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{YOUR_EMAIL_ADDR}</code> with email address to which Monit will deliver notifications.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{SMTP_SERVER_ADDR}</code> and <code>{SMTP_SERVER_PORT}</code> with SMTP server address and port respectively.
Usually you can get relaying SMTP server address/port from your ISP.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>{NET_INTERFACE_NAME}</code> with your network interface name.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Replace <code>{PART_UUID}</code> with UUID of your <code>/boot</code> partition (can be copied from the <code>/etc/fstab</code> file).
This is needed in order not to rely on disk device names (e.g. <code>/dev/sda</code>) as they can change.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart Monit service for the changes to take effect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart monit</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You may notice that after running Monit,
the default Message of the Day complains about presence of the zombie processes.
At the moment of writing, when Monit invokes other programs (such as in <code>check program</code> instruction)
in creates zombie processes by design.
This zombie processes are handled correctly and don&#8217;t grow over time.
There is an open bug about this issue and hopefully it will be improved in the future releases of Monit.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_accessing_monit">4.1.3. Accessing Monit</h4>
<div class="paragraph">
<p>Monit can be accessed via command line or web interface.</p>
</div>
<div class="sect4">
<h5 id="_command_line_interface">Command Line Interface</h5>
<div class="paragraph">
<p>To see Monit information in command line try:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo monit status</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo monit summary</pre>
</div>
</div>
<div class="paragraph">
<p>Do <code>sudo monit -h</code> to see all available options.</p>
</div>
</div>
<div class="sect4">
<h5 id="_web_interface">Web Interface</h5>
<div class="paragraph">
<p>In this configuration, Monit only listens for local connections on <code>127.0.0.1:{MONIT_PORT}</code>.
This is done deliberately for security reasons.</p>
</div>
<div class="paragraph">
<p>One way to access Monit web interface from the outside is to do it through SSH tunnel.
For example, from the client PC establish a SSH tunnel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh {SERVER_USER}@{SERVER_IP_ADDR} -N -L 127.0.0.1:{LOCAL_PORT}:127.0.0.1:{MONIT_PORT}</pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>{LOCAL_PORT}</code> is port on which SSH will be listening on the client PC.
Web interface now can be accessed on the client pc at <code><a href="http://127.0.0.1:{LOCAL_PORT}" class="bare">http://127.0.0.1:{LOCAL_PORT}</a></code>.</p>
</div>
<div class="paragraph">
<p>To create this tunnel in more convenient way, you can add the following entry to your SSH config file <code>~/.ssh/config</code>:</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="nowrap">host silverbox-monit-ui-tunnel
    HostName {SERVER_IP_ADDR} <i class="conum" data-value="1"></i><b>(1)</b>
    IdentityFile ~/.ssh/silverbox-key
    LocalForward 127.0.0.1:{LOCAL_PORT} 127.0.0.1:{MONIT_PORT}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>IP can be replaced with the host name here after domain is configured.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now the tunnel can be established simply with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh -N silverbox-monit-ui-tunnel</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More convenient way of accessing Monit web interface and other internal services is described in the <a href="#reverse_proxy">Reverse Proxy</a> section.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_useful_references_2">4.1.4. Useful References</h4>
<div class="paragraph">
<p>Some useful sources of information about Monit:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Monit documentation: <a href="https://mmonit.com/monit/documentation/monit.html" class="bare">https://mmonit.com/monit/documentation/monit.html</a></p>
</li>
<li>
<p>Monit wiki: <a href="https://mmonit.com/wiki" class="bare">https://mmonit.com/wiki</a></p>
</li>
<li>
<p>Arch Wiki article on Monit: <a href="https://wiki.archlinux.org/index.php/Monit" class="bare">https://wiki.archlinux.org/index.php/Monit</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary_email">4.2. Summary Email</h3>
<div class="paragraph">
<p>The summary email is just an email that is delivered automatically at regular intervals (weekly) and contains
some system information.</p>
</div>
<div class="paragraph">
<p>While there are tools that do similar job (for example <em>logcheck</em> and <em>logwatch</em>),
I found them quite obsolete and noisy, with almost no documentation.</p>
</div>
<div class="sect3">
<h4 id="email_content_generation">4.2.1. Email Content Generation</h4>
<div class="paragraph">
<p>The email content is generated with a script, which is invoked by a Systemd timer.
Here is a working example of such script (modify it to suit your needs):</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/sbin/system-summary.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nv">PERIOD</span><span class="o">=</span><span class="s2">"week"</span>
<span class="k">else
    </span><span class="nv">PERIOD</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
<span class="k">fi

case</span> <span class="nv">$PERIOD</span> <span class="k">in
    </span>day <span class="p">|</span> week <span class="p">|</span> month<span class="p">)</span>
        <span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
        <span class="nb">echo</span> <span class="s2">"Unknown time period: </span><span class="nv">$PERIOD</span><span class="s2">. Defaulting to week."</span> 1&gt;&amp;2
        <span class="nv">PERIOD</span><span class="o">=</span><span class="s2">"week"</span>
        <span class="p">;;</span>
<span class="k">esac</span>

<span class="nv">SINCE_DATE</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> <span class="nt">--date</span><span class="o">=</span><span class="s2">"1 </span><span class="nv">$PERIOD</span><span class="s2"> ago"</span> +<span class="s2">"%F %T"</span><span class="sb">`</span>

<span class="nv">MAIN_DISK</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="s2">"/dev/disk/by-uuid/{PART_UUID}"</span><span class="si">)</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="nb">echo</span> <span class="s2">"Subject: System Summary Report (</span><span class="nv">$PERIOD</span><span class="s2">)"</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"Report Period:    </span><span class="nv">$PERIOD</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Report Generated: </span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Uptime:          </span><span class="si">$(</span><span class="nb">uptime</span><span class="si">)</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"Memory Usage:     RAM: </span><span class="si">$(</span>free <span class="nt">-m</span> | <span class="nb">grep </span>Mem | <span class="nb">awk</span> <span class="s1">'{print $3/$2 * 100}'</span><span class="si">)</span><span class="s2">%, Swap: </span><span class="si">$(</span>free <span class="nt">-m</span> | <span class="nb">grep </span>Swap | <span class="nb">awk</span> <span class="s1">'{print $3/$2 * 100}'</span><span class="si">)</span><span class="s2">%"</span>
<span class="nb">echo</span> <span class="s2">"Disk (main):      Temp: </span><span class="si">$(</span>hddtemp <span class="nt">-n</span> SATA:<span class="s2">"</span><span class="nv">$MAIN_DISK</span><span class="s2">"</span><span class="si">)</span><span class="s2">, Health: </span><span class="si">$(</span>smartctl <span class="nt">-H</span> <span class="s2">"</span><span class="nv">$MAIN_DISK</span><span class="s2">"</span> | <span class="nb">grep </span>overall-health | <span class="nb">sed</span> <span class="s1">'s/^.\+:\s\+//'</span><span class="si">)</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">df</span> <span class="nt">-h</span>

<span class="nb">echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Temperatures:"</span>
sensors <span class="nt">-A</span>

<span class="nb">echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Top CPU:"</span>
ps <span class="nt">-eo</span> pid,user,%cpu,%mem,cmd <span class="nt">--sort</span><span class="o">=</span>-%cpu | <span class="nb">head

echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Top RAM:"</span>
ps <span class="nt">-eo</span> pid,user,%cpu,%mem,cmd <span class="nt">--sort</span><span class="o">=</span>-%mem | <span class="nb">head

echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"SSH logins during this </span><span class="nv">$PERIOD</span><span class="s2">:"</span>
last <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$SINCE_DATE</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Last user logins:"</span>
lastlog | <span class="nb">grep</span> <span class="nt">-iv</span> <span class="s2">"Never logged in"</span>

<span class="nb">echo</span> <span class="s2">"--------------------------------------------------------------------------------"</span>
<span class="nb">echo</span> <span class="s2">"Logged errors:"</span>
journalctl <span class="nt">--since</span> <span class="s2">"</span><span class="nv">$SINCE_DATE</span><span class="s2">"</span> <span class="nt">-p</span> err <span class="nt">--no-pager</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{PART_UUID}</code> with UUID of your <code>/boot</code> partition (can be copied from the <code>/etc/fstab</code> file).</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When this script is called without arguments it will generate weekly summary.
It can also be called with an argument, such as: <code>day</code>, <code>week</code> or <code>month</code>, to generate summary for the specific period.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save this file as <code>/usr/local/sbin/system-summary.sh</code> and mark is as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/sbin/system-summary.sh</pre>
</div>
</div>
<div class="paragraph">
<p>To verify that it works do <code>sudo system-summary.sh</code> and check the output.</p>
</div>
</div>
<div class="sect3">
<h4 id="_email_delivery">4.2.2. Email Delivery</h4>
<div class="paragraph">
<p>To send emails the <code>ssmtp</code> program is used.
This is extremely lightweight tool with minimum dependencies, that sends mail to a configured mail server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since <code>ssmtp</code> is not an actual mail server (or MTA), you will need some SMTP server to send mail.
You can use one provided by your ISP or any of free ones; however, the security and privacy of such setup is
at best - questionable. This is why <code>ssmtp</code> only used in this guide for non-sensitive mail, such as monitoring
emails and system status emails.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To install <code>ssmtp</code> do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install ssmtp</pre>
</div>
</div>
<div class="paragraph">
<p>Edit the <code>/etc/ssmtp/ssmtp.conf</code> file, set <code>root</code> option to your desired email address,
<code>mailhub</code> to your SMTP server address and enable the use of TLS and STARTTLS:</p>
</div>
<div class="listingblock">
<div class="title">/etc/ssmtp/ssmtp.conf</div>
<div class="content">
<pre class="nowrap">root={YOUR_EMAIL_ADDR} <i class="conum" data-value="1"></i><b>(1)</b>

mailhub={SMTP_SERVER_ADDR}:{SMTP_SERVER_PORT} <i class="conum" data-value="2"></i><b>(2)</b>

UseTLS=Yes
UseSTARTTLS=Yes</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This email address will receive all mail for UIDs &lt; 1000.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set this to your SMTP server address and port.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are other parameters that may need to be configured (for example, if your SMTP server requires authentication).
The Arch Wiki article on <code>ssmtp</code> is a good source of information on this topic -
<a href="https://wiki.archlinux.org/index.php/SSMTP" class="bare">https://wiki.archlinux.org/index.php/SSMTP</a>.</p>
</div>
<div class="paragraph">
<p>To test that email delivery works try: <code>echo "test" | ssmtp root</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If this command is successful but email is not delivered, it was probably filtered.
You can run <code>ssmtp</code> with <code>-v</code> argument to get more verbose output, but I found no good solution to troubleshoot
filtering issues. Sometimes changing sender address, subject, content and hostname helps to avoid filtering.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As root user, create <code>/etc/systemd/system/system-summary-report.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/system-summary-report.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Email system summary report
After=network-online.target

[Service]
Type=oneshot
ExecStart=/bin/sh -c '/usr/local/sbin/system-summary.sh | ssmtp root'</pre>
</div>
</div>
<div class="paragraph">
<p>You can run this service manually and verify that you get the email:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl start system-summary-report.service</pre>
</div>
</div>
<div class="paragraph">
<p>As root user, create <code>/etc/systemd/system/system-summary-report.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/system-summary-report.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Email system summary report

[Timer]
OnCalendar=Fri 18:00 <i class="conum" data-value="1"></i><b>(1)</b>
AccuracySec=1h
Persistent=true

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Adjust this as needed, especially if using period other than week.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable system-summary-report.timer
sudo systemctl start system-summary-report.timer</pre>
</div>
</div>
<div class="paragraph">
<p>To check timer status and time until next activation use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl list-timers</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_login_notification">4.3. Login Notification</h3>
<div class="paragraph">
<p>If you want to get an email notification for each login to the server,
create the <code>/usr/local/sbin/login-notify.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/sbin/login-notify.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">TRUSTED_HOSTS</span><span class="o">=</span><span class="s2">""</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="o">[</span> <span class="s2">"</span><span class="nv">$PAM_TYPE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"open_session"</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit </span>0

<span class="k">for </span>i <span class="k">in</span> <span class="nv">$TRUSTED_HOSTS</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$i</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$PAM_RHOST</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">exit </span>0
    <span class="k">fi
done

</span><span class="nv">MSG</span><span class="o">=</span><span class="s2">"Subject: Login Notification</span><span class="se">\n\n\</span><span class="s2">
Date: </span><span class="sb">`</span><span class="nb">date</span><span class="sb">`</span><span class="se">\n\</span><span class="s2">
User: </span><span class="nv">$PAM_USER</span><span class="se">\n\</span><span class="s2">
Ruser: </span><span class="nv">$PAM_RUSER</span><span class="se">\n\</span><span class="s2">
Rhost: </span><span class="nv">$PAM_RHOST</span><span class="se">\n\</span><span class="s2">
Service: </span><span class="nv">$PAM_SERVICE</span><span class="se">\n\</span><span class="s2">
TTY: </span><span class="nv">$PAM_TTY</span><span class="se">\n</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"</span><span class="nv">$MSG</span><span class="s2">"</span> | ssmtp root</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>You can set <code>TRUSTED_HOSTS</code> variable to a space-delimited list of addresses
for logins from which you don&#8217;t want to generate notifications.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mark this file as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/sbin/login-notify.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Edit the <code>/etc/pam.d/common-session</code> file and append the following line to it:</p>
</div>
<div class="listingblock">
<div class="title">/etc/pam.d/common-session</div>
<div class="content">
<pre class="nowrap">session    optional     pam_exec.so /usr/local/sbin/login-notify.sh</pre>
</div>
</div>
<div class="paragraph">
<p>For some reason, the <code>common-session</code> file is not included in <code>/etc/pam.d/sudo</code>
(even though the relevant Debian bug was closed <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>).
So if you also want to get notifications for <code>sudo</code> command, you will need to append the same line
to the <code>/etc/pam.d/sudo</code> file as well.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="dns_server">5. DNS Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to install and configure a DNS server, which will serve clients on the local network.
Client devices in the LAN will use this DNS server as the default DNS server (can be announced by the DHCP server),
and the DNS server will forward queries securely (using DNS over TLS and DNSSEC) to the DNS server of your choice
(this configuration uses Cloudflare&#8217;s DNS server).</p>
</div>
<div class="sect2">
<h3 id="_installation_2">5.1. Installation</h3>
<div class="paragraph">
<p>Unbound <a href="#unbound">[6]</a> is used as the DNS server.</p>
</div>
<div class="paragraph">
<p>It can be installed directly from the repositories with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install unbound</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2">5.2. Configuration</h3>
<div class="paragraph">
<p>Ubuntu 18.04 uses <code>systemd-resolved</code> as the default DNS server.</p>
</div>
<div class="paragraph">
<p>To switch to Unbound, first <code>systemd-resolved</code> stub listener needs to be disabled.
To do this, first edit the <code>/etc/systemd/resolved.conf</code> file and set the following parameter:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/resolved.conf</div>
<div class="content">
<pre class="nowrap">DNSStubListener=no</pre>
</div>
</div>
<div class="paragraph">
<p>Then restart the <code>systemd-resolved</code> service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart systemd-resolved</pre>
</div>
</div>
<div class="paragraph">
<p>You can also verify that <code>systemd-resolved</code> is not listening on port 53 anymore by checking the output of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo netstat -lnptu</pre>
</div>
</div>
<div class="paragraph">
<p>To configure Unbound as a simple forwarding DNS server create the <code>/etc/unbound/unbound.conf.d/dns-config.conf</code> file
with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/unbound/unbound.conf.d/dns-config.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">server</span><span class="pi">:</span>
  <span class="na">interface</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
  <span class="na">outgoing-interface</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">SERVER_IP_ADDR</span><span class="pi">}</span> <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="na">access-control</span><span class="pi">:</span> <span class="s">127.0.0.0/8 allow</span>
  <span class="na">access-control</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">SERVER_SUBNET</span><span class="pi">}</span> <span class="s">allow</span> <i class="conum" data-value="2"></i><b>(2)</b>
  <span class="na">do-ip4</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">do-ip6</span><span class="pi">:</span> <span class="s">no</span>
  <span class="na">do-udp</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">do-tcp</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">minimal-responses</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">prefetch</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">qname-minimisation</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hide-identity</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">hide-version</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">use-caps-for-id</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">private-address</span><span class="pi">:</span> <span class="s">192.168.0.0/16</span>
  <span class="na">private-address</span><span class="pi">:</span> <span class="s">172.16.0.0/12</span>
  <span class="na">private-address</span><span class="pi">:</span> <span class="s">10.0.0.0/8</span>
  <span class="na">unwanted-reply-threshold</span><span class="pi">:</span> <span class="m">10000</span>
  <span class="na">root-hints</span><span class="pi">:</span> <span class="s">/usr/share/dns/root.hints</span>
<span class="na">forward-zone</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">."</span>
<span class="c1">#  tls-cert-bundle: /etc/ssl/certs/ca-certificates.crt </span><i class="conum" data-value="3"></i><b>(3)</b>
  <span class="na">forward-ssl-upstream</span><span class="pi">:</span> <span class="s">yes</span>
  <span class="na">forward-addr</span><span class="pi">:</span> <span class="s">1.1.1.1@853#one.one.one.one</span> <i class="conum" data-value="4"></i><b>(4)</b>
  <span class="na">forward-addr</span><span class="pi">:</span> <span class="s">1.0.0.1@853#one.one.one.one</span> <i class="conum" data-value="5"></i><b>(5)</b>
<span class="na">remote-control</span><span class="pi">:</span>
  <span class="na">control-interface</span><span class="pi">:</span> <span class="s">127.0.0.1</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace this with your server address.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace this with your LAN subnet.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This line is commented because Unbound 1.6.7 (default Ubuntu 18.04 version at the moment of writing)
does not support this parameter.
Without it there is no validation, however, the queries are still encrypted.
Uncomment this line once Ubuntu gets newer version of Unbound.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Primary DNS server address.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Secondary DNS server address.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This configuration uses Cloudflare&#8217;s DNS servers <a href="#cloudflare_dns">[7]</a>, due to their reasonable privacy policy and support for
DNS over TLS and DNSSEC. Feel free to replace with DNS server of your choice.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is also possible to make Unbound to block DNS requests to certain known advertisement/analytics addresses
(similarly to what Pi-hole does) but this is outside of the scope of this document.
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The configuration above is for Unbound 1.6.7. Some parameters were added/modified in more recent version,
so this config may need to be updated once Ubuntu package is upgraded to more recent version.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The tls-cert-bundle because Unbound 1.6.7 (default Ubuntu 18.04 version at this moment) does not support this paremeter yet.
Without it there won&#8217;t be any authentication, but the queries still are encrypted.
Uncomment this line once Ubuntu gets newer version of Unbound.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, remove the <code>/etc/resolv.conf</code> file (which is a link to SystemD resolver&#8217;s file):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo rm /etc/resolv.conf</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>systemd-resolved</code> should detect it automatically and stop generating <code>resolv.conf</code> contents.</p>
</div>
<div class="paragraph">
<p>Now you can create a new <code>/etc/resolv.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">nameserver 127.0.0.1
nameserver {SERVER_IP_ADDR} <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{SERVER_IP_ADDR}</code> with the actual server IP address.
While it doesn&#8217;t make sense to have this line together with <code>127.0.0.1</code>, it is needed for the Docker&#8217;s embedded
DNS to work properly.
At the moment of writing, Docker incorrectly filters out all localhost records from the <code>resolv.conf</code>,
so this record is necessary to force it to use host&#8217;s DNS server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart the <code>systemd-resolved</code> and <code>unbound</code> services:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart systemd-resolved
sudo systemctl restart unbound</pre>
</div>
</div>
<div class="paragraph">
<p>Check that the DNS resolution is working on the server.</p>
</div>
<div class="paragraph">
<p>To verify that DNSSEC is working you can check the output of the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">dig weberdns.de
<em>...</em>
<em>;; flags: qr rd ra <strong>ad</strong>; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1</em>
<em>...</em></pre>
</div>
</div>
<div class="paragraph">
<p>And verify that response has an <code>ad</code> flag present.</p>
</div>
<div class="paragraph">
<p>To also verify that DNS queries are now encrypted check the output of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo tcpdump -vv -x -X -s 1500 -i {NETWORK_INTERFACE} 'port 853'</pre>
</div>
</div>
<div class="paragraph">
<p>While doing any DNS query.</p>
</div>
<div class="sect3">
<h4 id="_adding_firewall_rule">5.2.1. Adding Firewall Rule</h4>
<div class="paragraph">
<p>To allow incoming DNS requests from the LAN do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw allow proto tcp from {SERVER_SUBNET} to any port 53 comment "DNS TCP"
sudo ufw allow proto udp from {SERVER_SUBNET} to any port 53 comment "DNS UDP"</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_updating_dhcp_server_configuration">5.3. Updating DHCP Server Configuration</h3>
<div class="paragraph">
<p>Now you can change your router&#8217;s DHCP settings and set your server address as your DNS server.
Thus all devices on the LAN will switch to using this DNS server automatically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_2">5.4. Monitoring</h3>
<div class="paragraph">
<p>The DNS server will be monitored with Monit, which should by now be configured.</p>
</div>
<div class="paragraph">
<p>Create the <code>/etc/monit/conf.d/30-unbound</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">check process unbound with pidfile /var/run/unbound.pid
  if does not exist then alert
  if cpu &gt; 10% for 5 cycles then alert
  if total memory &gt; 200.0 MB for 5 cycles then alert
  if failed port 53 type udp protocol dns then alert
  if failed port 53 type tcp protocol dns then alert

check program unbound_stats with path "/usr/sbin/unbound-control stats" every 5 cycles
  if status != 0 then alert</pre>
</div>
</div>
<div class="paragraph">
<p>This will make Monit to check that Unbound process is running and DNS server is accessible over TCP and UDP
and not consuming suspicious amounts of CPU and RAM.
In addition to that, it will grab the Unbound stats every 5 cycles
(which is 5 minutes, if you set cycle duration to a minute).
The Unbound stats are cleared each time <code>stats</code> command is executed, so in this case Monit will essentially
show the stats for the last 5 minutes.</p>
</div>
<div class="paragraph">
<p>Restart the Monit service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart monit</pre>
</div>
</div>
<div class="paragraph">
<p>Check Monit web interface and make sure that DNS monitoring is working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="docker">6. Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to setup Docker CE engine and Docker Compose.
Docker will be required to run some workloads (such as Nextcloud, or Transmission) inside containers.</p>
</div>
<div class="sect2">
<h3 id="_installation_3">6.1. Installation</h3>
<div class="sect3">
<h4 id="_docker_ce">6.1.1. Docker CE</h4>
<div class="paragraph">
<p>To install Docker CE engine follow the instructions from the docker documentation:
<a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-docker-ce" class="bare">https://docs.docker.com/install/linux/docker-ce/ubuntu/#install-docker-ce</a>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
For security reasons, it may be good idea not to add your user to the <code>docker</code> group.
Membership in the <code>docker</code> group essentially grants user the <code>root</code> permissions, without requiring to enter
password for privilege elevation (unlike <code>sudo</code>).
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="docker_compose_install">6.1.2. Docker Compose</h4>
<div class="paragraph">
<p>Docker Compose <a href="#docker_compose">[8]</a> is a useful tool for deploying and managing multi-container workloads.</p>
</div>
<div class="paragraph">
<p>At the moment of writing, the preferred method of installation for Ubuntu was simply grabbing
the latest binary from the GitHub releases page.
The downside is that there won&#8217;t be any automatic upgrades and newer versions of Docker Compose will
have to be installed manually.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This guide has been updated to use Docker Compose v2
(complete rewrite of the Docker Compose in Golang).
If you have older Docker Compose version, make sure you remove it and install the version 2.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To find the latest Docker Compose version number, visit the GitHub releases page at:
<a href="https://github.com/docker/compose/releases" class="bare">https://github.com/docker/compose/releases</a>.</p>
</div>
<div class="paragraph">
<p>Next, download the <code>docker-compose</code> binary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo curl -L "https://github.com/docker/compose/releases/download/{COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/libexec/docker/cli-plugins/docker-compose <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{COMPOSE_VERSION}</code> with the actual latest Docker Compose version.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod +x /usr/libexec/docker/cli-plugins/docker-compose</pre>
</div>
</div>
<div class="paragraph">
<p>Verify that Docker Compose works by doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">docker compose version</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you see an error similar to this:
<code>error while loading shared libraries: libz.so.1: failed to map segment from shared object</code>
then remove <code>noexec</code> option from the <code>/tmp</code> partition.
See <a href="#mounting_tmp_as_tmpfs">Mounting /tmp as tmpfs</a> for more details.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_3">6.2. Monitoring</h3>
<div class="paragraph">
<p>To setup basic monitoring of the Docker daemon with Monit,
create the <code>/etc/monit/conf.d/20-docker</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/20-docker</div>
<div class="content">
<pre class="nowrap">check process docker with pidfile /var/run/docker.pid
  if does not exist then alert
  if cpu &gt; 30% for 10 cycles then alert
  if total memory &gt; 300.0 MB for 5 cycles then alert</pre>
</div>
</div>
<div class="paragraph">
<p>Restart Monit service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart monit</pre>
</div>
</div>
<div class="paragraph">
<p>Check Monit web interface and verify that Docker monitoring is working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="socks5_over_vpn">7. SOCKS5 Over VPN</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to setup a SOCKS5 proxy on the server,
such that it will redirect all traffic through the VPN connection.</p>
</div>
<div class="paragraph">
<p>The reason it may be useful (as opposed to just running everything over VPN connection on the client PC)
is to allow more granular control over what application&#8217;s traffic goes through VPN connection.
For example, one may choose to direct all web browser traffic over a VPN connection,
while Steam and music streaming apps will access the internet directly.</p>
</div>
<div class="paragraph">
<p>The way it is achieved is by running an OpenVPN client inside a docker container together with SOCKS5 server
in such a way that traffic received by the SOCKS5 server will be forwarded via the VPN tunnel and vice versa.</p>
</div>
<div class="paragraph">
<p>Since SOCKS5 protocol offers very weak authentication and no encryption,
it will be additionally encapsulated in SSH tunnel.</p>
</div>
<div class="paragraph">
<p>Below is a diagram that demonstrates the idea:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap"> Client PC
 -----------------
|                 |                                 Silverbox Server
|  -------------  |                                 ------------------------------
| | Application | |                                |                              |
|  -------------  |                                |    Container                 |
|        | SOCKS5 |                                |    ------------------------  |
|        v        |     /--------------------\     |   |                        | |
|  127.0.0.1:XXXX ------      SSH Tunnel      -----------SOCKS5 Server          | | Internet
 -----------------      \--------------------/     |   |      |          --&lt;VPN&gt;--------&gt;
                                                   |   |      \ routing /       | |
                                                   |   |        -------         | |
                                                   |    ------------------------  |
                                                    ------------------------------</pre>
</div>
</div>
<div class="paragraph">
<p>The prerequisites to this section are having Docker installed
and having a VPN provider that supports OpenVPN and can provide OpenVPN profiles
(or information on how to create them).</p>
</div>
<div class="sect2">
<h3 id="_image">7.1. Image</h3>
<div class="paragraph">
<p>This section describes how to prepare and build Docker image for the VPN proxy.</p>
</div>
<div class="sect3">
<h4 id="_preparing_openvpn_profiles_and_credentials">7.1.1. Preparing OpenVPN Profiles and Credentials</h4>
<div class="paragraph">
<p>The container will need access to the OpenVPN profiles and your VPN credentials, to establish the VPN connection.
These files will be stored on disk and mounted inside the container as volumes.</p>
</div>
<div class="paragraph">
<p>First, create a directory named <code>silverbox</code> (or choose a different name if you like) under the <code>root</code> user&#8217;s home,
and set permissions so that only <code>root</code> user can effectively use it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox
sudo chmod 700 /root/silverbox</pre>
</div>
</div>
<div class="paragraph">
<p>This directory will be used to hold files that need to be persistently stored on the server,
but contain sensitive data.
It is not just for his VPN proxy container, but for other services provided by the server as well.</p>
</div>
<div class="paragraph">
<p>Next, create a <code>vpn</code> directory, which will hold files related to the VPN connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/vpn
sudo chmod 700 /root/silverbox/vpn</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create <code>auth</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/vpn/auth
sudo chmod 700 /root/silverbox/vpn/auth</pre>
</div>
</div>
<div class="paragraph">
<p>Inside the <code>auth</code> directory create a <code>credentials</code> file, containing two lines:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First line is the VPN username</p>
</li>
<li>
<p>Second line is the VPN password</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Set the following permissions on this file (marks file as read only and only readable by <code>root</code>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 400 /root/silverbox/vpn/auth/credentials</pre>
</div>
</div>
<div class="paragraph">
<p>Next, create a <code>proxy</code> directory under the <code>vpn</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/vpn/proxy
sudo chmod 700 /root/silverbox/vpn/proxy</pre>
</div>
</div>
<div class="paragraph">
<p>And copy all OpenVPN profile files (<code>*.ovpn</code>) that you want to use for SOCKS5 over VPN proxy into it
(you can have multiple files as exit point rotation will be configured).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At any time, if you want only to use specific profile, create a symlink named <code>profile</code> pointing to desired
profile. For example <code>ln -s SOME_PROFILE.ovpn profile</code>.
Make sure the link is relative and not absolute: otherwise it won&#8217;t work inside the container.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_creating_docker_network">7.1.2. Creating Docker Network</h4>
<div class="paragraph">
<p>Using separate Docker network to run VPN-related workloads offers some convenience, isolation,
and also will force Docker to use embedded DNS server which will forward all DNS queries to the host DNS server.</p>
</div>
<div class="paragraph">
<p>To create Docker bridge network named <code>vpn</code> do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker network create --driver=bridge --subnet={DOCKER_VPN_NETWORK} vpn <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{DOCKER_VPN_NETWORK}</code> with the some subnet for the Docker VPN network. For example: <code>172.18.0.0/24</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_image_files">7.1.3. Preparing Image Files</h4>
<div class="paragraph">
<p>First, create a directory named <code>containers</code> under the <code>/root/silverbox</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers
sudo chmod 700 /root/silverbox/containers</pre>
</div>
</div>
<div class="paragraph">
<p>This directory will contain everything required to build different images for Docker containers
(for VPN proxy and other containers).</p>
</div>
<div class="paragraph">
<p>Inside it, create a directory for the VPN proxy container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/vpn-proxy
sudo chmod 700 /root/silverbox/containers/vpn-proxy</pre>
</div>
</div>
<div class="paragraph">
<p>Create a directory where the VPN proxy container will store its host identity SSH key,
so that it will be persistent between the container upgrades.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/vpn-proxy/host-key
sudo chmod 700 /root/silverbox/containers/vpn-proxy/host-key</pre>
</div>
</div>
<div class="paragraph">
<p>Inside the <code>vpn-proxy</code> directory, create a file named <code>docker-compose.yaml</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/vpn-proxy/docker-compose.yaml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">vpn</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">vpn-proxy</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">vpn-proxy</span>
    <span class="na">init</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">/root/silverbox/containers/vpn-proxy</span>
      <span class="na">network</span><span class="pi">:</span> <span class="s">vpn</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11.3-slim'</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:15</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">{</span><span class="nv">SERVER_IP_ADDR</span><span class="pi">}</span><span class="s">:{VPN_PROXY_PORT}:{VPN_PROXY_PORT}/tcp</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">default</span><span class="pi">:</span>
        <span class="na">ipv4_address</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">VPN_PROXY_ADDR</span><span class="pi">}</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="na">devices</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/dev/net/tun</span>
    <span class="na">cap_add</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">NET_ADMIN</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/root/silverbox/vpn/proxy:/vpn-profiles</span>
      <span class="pi">-</span> <span class="s">/root/silverbox/vpn/auth:/vpn-credentials</span>
      <span class="pi">-</span> <span class="s">/root/silverbox/containers/vpn-proxy/host-key:/ssh-host-key</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>11.3-slim</code> with the actual latest <code>debian</code> image version (can be checked at the Docker Hub).
Don&#8217;t use <code>latest</code> here as it makes setup non-deterministic and makes it harder to maintain and upgrade.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{SERVER_IP_ADDR}</code> and <code>{VPN_PROXY_PORT}</code> with the actual values.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{VPN_PROXY_ADDR}</code> with desired VPN proxy container address.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create a file named <code>Dockerfile</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/vpn-proxy/Dockerfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="dockerfile"><span class="k">ARG</span><span class="s"> version=latest</span>

<span class="k">FROM</span><span class="s"> debian:$version</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> bash iputils-ping iptables openvpn openssh-server <span class="o">&amp;&amp;</span> <span class="se">\
</span>    addgroup <span class="nt">--system</span> vpn <span class="o">&amp;&amp;</span> <span class="se">\
</span>    adduser proxytunnel <span class="nt">--disabled-password</span> <span class="nt">--gecos</span> <span class="s2">""</span> <span class="nt">--shell</span> /usr/sbin/nologin <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mkdir</span> /var/run/sshd

<span class="k">COPY</span><span class="s"> docker-entrypoint.sh /usr/local/bin/</span>
<span class="k">COPY</span><span class="s"> sshd_config /etc/ssh/</span>
<span class="k">COPY</span><span class="s"> --chown=proxytunnel:proxytunnel proxy_tunnel.pub /home/proxytunnel</span>

<span class="k">HEALTHCHECK</span><span class="s"> --interval=120s --timeout=20s --start-period=120s CMD ping 1.1.1.1 -c 1 </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="k">VOLUME</span><span class="s"> ["/vpn-profiles", "/vpn-credentials"]</span>

<span class="k">EXPOSE</span><span class="s"> {VPN_PROXY_PORT}/tcp </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="k">ENTRYPOINT</span><span class="s"> [ "/usr/local/bin/docker-entrypoint.sh" ]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Feel free to customize health check command.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{VPN_PROXY_PORT}</code> with some port number of your choice (e.g. 12345).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create a <code>sshd_config</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/vpn-proxy/sshd_config</div>
<div class="content">
<pre class="nowrap">Protocol 2

HostKey /etc/ssh/ssh_host_ed25519_key

KexAlgorithms curve25519-sha256@libssh.org
Ciphers aes128-gcm@openssh.com <i class="conum" data-value="1"></i><b>(1)</b>
MACs hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com

AddressFamily inet
ListenAddress {VPN_PROXY_ADDR}:{VPN_PROXY_PORT} <i class="conum" data-value="2"></i><b>(2)</b>

LogLevel ERROR
LoginGraceTime 1m
PermitRootLogin no
MaxAuthTries 4
MaxSessions 5
AuthenticationMethods publickey
PubkeyAuthentication yes
HostbasedAuthentication no
IgnoreRhosts yes
PasswordAuthentication no
PermitEmptyPasswords no
ChallengeResponseAuthentication no
X11Forwarding no
Banner none
AllowAgentForwarding no
AllowTcpForwarding yes
PermitTTY no

AllowUsers proxytunnel
AuthorizedKeysFile /home/proxytunnel/proxy_tunnel.pub</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This cipher was chosen after testing performance of different ciphers on the given hardware.
It offers reasonable performance while maintaining decent security.
Feel free to change the cipher if you need to.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{VPN_PROXY_ADDR}:{VPN_PROXY_PORT}</code> with some IP address from the <code>{DOCKER_VPN_NETWORK}</code>
and the <code>{VPN_PROXY_PORT}</code> port number.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create a <code>docker-entrypoint.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/vpn-proxy/docker-entrypoint.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="k">function </span>configure_iptables<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">set</span> <span class="nt">-e</span>

    <span class="nb">local </span><span class="nv">config_file</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
    <span class="nb">local </span><span class="nv">host</span><span class="o">=</span><span class="si">$(</span><span class="nb">awk</span> <span class="s1">'/^remote / {print $2}'</span> <span class="s2">"</span><span class="nv">$config_file</span><span class="s2">"</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="si">$(</span><span class="nb">awk</span> <span class="s1">'/^remote / &amp;&amp; NF ~ /^[0-9]*$/ {print $NF}'</span> <span class="s2">"</span><span class="nv">$config_file</span><span class="s2">"</span><span class="si">)</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"-- No port number specified in the VPN profile file"</span>
        <span class="nb">exit </span>1
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"-- Setting up firewall rules for VPN server </span><span class="nv">$host</span><span class="s2"> on port </span><span class="nv">$port</span><span class="s2">"</span>
    <span class="k">fi

    </span>iptables <span class="nt">--flush</span>
    iptables <span class="nt">--delete-chain</span>

    iptables <span class="nt">--policy</span> INPUT DROP
    iptables <span class="nt">--policy</span> OUTPUT DROP
    iptables <span class="nt">--policy</span> FORWARD DROP

    iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> lo <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> INPUT <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
<i class="conum" data-value="1"></i><b>(1)</b>
    iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> <span class="o">{</span>VPN_PROXY_PORT<span class="o">}</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> NEW <span class="nt">-m</span> recent <span class="nt">--set</span> <span class="nt">--name</span> SSH <span class="nt">--mask</span> 255.255.255.255 <span class="nt">--rsource</span>
    iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> <span class="o">{</span>VPN_PROXY_PORT<span class="o">}</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> NEW <span class="nt">-m</span> recent <span class="nt">--update</span> <span class="nt">--seconds</span> 30 <span class="nt">--hitcount</span> 6 <span class="nt">--name</span> SSH <span class="nt">--mask</span> 255.255.255.255 <span class="nt">--rsource</span> <span class="nt">-j</span> DROP
    iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> tcp <span class="nt">--dport</span> <span class="o">{</span>VPN_PROXY_PORT<span class="o">}</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> NEW <span class="nt">-j</span> ACCEPT

    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> lo <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> tun0 <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> eth0 <span class="nt">-d</span> <span class="o">{</span>SERVER_SUBNET<span class="o">}</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT <i class="conum" data-value="2"></i><b>(2)</b>
    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> eth0 <span class="nt">-p</span> tcp <span class="nt">-d</span> <span class="nv">$host</span> <span class="nt">--dport</span> <span class="nv">$port</span> <span class="nt">-m</span> owner <span class="nt">--gid-owner</span> vpn <span class="nt">-j</span> ACCEPT

    <span class="nb">set</span> +e
<span class="o">}</span>

<span class="k">function </span>run_sshd<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">set</span> <span class="nt">-e</span>

    <span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"/etc/ssh/ssh_host_ed25519_key"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"/ssh-host-key/ssh_host_ed25519_key"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
          </span><span class="nb">echo</span> <span class="s2">"-- Generating host key"</span>
          ssh-keygen <span class="nt">-f</span> /etc/ssh/ssh_host_ed25519_key <span class="nt">-N</span> <span class="s1">''</span> <span class="nt">-t</span> ed25519
          <span class="nb">cp</span> /etc/ssh/ssh_host_ed25519_key /ssh-host-key/ssh_host_ed25519_key
        <span class="k">else
          </span><span class="nb">cp</span> /ssh-host-key/ssh_host_ed25519_key /etc/ssh/ssh_host_ed25519_key
        <span class="k">fi
    fi

    </span><span class="nb">echo</span> <span class="s2">"-- Adding route back to LAN"</span>
    ip route add <span class="o">{</span>SERVER_SUBNET<span class="o">}</span> via <span class="o">{</span>DOCKER_VPN_NETWORK_GW<span class="o">}</span> <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="nb">echo</span> <span class="s2">"-- Starting SSH server"</span>
    /usr/sbin/sshd

    <span class="nb">set</span> +e
<span class="o">}</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span><span class="nt">-ge</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exec</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
<span class="k">else
    if</span> <span class="o">[</span> <span class="nt">-f</span> /vpn-profiles/profile <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"-- Profile file found: only it will be used"</span>
        <span class="nv">PROFILE_FILE</span><span class="o">=</span><span class="s2">"/vpn-profiles/profile"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"-- Profile file not found: random profile file will be picked"</span>
        <span class="nv">PROFILE_FILE</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">ls</span> <span class="nt">-1</span> /vpn-profiles/<span class="k">*</span>.ovpn | <span class="nb">shuf</span> <span class="nt">-n</span> 1<span class="si">)</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"-- Selected profile file: </span><span class="nv">$PROFILE_FILE</span><span class="s2">"</span>
    <span class="k">fi

    </span>configure_iptables <span class="s2">"</span><span class="nv">$PROFILE_FILE</span><span class="s2">"</span>
    run_sshd

    <span class="nb">exec </span>sg vpn <span class="nt">-c</span> <span class="s2">"openvpn --config </span><span class="nv">$PROFILE_FILE</span><span class="s2"> --verb 1 --auth-user-pass /vpn-credentials/credentials --auth-nocache"</span>
<span class="k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This block establishes rate limiting for incoming SSH connections.
Replace <code>{VPN_PROXY_PORT}</code> with the actual port number in it.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{SERVER_SUBNET}</code> with your LAN subnet.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{SERVER_SUBNET}</code> with your LAN subnet.
Also, replace <code>{DOCKER_VPN_NETWORK_GW}</code> with the default gateway for your <code>{DOCKER_VPN_NETWORK}</code>
(ends with 1, i.e. for network 172.18.0.0/12 it will be 172.18.0.1).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mark <code>docker-entrypoint.sh</code> as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod a+x docker-entrypoint.sh</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_generating_client_ssh_key">7.1.4. Generating Client SSH Key</h4>
<div class="paragraph">
<p>This section describes how to generate client SSH key that will be used to authenticate to the
SSH server that is running inside the container.</p>
</div>
<div class="paragraph">
<p>On the client PC (from which you will connect to the proxy) generate a new SSH key with the following command
(don&#8217;t use any passphrase, as the tunnel will be established automatically):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh-keygen -t ed25519 -f ~/.ssh/silverbox-proxy-tunnel -C "Silverbox proxy tunnel key"</pre>
</div>
</div>
<div class="paragraph">
<p>Copy public key to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">scp ~/.ssh/silverbox-proxy-tunnel.pub $USER@{SERVER_IP_ADDR}:proxy_tunnel.pub</pre>
</div>
</div>
<div class="paragraph">
<p>Move this file under the <code>/root/silverbox/containers/vpn-proxy</code> directory and make it only readable by the root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chown root:root proxy_tunnel.pub
sudo chmod 400 proxy_tunnel.pub</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_container">7.2. Container</h3>
<div class="paragraph">
<p>This section describes how to run the VPN proxy container.</p>
</div>
<div class="sect3">
<h4 id="_running_container">7.2.1. Running Container</h4>
<div class="paragraph">
<p>To build the image and run the container do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/vpn-proxy/docker-compose.yaml up -d</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When you run container that exposes some ports to the host interface,
by default Docker will automatically add netfilter rules to allow forwarding for these ports.
That&#8217;s why there&#8217;s no need to add UFW rule for the proxy tunnel.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When started this way, container will be automatically restarted in case of failure (up to 15 consecutive restarts).</p>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_container_startup">7.2.2. Automatic Container Startup</h4>
<div class="paragraph">
<p>To start container automatically on boot create the <code>/etc/systemd/system/vpn-proxy-start.service</code> file
with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/vpn-proxy-start.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Start VPN proxy container
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker start vpn-proxy

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
<div class="paragraph">
<p>Enable the service, so that it will be started on system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable vpn-proxy-start.service</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_vpn_server_rotation">7.2.3. Automatic VPN Server Rotation</h4>
<div class="paragraph">
<p>The idea of VPN server rotation is to restart VPN proxy container periodically,
so that every time it starts it will pick up new random VPN profile and thus switch to a new VPN server.
This may be useful for privacy and security reasons, however, this step is optional.</p>
</div>
<div class="paragraph">
<p>The rotation is achieved by creating a simple Systemd timer, that, when triggered, will restart VPN proxy container.</p>
</div>
<div class="paragraph">
<p>Create the <code>/etc/systemd/system/vpn-proxy-restart.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/vpn-proxy-restart.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Restart VPN proxy container
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker restart vpn-proxy</pre>
</div>
</div>
<div class="paragraph">
<p>You can run the service once to verify that it works and restarts the container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl start vpn-proxy-restart.service</pre>
</div>
</div>
<div class="paragraph">
<p>Netx, create the <code>/etc/systemd/system/vpn-proxy-restart.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/vpn-proxy-restart.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Restart VPN proxy container

[Timer]
OnCalendar=*-*-* 01:00:00
AccuracySec=1h
Persistent=true

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="paragraph">
<p>In this configuration, the timer will be activated every day at 1am.</p>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable vpn-proxy-restart.timer
sudo systemctl start vpn-proxy-restart.timer</pre>
</div>
</div>
<div class="paragraph">
<p>You can do <code>systemctl list-timers</code> to verify that the timer appears in the output
and to check the time till next activation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_4">7.3. Monitoring</h3>
<div class="paragraph">
<p>The status of the VPN proxy container is monitored by Monit.</p>
</div>
<div class="paragraph">
<p>First, create the <code>/usr/local/etc/monit/scripts/container_status.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/etc/monit/scripts/container_status.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>
<span class="nv">STATUS</span><span class="o">=</span><span class="si">$(</span>docker inspect <span class="nt">--format</span><span class="o">=</span><span class="s2">"{{</span><span class="nv">$2</span><span class="s2">}}. Started: {{.State.StartedAt}}. Restarts: {{.RestartCount}}."</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="si">)</span>
<span class="nb">echo</span> <span class="nv">$STATUS</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$STATUS</span><span class="s2">"</span> <span class="k">in</span>
  <span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span><span class="k">*</span><span class="p">)</span> <span class="nb">exit </span>0 <span class="p">;;</span>
  <span class="k">*</span><span class="p">)</span> <span class="nb">exit </span>1 <span class="p">;;</span>
<span class="k">esac</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/etc/monit/scripts/container_status.sh</pre>
</div>
</div>
<div class="paragraph">
<p>This script checks given Docker container status field and compares it against desired value.</p>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/monit/conf.d/40-docker-vpn-proxy</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/40-docker-vpn-proxy</div>
<div class="content">
<pre class="nowrap">check program vpn_proxy with path "/usr/local/etc/monit/scripts/container_status.sh vpn-proxy .State.Health.Status healthy"
  if status != 0 for 10 cycles then alert</pre>
</div>
</div>
<div class="paragraph">
<p>Restart Monit service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart monit</pre>
</div>
</div>
<div class="paragraph">
<p>Check Monit web interface and make sure that VPN proxy monitoring is working.</p>
</div>
</div>
<div class="sect2">
<h3 id="_client_configuration">7.4. Client Configuration</h3>
<div class="paragraph">
<p>On the client PC, create an entry in the <code>~/.ssh/config</code> file (to simplify tunnel creation):</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="nowrap">host silverbox-proxy-tunnel
  HostName {SERVER_IP_ADDR} <i class="conum" data-value="1"></i><b>(1)</b>
  Port {VPN_PROXY_PORT} <i class="conum" data-value="2"></i><b>(2)</b>
  User proxytunnel
  IdentityFile ~/.ssh/silverbox-proxy-tunnel
  DynamicForward 127.0.0.1:{VPN_PROXY_PORT} <i class="conum" data-value="3"></i><b>(3)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace with your server address.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace with the VPN proxy port number.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace with the VPN proxy port number.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Establish the tunnel manually for testing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh -N silverbox-proxy-tunnel</pre>
</div>
</div>
<div class="paragraph">
<p>To verify that proxy works over VPN, you can run the following commands and verify that returned IPs are different:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">curl -v -x socks5://127.0.0.1:{VPN_PROXY_PORT} http://api.ipify.org?format=json
curl -v http://api.ipify.org?format=json</pre>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_tunnel_creation">7.4.1. Automatic Tunnel Creation</h4>
<div class="paragraph">
<p>This section describes how to establish tunnel automatically on user login into the Gnome session on Ubuntu 18.04.</p>
</div>
<div class="paragraph">
<p>Create a script <code>vpn-proxy-tunnel.sh</code> somewhere with the following content:</p>
</div>
<div class="listingblock">
<div class="title">vpn-proxy-tunnel.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
    </span>ssh <span class="nt">-N</span> silverbox-proxy-tunnel &amp;&gt;/dev/null
    notify-send <span class="nt">--urgency</span><span class="o">=</span>normal <span class="nt">-i</span> error <span class="s2">"VPN proxy tunnel disconnected. Retrying in 20 seconds."</span>
    <span class="nb">sleep </span>20s
<span class="k">done</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">chmod a+x vpn-proxy-tunnel.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Add this script to your client PC auto start.
On Ubuntu 18.04 it can be added using the &#8220;Startup Applications&#8221; GUI tool.</p>
</div>
<div class="paragraph">
<p>Reboot the client PC and verify that script is running and tunnel works.</p>
</div>
<div class="paragraph">
<p>Now for all applications that you wish to use VPN (for example web browser),
you can configure use of SOCKS5 proxy server <code>127.0.0.1:{VPN_PROXY_PORT}</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domain_name">8. Domain Name</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having own domain name can be useful for a variety of reasons.
In this guide, it is used for the following purposes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>To configure proper domain for Kerberos (instead of doing domain hijacking).</p>
</li>
<li>
<p>To access the server from the outside (from the internet) without having a static IP address.</p>
</li>
<li>
<p>To obtain certificates for Nextcloud (to use HTTPS) or other services.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A domain name needs to be registered in order to proceed with this section of the document.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Domain name registration and payment process may take a few days, so it is better to start it in advance.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The main requirement to the domain name registrar is to provide an API that allows changing DNS records
(at least host A and TXT records).
After evaluating a few options, NameSilo <a href="#name_silo">[9]</a> was chosen as the domain name registrar,
so this document provides DNS records update script for its API.
If you decide to use different domain name registrar, you&#8217;ll have to write similar script by yourself.</p>
</div>
<div class="paragraph">
<p>In this document, the domain name is referred as <code>{DOMAIN_NAME}</code> (an example of domain name is <code>example.com</code>).
However, this domain name itself is not used directly.
Instead, a subdomain is used, which referred as <code>{SERVER_SUBDOMAIN}</code> (an example would be <code>silverbox.example.com</code>).
So the FQDN of the server as it seen from the internet is <code>{SERVER_SUBDOMAIN}</code>.
This approach offers some flexibility, for example, the domain name itself (e.g. <code>example.com</code>)
can be used for different purposes (like hosting some website), while subdomain (e.g. <code>silverbox.example.com</code>)
is used to access the server over SSH.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Some scripts listed in this document have one limitation: only domain names that consists of two components
(i.e. one subdomain after TLD) are supported. For example, domain name <code>example.com</code> is supported while
<code>example.co.uk</code> is not.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_dynamic_dns_update">8.1. Dynamic DNS Update</h3>
<div class="paragraph">
<p>This section describes how to setup automatic DNS host A record update with the current public address of the server.
This way the server can be accessed from the internet by its FQDN, even if its public IP address is dynamic.</p>
</div>
<div class="paragraph">
<p>The dynamic DNS record update is initiated by Systemd timer, that runs Docker container with a python script
that uses NameSilo API to make an update.
The Docker container is used for convenience, isolation and resource limiting
(NameSilo API uses XML which can exhaust system resources while parsing malformed or maliciously constructed XML).</p>
</div>
<div class="sect3">
<h4 id="_prerequisites">8.1.1. Prerequisites</h4>
<div class="paragraph">
<p>First, login to your NameSilo account and generate API key, which will be used to authenticate to the NameSilo API.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Keep the API key secure, as it grants complete access to your NameSilo account.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then create a host A DNS record for the <code>{SERVER_SUBDOMAIN}</code> with any content.
This entry needs to be created manually because the DNS update script only updates existing record
but doesn&#8217;t create it.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_docker_network_2">8.1.2. Creating Docker Network</h4>
<div class="paragraph">
<p>First, create a separate Docker network that will be used to run containers other than VPN-related containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker network create --driver=bridge --subnet={DOCKER_COMMON_NETWORK} common <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{DOCKER_COMMON_NETWORK}</code> with the some subnet for the common Docker network. For example: <code>172.19.0.0/24</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_image_files_2">8.1.3. Preparing Image Files</h4>
<div class="paragraph">
<p>This section assumes that all steps from the <a href="#socks5_over_vpn">SOCKS5 Over VPN</a> section have been completed.</p>
</div>
<div class="paragraph">
<p>Create a directory for the DNS records updater container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/dns-updater
sudo chmod 700 /root/silverbox/containers/dns-updater</pre>
</div>
</div>
<div class="paragraph">
<p>Inside the <code>dns-updater</code> directory, create a file named <code>Dockerfile</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/dns-updater/Dockerfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="dockerfile"><span class="k">FROM</span><span class="s"> debian:11.3-slim </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> python3 ca-certificates

<span class="k">COPY</span><span class="s"> update-dns.py /usr/local/bin/</span>

<span class="k">VOLUME</span><span class="s"> /secrets </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="k">ENTRYPOINT</span><span class="s"> [ "python3", "/usr/local/bin/update-dns.py" ]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>11.3-slim</code> with the actual latest <code>debian</code> image version (can be checked at the Docker Hub).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>For the lack of better option, the API key is passed inside the container in a file on a mapped volume.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create the <code>update-dns.py</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/dns-updater/update-dns.py</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="python"><span class="c1">#!/usr/bin/env python3
</span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">urllib.request</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">xml.dom</span> <span class="kn">import</span> <span class="n">minidom</span>

<span class="n">DEFAULT_HEADERS</span><span class="o">=</span><span class="p">{</span> <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'curl/7.58.0'</span> <span class="p">}</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="k">def</span> <span class="nf">namesilo_url</span><span class="p">(</span><span class="n">operation</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">'https://www.namesilo.com/api/'</span> <span class="o">+</span> <span class="n">operation</span> <span class="o">+</span> <span class="s">'?version=1&amp;type=xml&amp;key='</span> <span class="o">+</span> <span class="n">api_key</span>

<span class="k">def</span> <span class="nf">check_reply_code</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
    <span class="n">actual</span><span class="o">=</span><span class="n">doc</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'reply'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'code'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">firstChild</span><span class="p">.</span><span class="n">nodeValue</span>
    <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">BaseException</span><span class="p">(</span><span class="s">'Expecting code {} got {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">actual</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">get_dns_record</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
    <span class="n">response</span><span class="o">=</span><span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="p">(</span><span class="n">namesilo_url</span><span class="p">(</span><span class="s">'dnsListRecords'</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span> <span class="o">+</span> <span class="s">'&amp;domain='</span> <span class="o">+</span> <span class="n">domain</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">DEFAULT_HEADERS</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">=</span><span class="n">minidom</span><span class="p">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">check_reply_code</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'reply'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'resource_record'</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'host'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">firstChild</span><span class="p">.</span><span class="n">nodeValue</span> <span class="o">==</span> <span class="n">subdomain</span> <span class="ow">and</span> <span class="n">e</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'type'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">firstChild</span><span class="p">.</span><span class="n">nodeValue</span> <span class="o">==</span> <span class="n">rec_type</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span> <span class="s">'val'</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'value'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">firstChild</span><span class="p">.</span><span class="n">nodeValue</span><span class="p">,</span>
                     <span class="s">'id'</span><span class="p">:</span>  <span class="n">e</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'record_id'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">firstChild</span><span class="p">.</span><span class="n">nodeValue</span><span class="p">,</span>
                     <span class="s">'ttl'</span><span class="p">:</span> <span class="n">e</span><span class="p">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">'ttl'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">firstChild</span><span class="p">.</span><span class="n">nodeValue</span> <span class="p">}</span>
    <span class="k">raise</span> <span class="nb">BaseException</span><span class="p">(</span><span class="s">'DNS {} record for {} not found'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">update_dns_record</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">rec_id</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ttl</span><span class="p">,</span> <span class="n">api_key</span><span class="p">):</span>
    <span class="n">params</span><span class="o">=</span><span class="s">'&amp;domain={}&amp;rrid={}&amp;rrhost={}&amp;rrvalue={}&amp;rrttl={}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">rec_id</span><span class="p">,</span> <span class="s">'.'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdomain</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span> <span class="n">val</span><span class="p">,</span> <span class="n">ttl</span><span class="p">)</span>
    <span class="n">response</span><span class="o">=</span><span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="p">(</span><span class="n">namesilo_url</span><span class="p">(</span><span class="s">'dnsUpdateRecord'</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">DEFAULT_HEADERS</span><span class="p">),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
    <span class="n">check_reply_code</span><span class="p">(</span><span class="n">minidom</span><span class="p">.</span><span class="n">parseString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">read</span><span class="p">()),</span> <span class="mi">300</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">force</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rec_type</span> <span class="o">==</span> <span class="s">'A'</span><span class="p">:</span>
        <span class="n">val</span><span class="o">=</span><span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">'https://api.ipify.org?format=json'</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">).</span><span class="n">read</span><span class="p">())[</span><span class="s">'ip'</span><span class="p">]</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Current external IP address: {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

    <span class="n">current_record</span><span class="o">=</span><span class="n">get_dns_record</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Current DNS {} record for {}: "{}"'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">current_record</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">current_record</span><span class="p">[</span><span class="s">'val'</span><span class="p">]</span> <span class="ow">or</span> <span class="n">force</span><span class="p">:</span>
        <span class="n">update_dns_record</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">domain</span><span class="p">,</span> <span class="n">current_record</span><span class="p">[</span><span class="s">'id'</span><span class="p">],</span> <span class="n">val</span><span class="p">,</span> <span class="n">current_record</span><span class="p">[</span><span class="s">'ttl'</span><span class="p">],</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'{} record for {} updated: "{}" -&gt; "{}"'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">rec_type</span><span class="p">,</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">current_record</span><span class="p">[</span><span class="s">'val'</span><span class="p">],</span> <span class="n">val</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">parser</span><span class="o">=</span><span class="n">argparse</span><span class="p">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-v'</span><span class="p">,</span> <span class="s">'--verbose'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'verbose output'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">'store_true'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-f'</span><span class="p">,</span> <span class="s">'--force'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'force DNS record update (even if it contains the same value)'</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">'store_true'</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-d'</span><span class="p">,</span> <span class="s">'--domain'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'fully qualified domain name for which to update a record (i.e. server.example.com)'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-a'</span><span class="p">,</span> <span class="s">'--action'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'action to perform: update host A record with the current external IP or update TXT record with a given value'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span> <span class="s">'update-ip'</span><span class="p">,</span> <span class="s">'update-txt'</span> <span class="p">])</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-t'</span><span class="p">,</span> <span class="s">'--txt'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'content of the TXT record'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">''</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">'-k'</span><span class="p">,</span> <span class="s">'--key'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">'file name of the file containing API key'</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">args</span><span class="o">=</span><span class="n">parser</span><span class="p">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">api_key</span><span class="o">=</span><span class="n">f</span><span class="p">.</span><span class="n">readline</span><span class="p">().</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">main</span><span class="p">(</span><span class="s">'A'</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">action</span> <span class="o">==</span> <span class="s">'update-ip'</span> <span class="k">else</span> <span class="s">'TXT'</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">txt</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">domain</span><span class="p">,</span> <span class="s">'.'</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">domain</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]),</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">force</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">verbose</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Default <code>urllib</code> user agent has to be overwritten since NameSilo rejects it for some reason.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This script uses <code><a href="https://www.ipify.org" class="bare">https://www.ipify.org</a></code> service to get public IP.
Feel free to replace it with different service if you want.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_storing_api_key">8.1.4. Storing API Key</h4>
<div class="paragraph">
<p>The API key will be stored on disk (only readable by root) and passed inside the container via mapped volume.</p>
</div>
<div class="paragraph">
<p>Create a directory that will be mapped as a volume:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/namesilo</pre>
</div>
</div>
<div class="paragraph">
<p>Create a file <code>/root/silverbox/namesilo/api-key</code> and write the NameSilo API key into it.</p>
</div>
<div class="paragraph">
<p>Assign the following permissions to the directory and file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chown root:root /root/silverbox/namesilo/api-key
sudo chmod 400 /root/silverbox/namesilo/api-key
sudo chmod 500 /root/silverbox/namesilo</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_building_container_image">8.1.5. Building Container Image</h4>
<div class="paragraph">
<p>To build the container image run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker build -t dns-updater --network common /root/silverbox/containers/dns-updater</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_dns_record_update">8.1.6. Automatic DNS Record Update</h4>
<div class="paragraph">
<p>To keep DNS record updated, a Systemd timer will periodically run disposable container
from the image that was just built.</p>
</div>
<div class="paragraph">
<p>Create the <code>/etc/systemd/system/update-dns-record.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/update-dns-record.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Update DNS Host A record with the current external IP address
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker run --rm --name dns-updater --network common --cpus="1" -v /root/silverbox/namesilo:/secrets dns-updater -k /secrets/api-key -a update-ip -d {SERVER_SUBDOMAIN} <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{SERVER_SUBDOMAIN}</code> with your actual server public FQDN.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can run the service once to verify that it runs successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl start update-dns-record.service</pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/systemd/system/update-dns-record.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/update-dns-record.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Update DNS Host A record with the current external IP address

[Timer]
OnBootSec=5min <i class="conum" data-value="1"></i><b>(1)</b>
OnUnitInactiveSec=30min <i class="conum" data-value="2"></i><b>(2)</b>

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First time the timer runs 5 minutes after boot.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After first run, the timer will run every 30 minutes.
You can adjust this value depending on how volatile your public IP is.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable update-dns-record.timer
sudo systemctl start update-dns-record.timer</pre>
</div>
</div>
<div class="paragraph">
<p>You can do <code>sudo systemctl list-timers</code> to verify that the timer appears in the output and to check the time till next activation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_5">8.2. Monitoring</h3>
<div class="paragraph">
<p>The status of the DNS updater Systemd service is monitored by Monit.</p>
</div>
<div class="paragraph">
<p>First, create the <code>/usr/local/etc/monit/scripts/is_systemd_unit_failed.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/etc/monit/scripts/is_systemd_unit_failed.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>
systemctl show <span class="nv">$1</span> <span class="nt">-p</span> ExecMainStartTimestamp <span class="nt">--value</span>
systemctl is-failed <span class="nt">--quiet</span> <span class="nv">$1</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="nt">-eq</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>1
<span class="k">else
    </span><span class="nb">exit </span>0
<span class="k">fi</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod u+x /usr/local/etc/monit/scripts/is_systemd_unit_failed.sh</pre>
</div>
</div>
<div class="paragraph">
<p>This script checks whether the given Systemd unit had failed and prints last time it was executed.</p>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/monit/conf.d/50-dns-updater</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/50-dns-updater</div>
<div class="content">
<pre class="nowrap">check program dns_updater with path "/usr/local/etc/monit/scripts/is_systemd_unit_failed.sh update-dns-record.service" every 30 cycles
  if status != 0 for 2 cycles then alert</pre>
</div>
</div>
<div class="paragraph">
<p>Restart Monit service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart monit</pre>
</div>
</div>
<div class="paragraph">
<p>Check Monit web interface and make sure that DNS updater monitoring is working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="nfs_server">9. NFS Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to install and configure NFS (version 4 only) server with Kerberos authentication
(and optional encryption and integrity validation).
It also provides an example configuration for an automatic NFS share mounting on the client PC.</p>
</div>
<div class="paragraph">
<p>This section assumes that DNS server and domain name have been configured as described in the
<a href="#dns_server">DNS Server</a> and <a href="#domain_name">Domain Name</a> sections.</p>
</div>
<div class="sect2">
<h3 id="_domain">9.1. Domain</h3>
<div class="paragraph">
<p>This section describes how to configure internal (local) domain for the LAN, that is required to configure
Kerberos realm in the next step.</p>
</div>
<div class="paragraph">
<p>The internal domain will be direct subdomain of your domain <code>{DOMAIN_NAME}</code>
and in the document will be referred as <code>{INTERNAL_DOMAIN}</code>.
For example, if your domain is <code>example.com</code>, the internal domain could be <code>home.example.com</code>.</p>
</div>
<div class="paragraph">
<p>Before proceeding to creating local zone for the internal domain, create an address reservations
on your DHCP server for all the client devices that will be in the domain (or configure static IP addresses).</p>
</div>
<div class="sect3">
<h4 id="nfs_configuring_dns">9.1.1. Configuring Local DNS Zone</h4>
<div class="paragraph">
<p>To create local DNS zone for your internal domain,
edit the <code>/etc/unbound/unbound.conf.d/dns-config.conf</code> file
and append the following content under the <code>server</code> section:</p>
</div>
<div class="listingblock">
<div class="title">/etc/unbound/unbound.conf.d/dns-config.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">local-zone</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{INTERNAL_DOMAIN}."</span> <span class="s">static</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="na">local-data</span><span class="pi">:</span> <span class="s2">"</span><span class="s">silverbox.{INTERNAL_DOMAIN}.</span><span class="nv"> </span><span class="s">IN</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">{SERVER_IP_ADDR}"</span> <i class="conum" data-value="2"></i><b>(2)</b>
<span class="na">local-data</span><span class="pi">:</span> <span class="s2">"</span><span class="s">client-pc.{INTERNAL_DOMAIN}.</span><span class="nv"> </span><span class="s">IN</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">{CLIENT_PC_IP_ADDR}"</span> <i class="conum" data-value="3"></i><b>(3)</b>
<span class="na">local-data-ptr</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{SERVER_IP_ADDR}</span><span class="nv"> </span><span class="s">silverbox.{INTERNAL_DOMAIN}"</span> <i class="conum" data-value="4"></i><b>(4)</b>
<span class="na">local-data-ptr</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{CLIENT_PC_IP_ADDR}</span><span class="nv"> </span><span class="s">client-pc.{INTERNAL_DOMAIN}"</span> <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with your internal domain name.
Dot at the end is required.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is forward DNS record for the server. It assumes the server FQDN in the internal domain is
<code>silverbox.{INTERNAL_DOMAIN}</code>, but you can change it of course.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is an example forward record for the client PC.
You can add as many records as you need, for each device you have.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is reverse DNS record for the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This is an example reverse record for the client PC.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart the DNS server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart unbound.service</pre>
</div>
</div>
<div class="paragraph">
<p>Make sure you can resolve all records that were added using FQDNS and IP addresses. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">nslookup silverbox.{INTERNAL_DOMAIN}
nslookup client-pc.{INTERNAL_DOMAIN}
nslookup {SERVER_IP_ADDR}
nslookup {CLIENT_PC_IP_ADDR}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_server_domain_and_fqdn">9.1.2. Configuring Server Domain and FQDN</h4>
<div class="paragraph">
<p>Since the server uses static network configuration, its domain needs to be configured manually.
To do this, edit the <code>/etc/resolv.conf</code> file and add the following line:</p>
</div>
<div class="listingblock">
<div class="title">/etc/resolv.conf</div>
<div class="content">
<pre class="nowrap">search {INTERNAL_DOMAIN}</pre>
</div>
</div>
<div class="paragraph">
<p>Verify that resolution by host name only works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">nslookup silverbox
nslookup client-pc</pre>
</div>
</div>
<div class="paragraph">
<p>To configure server&#8217;s FQDN edit the <code>/etc/hosts</code> file and insert FQDN before host name in the record for <code>127.0.1.1</code>.
So the line for <code>127.0.1.1</code> should look something like this:</p>
</div>
<div class="listingblock">
<div class="title">/etc/hosts</div>
<div class="content">
<pre class="nowrap">127.0.1.1   silverbox.{INTERNAL_DOMAIN} silverbox</pre>
</div>
</div>
<div class="paragraph">
<p>To verify that FQDN is set correctly check the output of the <code>hostname -f</code> command: it should print FQDN.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_clients_domain_and_fqdn">9.1.3. Configuring Client&#8217;s Domain and FQDN</h4>
<div class="paragraph">
<p>If clients use DHCP, the domain can be easily configured on the DHCP server and thus it will be automatically
pushed to the client devices.
If static network configuration is used, then domain will have to be configured manually
(the actual instructions will depend on the client OS).</p>
</div>
<div class="paragraph">
<p>The FQDN configuration will also differ depending on the client OS, but for the Ubuntu 18.04 it is identical
to FQDN configuration on the server.</p>
</div>
<div class="paragraph">
<p>Once domain and FQDN configured on client PC, verify that it works (using <code>nslookup</code> or similar command)
and that both client and server can resolve each other names (both short and FQDN).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_kerberos">9.2. Kerberos</h3>
<div class="paragraph">
<p>Kerberos will be used for secure NFS authentication, and optionally integrity validation and encryption.</p>
</div>
<div class="sect3">
<h4 id="nfs_kerberos_configuring_kdc">9.2.1. Configuring KDC</h4>
<div class="paragraph">
<p>Install MIT Kerberos KDC (key distribution center):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install krb5-kdc</pre>
</div>
</div>
<div class="paragraph">
<p>During installation, you will be prompted for the following parameters:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Realm</dt>
<dd>
<p>Enter fully capitalized internal domain name (<code>{INTERNAL_DOMAIN}</code>)</p>
</dd>
<dt class="hdlist1">Kerberos servers for your realm</dt>
<dd>
<p>Enter the server internal FQDN (e.g. <code>silverbox.{INTERNAL_DOMAIN}</code>)</p>
</dd>
<dt class="hdlist1">Administrative server for your Kerberos realm</dt>
<dd>
<p>Enter the server internal FQDN (e.g. <code>silverbox.{INTERNAL_DOMAIN}</code>)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Then, edit the <code>/etc/krb5kdc/kdc.conf</code> file and add/change the following parameters:</p>
</div>
<div class="listingblock">
<div class="title">/etc/krb5kdc/kdc.conf</div>
<div class="content">
<pre class="nowrap">[kdcdefaults]
    kdc_ports = 88

[realms]
    {INTERNAL_DOMAIN} = { <i class="conum" data-value="1"></i><b>(1)</b>
        kdc_ports = 88
        max_life = 24h 0m 0s
        max_renewable_life = 7d 0h 0m 0s <i class="conum" data-value="2"></i><b>(2)</b>
        master_key_type = aes256-cts
        supported_enctypes = aes256-cts:normal aes128-cts:normal
    }</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The internal domain <code>{INTERNAL_DOMAIN}</code> here must be fully capitalized (since it is realm).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>max_renewable_life</code> parameter effectively controls maximum ticket lifetime.
You can adjust this parameter if you need to.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create new Kerberos database (you&#8217;ll be prompted to create Kerberos DB master password):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo kdb5_util create -s</pre>
</div>
</div>
<div class="paragraph">
<p>Overwrite the <code>/etc/krb5.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/krb5.conf</div>
<div class="content">
<pre class="nowrap">[libdefaults]
    default_realm = {INTERNAL_DOMAIN} <i class="conum" data-value="1"></i><b>(1)</b>
    allow_weak_crypto = false
    ccache_type = 4
    kdc_timesync = 1
[realms]
    {INTERNAL_DOMAIN} = { <i class="conum" data-value="2"></i><b>(2)</b>
        kdc = silverbox.{INTERNAL_DOMAIN} <i class="conum" data-value="3"></i><b>(3)</b>
        admin_server = silverbox.{INTERNAL_DOMAIN} <i class="conum" data-value="4"></i><b>(4)</b>
    }</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The internal domain <code>{INTERNAL_DOMAIN}</code> here must be fully capitalized (since it is realm).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same as above.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>kdc</code> should be set to the server FQDN.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>admin_server</code> should be set to the server FQDN.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Start the KDC service and verify that it starts successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl start krb5-kdc</pre>
</div>
</div>
<div class="paragraph">
<p>Install the <code>krb5-admin-server</code> package which is (weirdly enough) needed to use the <code>kadmin.local</code> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install krb5-admin-server</pre>
</div>
</div>
<div class="paragraph">
<p>Unless you are planning to use remote <code>kadmin</code>, the admin service can be disabled:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl disable krb5-admin-server.service</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, to add Kerberos principal for your user run <code>sudo kadmin.local</code> and then type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">addprinc {SERVER_USER} <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{SERVER_USER}</code> with your actual user name.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adding_firewall_rules">9.2.2. Adding Firewall Rules</h4>
<div class="paragraph">
<p>To allow access to the KDC from the LAN, add the firewall rules:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw allow proto tcp from {SERVER_SUBNET} to any port 88 comment 'Kerberos TCP' <i class="conum" data-value="1"></i><b>(1)</b>
sudo ufw allow proto udp from {SERVER_SUBNET} to any port 88 comment 'Kerberos UDP' <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{SERVER_SUBNET}</code> with the actual LAN subnet.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same as above.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_kerberos_on_the_client">9.2.3. Configuring Kerberos on the Client</h4>
<div class="paragraph">
<p>First, install the MIT Kerberos user package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install krb5-user</pre>
</div>
</div>
<div class="paragraph">
<p>When prompted, set the same parameters as described in the <a href="#nfs_kerberos_configuring_kdc">Configuring KDC</a> section.</p>
</div>
<div class="paragraph">
<p>Next, overwrite the <code>/etc/krb5.conf</code> file with the same content as described in the
<a href="#nfs_kerberos_configuring_kdc">Configuring KDC</a> section.</p>
</div>
<div class="paragraph">
<p>Verify that Kerberos authentication works by doing <code>kinit</code> as your user,
and typing your principal&#8217;s password (same password as was used during principal creation).
The <code>kinit</code> command should succeed and no error message should appear.
Do <code>klist</code> to see the ticket, and then <code>kdestroy</code> to destroy it.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nfs_server_configuration">9.3. NFS Server Configuration</h3>
<div class="paragraph">
<p>This section describes how to install and configure NFSv4 (and only version 4) server to share files in the LAN.</p>
</div>
<div class="sect3">
<h4 id="_installing_nfs_server">9.3.1. Installing NFS Server</h4>
<div class="paragraph">
<p>To install the NFS server do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install nfs-kernel-server</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_nfs_share">9.3.2. Preparing NFS Share</h4>
<div class="paragraph">
<p>First, create a new group <code>{NFS_SHARE_GROUP}</code> that will be used to control the access to the NFS share contents.
This is of course just one way to manage the share access and you don&#8217;t have to do it exactly this way.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo groupadd {NFS_SHARE_GROUP}</pre>
</div>
</div>
<div class="paragraph">
<p>Members of this group will be able to access NFS share directory (and subdirectories, where permitted) on the server.</p>
</div>
<div class="paragraph">
<p>Add your user to this group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo usermod -a -G {NFS_SHARE_GROUP} {SERVER_USER}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You&#8217;ll need to re-login or start a new session to apply group membership.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>/srv/nfs</code> directory, set its group ownership to <code>{NFS_SHARE_GROUP}</code> and set following access mask:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir -p /srv/nfs
sudo chown root:{NFS_SHARE_GROUP} /srv/nfs
sudo chmod 770 /srv/nfs</pre>
</div>
</div>
<div class="paragraph">
<p>Contents of the <code>/srv/nfs</code> directory will be shared using NFS server.
To share other directories you can bind-mount them under the <code>/srv/nfs</code>.</p>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/exports</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/exports</div>
<div class="content">
<pre class="nowrap">/srv/nfs {SERVER_SUBNET}(rw,sync,crossmnt,no_subtree_check,root_squash,fsid=0,sec=krb5) <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{SERVER_SUBNET}</code> with the actual LAN subnet.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This configuration uses <code>sec=krb5</code> parameter, which will use Kerberos for authentication only.
Other possible options are: <code>sec=krb5i</code> for authentication and integrity validation,
<code>sec=krb5p</code> for authentication, integrity validation and encryption.
However, encryption may add performance penalty and may be unnecessary in certain scenarios.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_fixing_nfsdcltrack_issue">9.3.3. Fixing <code>nfsdcltrack</code> Issue</h4>
<div class="paragraph">
<p>Restart the NFS server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart nfs-server</pre>
</div>
</div>
<div class="paragraph">
<p>Most likely you&#8217;ll find the following message in the <code>/var/log/syslog</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">nfsdcltrack Failed to init database: -13</pre>
</div>
</div>
<div class="paragraph">
<p>This is due to the bug in the <code>nfsdcltrack</code> which will hopefully be fixed in the future.</p>
</div>
<div class="paragraph">
<p>The workaround is to initialize <code>nfsdcltrack</code> database manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir -p /var/lib/nfs/nfsdcltrack
sudo nfsdcltrack init</pre>
</div>
</div>
<div class="paragraph">
<p>Restart the NFS server again and make sure the error is now gone from the logs.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_nfs_protocol_versions">9.3.4. Configuring NFS Protocol Versions</h4>
<div class="paragraph">
<p>First, check the output of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo cat /proc/fs/nfsd/versions</pre>
</div>
</div>
<div class="paragraph">
<p>Most likely it will be: <code>-2 +3 +4 +4.1 +4.2</code>.
This shows while NFSv4 is enabled, NFSv3 is enabled as well.</p>
</div>
<div class="paragraph">
<p>To disable all NFS versions except 4 (and also to enable <code>svcgssd</code> needed for Kerberos),
edit the <code>/etc/default/nfs-kernel-server</code> file and change/add the following lines:</p>
</div>
<div class="listingblock">
<div class="title">/etc/default/nfs-kernel-server</div>
<div class="content">
<pre class="nowrap">RPCMOUNTDOPTS="--manage-gids -N2 -N3 -V4 --no-udp"
NEED_SVCGSSD="yes"
RPCNFSDOPTS="-N2 -N3 -V4 --no-udp"</pre>
</div>
</div>
<div class="paragraph">
<p>Restart the NFS server with <code>sudo systemctl restart nfs-server</code>
and check the output of <code>sudo cat /proc/fs/nfsd/versions</code> again.
Now it should be <code>-2 -3 +4 +4.1 +4.2</code> indicating that only NFSv4 is now enabled.</p>
</div>
</div>
<div class="sect3">
<h4 id="_disabling_unused_services">9.3.5. Disabling Unused Services</h4>
<div class="paragraph">
<p>The <code>rpcbind</code> and <code>rpc-gssd</code> services will be running (and even listening on some ports),
even though they are not needed for pure NFSv4 server.
To disable them, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl stop {rpcbind,rpc-gssd}.service rpcbind.socket
sudo systemctl disable {rpcbind,rpc-gssd}.service rpcbind.socket
sudo systemctl mask {rpcbind,rpc-gssd}.service rpcbind.socket</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the system and verify that <code>rpcbind</code> and <code>rpc-gssd</code> are not running.</p>
</div>
</div>
<div class="sect3">
<h4 id="_checking_for_listening_ports">9.3.6. Checking for Listening Ports</h4>
<div class="paragraph">
<p>At this point all legacy services (services not related to NFSv4) should be disabled
and only NFS kernel server should be listening only on TCP port 2049.
Verify this by checking the output of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo netstat -lnptu</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Most likely process name won&#8217;t be shown for the NFS server as socket is opened from the kernel.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_adding_firewall_rule_2">9.3.7. Adding Firewall Rule</h4>
<div class="paragraph">
<p>Add firewall rule to allow NFS traffic from the LAN:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw allow proto tcp from {SERVER_SUBNET} to any port 2049 comment 'NFSv4 Server' <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{SERVER_SUBNET}</code> with the actual LAN subnet.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_user_id_mapping">9.3.8. Enabling User ID Mapping</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is not clear whether these steps are really required or not,
as it seems like the ID translation works even without these module parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>/etc/modprobe.d/nfsd.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/modprobe.d/nfsd.conf</div>
<div class="content">
<pre class="nowrap">options nfsd nfs4_disable_idmapping=0</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the system, and verify that ID mapping is <strong>not</strong> disabled by executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">cat /sys/module/nfsd/parameters/nfs4_disable_idmapping</pre>
</div>
</div>
<div class="paragraph">
<p>Which should return <code>N</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_kerberos_principal">9.3.9. Creating Kerberos Principal</h4>
<div class="paragraph">
<p>Run <code>sudo kadmin.local</code> and add NFS service principal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">addprinc -randkey nfs/silverbox.{INTERNAL_DOMAIN} <i class="conum" data-value="1"></i><b>(1)</b>
ktadd nfs/silverbox.{INTERNAL_DOMAIN} <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual internal domain name.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same as above.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This will create keytab file (in the default location <code>/etc/krb5.keytab</code>)
containing principal&#8217;s key and add principal to the Kerberos database.</p>
</div>
<div class="paragraph">
<p>Creation of default keytab file should trigger <code>rpc-svcgssd</code> service.
Reboot the server and verify that <code>rpc-svcgssd</code> service is now automatically started (is enabled and active):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl status rpc-svcgssd.service</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_nfs_client_configuration">9.4. NFS Client Configuration</h3>
<div class="paragraph">
<p>This section describes how to configure NFS client on the client PC (instructions are for Ubuntu 18.04 Desktop).</p>
</div>
<div class="sect3">
<h4 id="_installing_nfs_client">9.4.1. Installing NFS Client</h4>
<div class="paragraph">
<p>To install NFS client do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install nfs-common</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_enabling_user_id_mapping_2">9.4.2. Enabling User ID Mapping</h4>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is not clear whether these steps are really required or not,
as it seems like the ID translation works even without these module parameters.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>/etc/modprobe.d/nfs.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/modprobe.d/nfs.conf</div>
<div class="content">
<pre class="nowrap">options nfs nfs4_disable_idmapping=0</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the system, and verify that ID mapping is <strong>not</strong> disabled by executing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo modprobe nfs
cat /sys/module/nfs/parameters/nfs4_disable_idmapping</pre>
</div>
</div>
<div class="paragraph">
<p>Which should return <code>N</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_kerberos_principal_2">9.4.3. Creating Kerberos Principal</h4>
<div class="paragraph">
<p>First, add Kerberos principal on the server for the client machine,
and save it to a separate keytab file (do these commands on the server):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo kadmin.local
addprinc -randkey nfs/client-pc.{INTERNAL_DOMAIN} <i class="conum" data-value="1"></i><b>(1)</b>
ktadd -k /root/krb5.keytab nfs/client-pc.{INTERNAL_DOMAIN} <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>client-pc.{INTERNAL_DOMAIN}</code> with your client PC FQDN.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same as above.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then move the <code>/root/krb5.keytab</code> file to the client PC to <code>/etc/krb5.keytab</code>.</p>
</div>
<div class="paragraph">
<p>On the client PC, assign proper ownership and permissions to the keytab file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chown root:root /etc/krb5.keytab
sudo chmod 600 /etc/krb5.keytab</pre>
</div>
</div>
<div class="paragraph">
<p>Next, on the client PC edit the <code>/etc/default/nfs-common</code> file and change/add the following lines:</p>
</div>
<div class="listingblock">
<div class="title">/etc/default/nfs-common</div>
<div class="content">
<pre class="nowrap">NEED_GSSD="yes"</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the client PC and verify that the <code>rpc-gssd</code> service is now running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl status rpc-gssd.service</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_disabling_unused_services_2">9.4.4. Disabling Unused Services</h4>
<div class="paragraph">
<p>The <code>rpcbind</code> service will be running (and listening on some ports),
even though it is not needed for NFSv4.
To disable it do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl stop rpcbind.service rpcbind.socket
sudo systemctl disable rpcbind.service rpcbind.socket
sudo systemctl mask rpcbind.service rpcbind.socket</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the system and verify that the <code>rpcbind</code> service is not running anymore.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_nfs_share_group">9.4.5. Creating NFS Share Group</h4>
<div class="paragraph">
<p>Create the same <code>{NFS_SHARE_GROUP}</code> group on the client machine, and add your user into it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo groupadd {NFS_SHARE_GROUP}
sudo usermod -a -G {NFS_SHARE_GROUP} {SERVER_USER}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There is no need to synchronize UID/GID for the user and group between server and client,
because ID mapping process in NFSv4 is name based, rather than UID/GID based.
It is important to make sure that the user and group have the same names on server and client.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_performing_test_mount">9.4.6. Performing Test Mount</h4>
<div class="paragraph">
<p>Create the <code>/mnt/nfs</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /mnt/nfs</pre>
</div>
</div>
<div class="paragraph">
<p>To test that everything works, perform a test NFS mount with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mount -t nfs4 -o proto=tcp,port=2049,sec=krb5 silverbox.{INTERNAL_DOMAIN}:/ /mnt/nfs -vvvv</pre>
</div>
</div>
<div class="paragraph">
<p>The output should look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">mount.nfs4: timeout set for ...
mount.nfs4: trying text-based options 'proto=tcp,port=2049,sec=krb5,vers=4.2,addr=xxx.xxx.xxx.xxx,clientaddr=xxx.xxx.xxx.xxx'</pre>
</div>
</div>
<div class="paragraph">
<p>Try accessing the mount as root user by doing <code>sudo ls /mnt/nfs</code>.
You should see <code>Permission denied</code> message as the root
user is mapped to <code>nobody:nogroup</code> and don&#8217;t have permissions to access the share.</p>
</div>
<div class="paragraph">
<p>Now try accessing the share as your user by doing <code>ls /mnt/nfs</code>.
You should see either <code>Permission denied</code> or <code>Stale file handle</code> message, because your user don&#8217;t have Kerberos ticket.</p>
</div>
<div class="paragraph">
<p>Finally, do <code>kinit</code> to obtain the Kerberos ticket for your user and try accessing share again. It should work now.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is worth at this point to do some testing by creating files to make sure ID mapping works properly (both ways)
and user/group ownership is assigned correctly.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_nfs_share_mount">9.4.7. Automatic NFS Share Mount</h4>
<div class="paragraph">
<p>This section describes how to setup automatic mounting of the NFS share on your user login (without any interaction).</p>
</div>
<div class="paragraph">
<p>The first step is to configure an automatic mount of the NFS share on boot.
To do this, append the following line to the <code>/etc/fstab</code> file (on the client PC):</p>
</div>
<div class="listingblock">
<div class="title">/etc/fstab</div>
<div class="content">
<pre class="nowrap">silverbox.{INTERNAL_DOMAIN}:/ /mnt/nfs nfs4 proto=tcp,port=2049,sec=krb5,lazytime,auto,_netdev,x-gvfs-show 0 0 <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>silverbox.{INTERNAL_DOMAIN}</code> with the actual server FQDN.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>x-gvfs-show</code> option will make NFS share to appear in Nautilus file manager panel automatically.
If you are not using Nautilus you can remove this option.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you prefer NFS share to be mounted only on first access, change <code>auto</code> parameter to <code>noauto</code>
and add <code>x-systemd.automount</code> parameter (for additional options, refer to systemd.mount documentation).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this change in the <code>fstab</code>, the share will be mounted on boot using credentials from the <code>/etc/krb5.keytab</code> file.
However, since this keytab only contains machine key, it won&#8217;t allow any access to the content of the share.</p>
</div>
<div class="paragraph">
<p>The next step is to export your user&#8217;s Kerberos key into a separate keytab file,
and create a user Systemd service which will do <code>kinit</code> for your user automatically on login.
Since this <code>kinit</code> will use key from the user&#8217;s keytab file, no interaction (such as entering password)
will be required.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Another (and, perhaps, a more convenient) way to automatically do Kerberos authentication on login
is to use <code>pam-krb5</code> PAM module.
If your Kerberos principal has the same password as your local user, you can install <code>pam-krb5</code>
and add the following line (after line for regular auth) to appropriate configuration file
under <code>/etc/pam.d</code> (depends on the distribution): <code>auth optional pam_krb5.so minimum_uid=1000 use_first_pass</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To export your principal&#8217;s key, run the following commands on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo kadmin.local
ktadd -k /root/krb5.keytab {SERVER_USER}</pre>
</div>
</div>
<div class="paragraph">
<p>Move the <code>/root/krb5.keytab</code> file from the server to the client PC, for example under your users home <code>.config</code>
directory: <code>~/.config/krb5.keytab</code>.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is important to have either full disk encryption or at least user&#8217;s home directory encryption,
since the Kerberos principal key will be stored on disk.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Change permission on this file so that only your user can read it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">chown {SERVER_USER}:{SERVER_USER} ~/.config/krb5.keytab
chmod 400 ~/.config/krb5.keytab</pre>
</div>
</div>
<div class="paragraph">
<p>Create directory (on the client PC) for user Systemd services, if it doesn&#8217;t exist yet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">mkdir -p ~/.local/share/systemd/user/</pre>
</div>
</div>
<div class="paragraph">
<p>Inside this directory, create <code>nfs-kinit.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">~/.local/share/systemd/user/kinit.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Perform kinit automatically

[Service]
Type=oneshot
ExecStart=/bin/bash -c "kinit -r 7d -k -t ~/.config/krb5.keytab $USER" <i class="conum" data-value="1"></i><b>(1)</b>

[Install]
WantedBy=default.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>7d</code> with the value of the <code>max_renewable_life</code> option that you set in the <code>kdc.conf</code> file on the server.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable this service, so it will start automatically on login:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">systemctl --user daemon-reload
systemctl --user enable kinit.service</pre>
</div>
</div>
<div class="paragraph">
<p>Reboot the system and verify that you can access the content of the NFS share.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Since the service only started on login, if the user session will last longer than <code>max_renewable_life</code>,
the Kerberos ticket will eventually expire.
If you planning on having long user sessions, you can either increase <code>max_renewable_life</code> or make this service
run periodically to obtain a new ticket before old one expires.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If user&#8217;s home directory is encrypted, the Systemd service won&#8217;t start on login.
It appears that user Systemd services are scanned before home directory is mounted and thus Systemd won&#8217;t see
the service.
The only workaround I found for this is to add <code>systemctl --user daemon-reload</code> and
<code>systemctl --user start kinit.service</code> commands to the script that runs after user login
(it will depend on your system, but in Gnome it can be set with &#8220;Startup Applications&#8221;).
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_transmission">10. Transmission</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes hot to setup Transmission <a href="#transmission">[10]</a> BitTorrent client on the server.
Similarly to how SOCKS5 proxy server was deployed (as described in the <a href="#socks5_over_vpn">SOCKS5 Over VPN</a> section),
the Transmission will be running inside a Docker container together with the OpenVPN,
such that all Transmission traffic will be tunneled though the VPN.
Transmission will be managed using web user interface, that will be exposed outside of the container.</p>
</div>
<div class="paragraph">
<p>This section assumes that <a href="#socks5_over_vpn">SOCKS5 Over VPN</a> and <a href="#nfs_server">NFS Server</a> sections were completed.</p>
</div>
<div class="sect2">
<h3 id="_image_2">10.1. Image</h3>
<div class="paragraph">
<p>This section describes how to prepare and build Docker image for the Transmission.</p>
</div>
<div class="sect3">
<h4 id="_preparing_openvpn_profiles">10.1.1. Preparing OpenVPN Profiles</h4>
<div class="paragraph">
<p>Create a <code>transmission</code> directory under the <code>/root/silverbox/vpn</code> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/vpn/transmission
sudo chmod 700 /root/silverbox/vpn/transmission</pre>
</div>
</div>
<div class="paragraph">
<p>And copy all OpenVPN profile files (<code>*.ovpn</code>) that you want to use for Transmission client into it
(you can have multiple files as exit point rotation will be configured).
This way you can use different OpenVPN profiles (and thus exit points) for SOCKS5 proxy and for Transmission.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
At any time, if you want only to use specific profile, create a symlink named <code>profile</code> pointing to desired
profile. For example <code>ln -s SOME_PROFILE.ovpn profile</code>.
Make sure the link is relative and not absolute: otherwise it won&#8217;t work inside the container.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_directory_structure">10.1.2. Preparing Directory Structure</h4>
<div class="paragraph">
<p>In this configuration, Transmission will use directories on the NFS share to read torrent files and to store
downloaded files.
These directories need to be created in advance.</p>
</div>
<div class="paragraph">
<p>As your user, create directories for torrent files and downloads in the NFS directory
and set proper permissions/ownership:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">mkdir -p /srv/nfs/torrents/torrentfiles <i class="conum" data-value="1"></i><b>(1)</b>
mkdir -p /srv/nfs/torrents/downloads <i class="conum" data-value="2"></i><b>(2)</b>
chown {SERVER_USER}:{NFS_SHARE_GROUP} -R /srv/nfs/torrents
chmod 770 -R /srv/nfs/torrents</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This directory will be automatically watched for the <code>*.torrent</code> files
and once new file appear download will be started automatically (torrent file will be removed once added to the queue).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Finished and in-progress downloads will be placed into this directory.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Of course, you can use different directory structure and names, this is just an example.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_image_files_3">10.1.3. Preparing Image Files</h4>
<div class="paragraph">
<p>Create a directory for the Transmission container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/transmission
sudo chmod 700 /root/silverbox/containers/transmission</pre>
</div>
</div>
<div class="paragraph">
<p>Inside the <code>transmission</code> directory, create a file named <code>docker-compose.yaml</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/transmission/docker-compose.yaml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">vpn</span>
    <span class="na">external</span><span class="pi">:</span> <span class="no">true</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">transmission</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">transmission</span>
    <span class="na">init</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">/root/silverbox/containers/transmission</span>
      <span class="na">network</span><span class="pi">:</span> <span class="s">vpn</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11.3-slim'</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:15</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">127.0.0.1:{TRANSMISSION_UI_PORT}:{TRANSMISSION_UI_PORT}/tcp</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">default</span><span class="pi">:</span>
        <span class="na">ipv4_address</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">TRANSMISSION_ADDR</span><span class="pi">}</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="na">devices</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/dev/net/tun</span>
    <span class="na">cap_add</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">NET_ADMIN</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/srv/nfs/torrents:/data</span>
      <span class="pi">-</span> <span class="s">/root/silverbox/vpn/transmission:/vpn-profiles</span>
      <span class="pi">-</span> <span class="s">/root/silverbox/vpn/auth:/vpn-credentials</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>11.3-slim</code> with the actual latest <code>debian</code> image version (can be checked at the Docker Hub).
Note that this is not the Transmission version.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{TRANSMISSION_UI_PORT}</code> with the actual port number.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{TRANSMISSION_ADDR}</code> with the actual address.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create a file named <code>Dockerfile</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/transmission/Dockerfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="dockerfile"><span class="k">ARG</span><span class="s"> version=latest</span>

<span class="k">FROM</span><span class="s"> debian:$version</span>

<span class="k">ARG</span><span class="s"> UID={USER_ID} </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="k">ARG</span><span class="s"> GID={GROUP_ID} </span><i class="conum" data-value="2"></i><b>(2)</b>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> bash iputils-ping iptables openvpn transmission-daemon <span class="o">&amp;&amp;</span> <span class="se">\
</span>    addgroup <span class="nt">--system</span> vpn <span class="o">&amp;&amp;</span> <span class="se">\
</span>    addgroup <span class="nt">--gid</span> <span class="k">${</span><span class="nv">GID</span><span class="k">}</span> transmission <span class="o">&amp;&amp;</span> <span class="se">\
</span>    adduser transmission <span class="nt">--uid</span> <span class="k">${</span><span class="nv">UID</span><span class="k">}</span> <span class="nt">--gid</span> <span class="k">${</span><span class="nv">GID</span><span class="k">}</span> <span class="nt">--disabled-login</span> <span class="nt">--no-create-home</span> <span class="nt">--gecos</span> <span class="s2">""</span> <span class="nt">--shell</span> /usr/sbin/nologin <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mkdir</span> /config <span class="o">&amp;&amp;</span> <span class="nb">chown </span>transmission:transmission /config

<span class="k">COPY</span><span class="s"> docker-entrypoint.sh /usr/local/bin/</span>
<span class="k">COPY</span><span class="s"> start-transmission.sh /usr/local/bin/</span>
<span class="k">COPY</span><span class="s"> --chown=transmission:transmission settings.json /config/</span>

<span class="k">HEALTHCHECK</span><span class="s"> --interval=120s --timeout=20s --start-period=120s CMD ping 1.1.1.1 -c 1 </span><i class="conum" data-value="3"></i><b>(3)</b>

<span class="k">VOLUME</span><span class="s"> ["/vpn-profiles", "/vpn-credentials", "/data"]</span>

<span class="k">EXPOSE</span><span class="s"> {TRANSMISSION_UI_PORT}/tcp </span><i class="conum" data-value="4"></i><b>(4)</b>

<span class="k">ENTRYPOINT</span><span class="s"> [ "/usr/local/bin/docker-entrypoint.sh" ]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{USER_ID}</code> with the UID of your <code>{SERVER_USER}</code> user on the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{GROUP_ID}</code> with the GID of your <code>{NFS_SHARE_GROUP}</code> group on the server.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Feel free to customize health check command.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>{TRANSMISSION_UI_PORT}</code> with some port number of your choice (e.g. 12345).
The container will expose this port to access the Transmission web UI.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>start-transmission.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/transmission/start-transmission.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"-- Preparing to start transmission-daemon..."</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> /config/transmission.log <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"-- Cleaning log file..."</span>
    <span class="nb">tail</span> <span class="nt">-c</span> 10000000 /config/transmission.log <span class="o">&gt;</span> /config/transmission.log.trunc
    <span class="nb">mv</span> /config/transmission.log.trunc /config/transmission.log
    <span class="nb">chown </span>transmission:transmission /config/transmission.log
<span class="k">fi

</span><span class="nv">TUN_IP</span><span class="o">=</span><span class="si">$(</span>ip address show dev tun0 | <span class="nb">awk</span> <span class="s1">'/inet/{ split($2, a, "/"); print a[1] }'</span><span class="si">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$TUN_IP</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"-- Failed to get tun0 IP address"</span>
    <span class="nb">exit </span>1
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"-- tun0 address: [</span><span class="nv">$TUN_IP</span><span class="s2">]. Updating config file."</span>
    <span class="nb">sed</span> <span class="nt">-i</span> <span class="s2">"s/</span><span class="se">\(\"</span><span class="s2">bind-address-ipv4</span><span class="se">\"</span><span class="s2">:</span><span class="se">\)\s\+\"</span><span class="s2">.</span><span class="se">\+\"</span><span class="s2">,/</span><span class="se">\1</span><span class="s2"> </span><span class="se">\"</span><span class="nv">$TUN_IP</span><span class="se">\"</span><span class="s2">,/"</span> /config/settings.json
    <span class="nb">echo</span> <span class="s2">"-- Starting transmission-daemon..."</span>
    su transmission <span class="nt">-s</span> /bin/bash <span class="nt">-c</span> <span class="s2">"transmission-daemon -g /config --logfile /config/transmission.log"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"-- Failed to start transmission"</span>
        <span class="nb">exit </span>1
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"-- Transmission started"</span>
    <span class="k">fi
fi</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And mark it as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod a+x start-transmission.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>docker-entrypoint.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/transmission/docker-entrypoint.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="k">function </span>configure_iptables<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">set</span> <span class="nt">-e</span>

    <span class="nb">local </span><span class="nv">config_file</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
    <span class="nb">local </span><span class="nv">host</span><span class="o">=</span><span class="si">$(</span><span class="nb">awk</span> <span class="s1">'/^remote / {print $2}'</span> <span class="s2">"</span><span class="nv">$config_file</span><span class="s2">"</span><span class="si">)</span>
    <span class="nb">local </span><span class="nv">port</span><span class="o">=</span><span class="si">$(</span><span class="nb">awk</span> <span class="s1">'/^remote / &amp;&amp; NF ~ /^[0-9]*$/ {print $NF}'</span> <span class="s2">"</span><span class="nv">$config_file</span><span class="s2">"</span><span class="si">)</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"-- No port number specified in the VPN profile file"</span>
        <span class="nb">exit </span>1
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"-- Setting up firewall rules for VPN server </span><span class="nv">$host</span><span class="s2"> on port </span><span class="nv">$port</span><span class="s2">"</span>
    <span class="k">fi

    </span>iptables <span class="nt">--flush</span>
    iptables <span class="nt">--delete-chain</span>

    iptables <span class="nt">--policy</span> INPUT DROP
    iptables <span class="nt">--policy</span> OUTPUT DROP
    iptables <span class="nt">--policy</span> FORWARD DROP

    iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> lo <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> tun0 <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> eth0 <span class="nt">-p</span> tcp <span class="nt">-s</span> <span class="nv">$host</span> <span class="nt">--sport</span> <span class="nv">$port</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> INPUT <span class="nt">-i</span> eth0 <span class="nt">-p</span> tcp <span class="nt">-s</span> <span class="o">{</span>VPN_NETWORK_GW<span class="o">}</span> <span class="nt">--dport</span> <span class="o">{</span>TRANSMISSION_UI_PORT<span class="o">}</span> <span class="nt">-j</span> ACCEPT <i class="conum" data-value="1"></i><b>(1)</b>

    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> lo <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> tun0 <span class="nt">-j</span> ACCEPT
    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> eth0 <span class="nt">-d</span> <span class="o">{</span>VPN_NETWORK_GW<span class="o">}</span> <span class="nt">-p</span> tcp <span class="nt">--sport</span> <span class="o">{</span>TRANSMISSION_UI_PORT<span class="o">}</span> <span class="nt">-m</span> conntrack <span class="nt">--ctstate</span> ESTABLISHED,RELATED <span class="nt">-j</span> ACCEPT <i class="conum" data-value="2"></i><b>(2)</b>
    iptables <span class="nt">-A</span> OUTPUT <span class="nt">-o</span> eth0 <span class="nt">-p</span> tcp <span class="nt">-d</span> <span class="nv">$host</span> <span class="nt">--dport</span> <span class="nv">$port</span> <span class="nt">-m</span> owner <span class="nt">--gid-owner</span> vpn <span class="nt">-j</span> ACCEPT

    <span class="nb">set</span> +e
<span class="o">}</span>

<span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span><span class="nt">-ge</span> 1 <span class="o">]]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exec</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
<span class="k">else
    if</span> <span class="o">[</span> <span class="nt">-f</span> /vpn-profiles/profile <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"-- Profile file found: only it will be used"</span>
        <span class="nv">PROFILE_FILE</span><span class="o">=</span><span class="s2">"/vpn-profiles/profile"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"-- Profile file not found: random profile file will be picked"</span>
        <span class="nv">PROFILE_FILE</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">ls</span> <span class="nt">-1</span> /vpn-profiles/<span class="k">*</span>.ovpn | <span class="nb">shuf</span> <span class="nt">-n</span> 1<span class="si">)</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"-- Selected profile file: </span><span class="nv">$PROFILE_FILE</span><span class="s2">"</span>
    <span class="k">fi

    </span>configure_iptables <span class="s2">"</span><span class="nv">$PROFILE_FILE</span><span class="s2">"</span>

    <span class="nb">exec </span>sg vpn <span class="nt">-c</span> <span class="s2">"openvpn --config </span><span class="nv">$PROFILE_FILE</span><span class="s2"> --verb 1 --auth-user-pass /vpn-credentials/credentials --auth-nocache --script-security 2 --route-up /usr/local/bin/start-transmission.sh"</span>
<span class="k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{VPN_NETWORK_GW}</code> with the default gateway address of your VPN Docker network <code>{DOCKER_VPN_NETWORK}</code>.
For example, if your <code>{DOCKER_VPN_NETWORK}</code> is <code>172.18.0.0/24</code> the gateway address would be <code>172.18.0.1</code>.
Also, replace <code>{TRANSMISSION_UI_PORT}</code> with the actual port number.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same as above.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mark this script as executable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod a+x docker-entrypoint.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, create the <code>settings.json</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/transmission/settings.json</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"rpc-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rpc-bind-address"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{TRANSMISSION_ADDR}"</span><span class="p">,</span><span class="w"> <i class="conum" data-value="1"></i><b>(1)</b>
    </span><span class="nl">"rpc-port"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="err">TRANSMISSION_UI_PORT</span><span class="p">},</span><span class="w"> <i class="conum" data-value="2"></i><b>(2)</b>
    </span><span class="nl">"rpc-whitelist"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{VPN_NETWORK_GW}"</span><span class="p">,</span><span class="w"> <i class="conum" data-value="3"></i><b>(3)</b>
    </span><span class="nl">"rpc-whitelist-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">

    </span><span class="nl">"alt-speed-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"speed-limit-down-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"speed-limit-down"</span><span class="p">:</span><span class="w"> </span><span class="mi">2500</span><span class="p">,</span><span class="w">
    </span><span class="nl">"speed-limit-up-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"speed-limit-up"</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">

    </span><span class="nl">"blocklist-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">

    </span><span class="nl">"download-dir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/data/downloads"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"incomplete-dir-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"rename-partial-files"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"start-added-torrents"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"trash-original-torrent-files"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"watch-dir-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"watch-dir"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/data/torrentfiles"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"umask"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w">

    </span><span class="nl">"cache-size-mb"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w">
    </span><span class="nl">"prefetch-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">

    </span><span class="nl">"encryption"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">

    </span><span class="nl">"message-level"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">

    </span><span class="nl">"dht-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lpd-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pex-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"utp-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">

    </span><span class="nl">"bind-address-ipv4"</span><span class="p">:</span><span class="w"> </span><span class="s2">"127.0.0.1"</span><span class="p">,</span><span class="w">

    </span><span class="nl">"peer-limit-global"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w">
    </span><span class="nl">"peer-limit-per-torrent"</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w">
    </span><span class="nl">"peer-congestion-algorithm"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">

    </span><span class="nl">"peer-port"</span><span class="p">:</span><span class="w"> </span><span class="mi">51413</span><span class="p">,</span><span class="w">
    </span><span class="nl">"peer-port-random-on-start"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"port-forwarding-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">

    </span><span class="nl">"download-queue-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"download-queue-size"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queue-stalled-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"queue-stalled-minutes"</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seed-queue-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"seed-queue-size"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">

    </span><span class="nl">"alt-speed-time-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"idle-seeding-limit-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">

    </span><span class="nl">"ratio-limit-enabled"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"ratio-limit"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{TRANSMISSION_ADDR}</code> with some address from the <code>{DOCKER_VPN_NETWORK}</code> that Transmission container
will be running on.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{TRANSMISSION_UI_PORT}</code> with the actual port number.
Make sure this is number and not string in quotes.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{VPN_NETWORK_GW}</code> with the actual address.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Feel free to adjust the values in the <code>settings.json</code> file according to your needs.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_container_2">10.2. Container</h3>
<div class="paragraph">
<p>This section describes how to run the container from the Transmission image.</p>
</div>
<div class="sect3">
<h4 id="_running_container_2">10.2.1. Running Container</h4>
<div class="paragraph">
<p>To build the image and run the container do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/transmission/docker-compose.yaml up -d</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_container_startup_2">10.2.2. Automatic Container Startup</h4>
<div class="paragraph">
<p>To start container automatically on boot create the <code>/etc/systemd/system/transmission-start.service</code> file
with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/transmission-start.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Start Transmission container
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker start transmission

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
<div class="paragraph">
<p>Enable the service, so that it will be started on system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable transmission-start.service</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_vpn_server_rotation_2">10.2.3. Automatic VPN Server Rotation</h4>
<div class="paragraph">
<p>VPN server rotation is configured in the similar way to SOCKS5 proxy VPN server rotation.</p>
</div>
<div class="paragraph">
<p>Create the <code>/etc/systemd/system/transmission-restart.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/transmission-restart.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Restart Transmission container
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker restart transmission</pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>/etc/systemd/system/transmission-restart.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/transmission-restart.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Restart Transmission container

[Timer]
OnCalendar=Fri *-*-* 01:00:00 <i class="conum" data-value="1"></i><b>(1)</b>
AccuracySec=1h
Persistent=true

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this configuration timer is activated every Friday at 1am. Feel free to adjust this.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable transmission-restart.timer
sudo systemctl start transmission-restart.timer</pre>
</div>
</div>
<div class="paragraph">
<p>You can do <code>systemctl list-timers</code> to verify that the timer appears in the output
and to check the time till next activation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_6">10.3. Monitoring</h3>
<div class="paragraph">
<p>The status of the Transmission container is monitored by Monit.</p>
</div>
<div class="paragraph">
<p>Create the <code>/etc/monit/conf.d/60-docker-transmission</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/60-docker-transmission</div>
<div class="content">
<pre class="nowrap">check program transmission with path "/usr/local/etc/monit/scripts/container_status.sh transmission .State.Health.Status healthy"
  if status != 0 for 10 cycles then alert</pre>
</div>
</div>
<div class="paragraph">
<p>Restart Monit service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart monit</pre>
</div>
</div>
<div class="paragraph">
<p>Check Monit web interface and make sure that Transmission monitoring is working.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user_interface">10.4. User Interface</h3>
<div class="paragraph">
<p>Transmission has web based user interface that is exposed outside of the Docker container.
However, it is exposed on the localhost only, so it is not accessible from the outside.</p>
</div>
<div class="paragraph">
<p>To access Transmission web UI securely first SSH tunnel needs to be created (similarly to how Monit UI is accessed).
For example, from the client PC establish a SSH tunnel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh {SERVER_USER}@{SERVER_IP_ADDR} -N -L 127.0.0.1:{LOCAL_PORT}:127.0.0.1:{TRANSMISSION_UI_PORT}</pre>
</div>
</div>
<div class="paragraph">
<p>Here <code>{LOCAL_PORT}</code> is port on which SSH will be listening on the client PC.
Web interface now can be accessed on the client pc at <code><a href="http://127.0.0.1:{LOCAL_PORT}" class="bare">http://127.0.0.1:{LOCAL_PORT}</a></code>.</p>
</div>
<div class="paragraph">
<p>To create this tunnel in more convenient way, you can add the following entry to your SSH config file <code>~/.ssh/config</code>:</p>
</div>
<div class="listingblock">
<div class="title">~/.ssh/config</div>
<div class="content">
<pre class="nowrap">host silverbox-transmission-ui-tunnel
    HostName {SERVER_IP_ADDR} <i class="conum" data-value="1"></i><b>(1)</b>
    IdentityFile ~/.ssh/silverbox-key
    LocalForward 127.0.0.1:{LOCAL_PORT} 127.0.0.1:{TRANSMISSION_UI_PORT}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>IP can be replaced with the server FQDN.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now the tunnel can be established simply with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh -N silverbox-transmission-ui-tunnel</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More convenient way of accessing Transmission web interface and other internal services is described in the <a href="#reverse_proxy">Reverse Proxy</a> section.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_nextcloud">11. Nextcloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to install and configure Nextcloud <a href="#nextcloud">[11]</a> on the server,
in such a way that it can be accessed from the internet securely over HTTPS.</p>
</div>
<div class="paragraph">
<p>This section depends on the following sections: <a href="#docker">Docker</a>, <a href="#domain_name">Domain Name</a>, <a href="#nfs_server">NFS Server</a>.</p>
</div>
<div class="sect2">
<h3 id="_overview">11.1. Overview</h3>
<div class="paragraph">
<p>The Nextcloud will be deployed using Docker (more specifically - Docker Compose).
Below is a diagram that shows high level overview of the Nextcloud deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">    Nextcloud Docker Network
   ----------------------------------------------------------------------------------
  |            ------------              -----------              ------------       |
  |   HTTPS   |   Apache   |  9000/tcp  | Nextcloud |  5432/tcp  |            |      |
-------------&gt;| Web Server |-----------&gt;|    PHP    |-----------&gt;| PostgreSQL |      |
  |      _____|  (httpd)   |            |    FPM    |            |            |      |
  |     |      ------------              -----------              ------------       |
  |     |            |                     |   |  |                    |             |
  |     |   {/usr/local/apache2/htdocs}    |   |  |                    |             |
  |     |            |         {/var/www/html} |  |       {/var/lib/postgresql/data} |
  |  {/certs}        |              |          |  |                    |             |
  |     |            v              v     _____|  |                    v             |
  |     |          /srv/nextcloud/html   |      {/data}        /srv/nextcloud/db     |
  |     v                                |        |                                  |
  | /etc/letsencrypt                 {/nfs/*}     v                                  |
  |                                      |     /srv/nextcloud/data                   |
  |                                      v                                           |
  |                                  /srv/nfs/*                                      |
   ----------------------------------------------------------------------------------</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the diagram above, a path inside curly braces indicates a path as it seen inside Docker container,
while path without curly braces indicates the real path on the host file system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As the diagram shows, the only external entry point to the Nextcloud system is over HTTPS
via the container with Apache Web Server.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
All Nextcloud services (web interface, WebDAV, CalDAV, CardDAV, Sync app) work over HTTPS.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>HTTP requests are handled in the following way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If this is a request to a PHP file:</p>
<div class="ulist">
<ul>
<li>
<p>The request is proxied to the Nextcloud PHP FPM container using <code>mod_proxy_fcgi</code> module.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Otherwise:</p>
<div class="ulist">
<ul>
<li>
<p>The request is served directly by the Apache Web Server (statically).</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>All containers are stateless (i.e. don&#8217;t contain any important data), since all user data is stored
on the host file system and mounted inside containers.
This way containers can be safely deleted and re-deployed, which makes upgrades very easy.</p>
</div>
<div class="paragraph">
<p>Having three separate containers (instead of just one big container) allows for stopping,
restarting and upgrading containers independently, which is useful in many cases.
It also allows every container to have its own logs and logs configuration.
But more importantly, compromising or DoS-ing one container doesn&#8217;t compromise the whole system.</p>
</div>
</div>
<div class="sect2">
<h3 id="nextcloud_certificate">11.2. Certificate</h3>
<div class="paragraph">
<p>This section describes how to obtain and maintain publicly trusted SSL/TLS Certificate
that will be used to setup HTTPS for the Nextcloud.</p>
</div>
<div class="paragraph">
<p>The certificate will be issued by Let&#8217;s Encrypt <a href="#lets_encrypt">[12]</a>
and will be obtained and renewed using Certbot <a href="#certbot">[13]</a>.</p>
</div>
<div class="paragraph">
<p>The certificate needs to be obtained before Nextcloud installation,
since Nextcloud will only be reachable via HTTPS (not plain HTTP) and the web server won&#8217;t start without certificate.</p>
</div>
<div class="paragraph">
<p>ACME DNS challenge is used for domain validation (needed to issue the initial certificate and for subsequent renewals).
One major advantage DNS challenge has over more widely used HTTP challenge
is that it doesn&#8217;t require your web server to use standard ports: 80 and 443.
This allows to host Nextcloud on non-standard port which can be advantageous for two reasons:
using non-standard port can dramatically reduce amount of unwanted requests from bots,
and it may be the only option if your ISP blocks standard ports 80 and 443.</p>
</div>
<div class="sect3">
<h4 id="_installing_certbot">11.2.1. Installing Certbot</h4>
<div class="paragraph">
<p>Certbot can be installed from the PPA maintained by the EFF team
(the installation is described in more details in Certbot documentation
<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo add-apt-repository ppa:certbot/certbot
sudo apt install certbot</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_domain_name">11.2.2. Preparing Domain Name</h4>
<div class="paragraph">
<p>While its possible to get certificate for the <code>{SERVER_SUBDOMAIN}</code> domain and use it to access the Nextcloud,
it may be better to use a subdomain, like for example <code>nextcloud.silverbox.example.com</code>.
This offers some extra flexibility and you can take advantage of the same origin policy.
In this document, the subdomain for Nextcloud is referred as <code>{NEXTCLOUD_DOMAIN}</code>.</p>
</div>
<div class="paragraph">
<p>The first step is to create a CNAME DNS record to point <code>{NEXTCLOUD_DOMAIN}</code> to <code>{SERVER_SUBDOMAIN}</code>.
Thus, you won&#8217;t have to also dynamically update host A record for the <code>{NEXTCLOUD_DOMAIN}</code>,
as it is already updated for the <code>{SERVER_SUBDOMAIN}</code>.</p>
</div>
<div class="paragraph">
<p>The second step is to create a TXT DNS record for the <code>_acme-challenge.{NEXTCLOUD_DOMAIN}</code> with any value
(the value is just a placeholder and will be replaced with the actual DNS ACME challenge during
domain validation).</p>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_certbot_scripts">11.2.3. Preparing Certbot Scripts</h4>
<div class="paragraph">
<p>To confirm ownership of the domain (for certificate generation and renewal) a DNS challenge will be used.
The reason is that HTTP(S) challenge is way to restrictive, in particular, it forces using the standard
80 and 443 ports which is not always desirable.
DNS challenge, however, only requires you to be able to create a TXT record with a given content,
without enforcing any specific port numbers.</p>
</div>
<div class="paragraph">
<p>At the moment of writing, Certbot did not support Namesilo API, which is why DNS challenge is done using manual hooks.</p>
</div>
<div class="paragraph">
<p>Create a directory where all Certbot related scripts will reside:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/certbot
sudo chmod 700 /root/silverbox/certbot</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create the <code>dns-challenge-auth.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/certbot/dns-challenge-auth.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nv">ACME_SUBDOMAIN</span><span class="o">=</span><span class="s2">"_acme-challenge"</span>
<span class="nv">DOMAIN</span><span class="o">=</span><span class="sb">`</span><span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">'.'</span> <span class="s1">'{print $(NF-1)"."$NF}'</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span><span class="sb">`</span> <span class="o">||</span> <span class="nb">exit </span>1
<span class="nv">NS</span><span class="o">=</span><span class="sb">`</span>dig <span class="s2">"</span><span class="nv">$DOMAIN</span><span class="s2">"</span> NS +short | <span class="nb">head</span> <span class="nt">-1</span><span class="sb">`</span> <span class="o">||</span> <span class="nb">exit </span>2
<span class="nb">echo</span> <span class="s2">"Performing DNS Challenge for domain: </span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2"> in </span><span class="nv">$DOMAIN</span><span class="s2"> with authoritative NS </span><span class="nv">$NS</span><span class="s2">"</span>
docker run <span class="nt">--rm</span> <span class="nt">--network</span> common <span class="nt">--cpus</span><span class="o">=</span><span class="s2">"1"</span> <span class="nt">-v</span> /root/silverbox/namesilo:/secrets dns-updater <span class="nt">-k</span> /secrets/api-key <span class="nt">-a</span> update-txt <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$ACME_SUBDOMAIN</span><span class="s2">.</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span> <span class="nt">-t</span> <span class="s2">"</span><span class="nv">$CERTBOT_VALIDATION</span><span class="s2">"</span> <span class="o">||</span> <span class="nb">exit </span>3

<span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..20<span class="o">}</span><span class="p">;</span> <span class="k">do <i class="conum" data-value="1"></i><b>(1)</b>
    </span><span class="nb">echo</span> <span class="s2">"Checking if DNS updated, attempt </span><span class="nv">$i</span><span class="s2">..."</span>
    <span class="nv">TXT</span><span class="o">=</span><span class="sb">`</span>dig <span class="s2">"@</span><span class="nv">$NS</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$ACME_SUBDOMAIN</span><span class="s2">.</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span> TXT +short | <span class="nb">sed</span> <span class="s1">'s/"//g'</span><span class="sb">`</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$TXT</span><span class="s2">"</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$CERTBOT_VALIDATION</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"Record updated. Waiting extra minute before returning."</span>
        <span class="nb">sleep </span>60 <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="nb">exit </span>0
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"Record still contains '</span><span class="nv">$TXT</span><span class="s2">'. Waiting for 1 minute..."</span>
        <span class="nb">sleep </span>60 <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="k">fi
done

</span><span class="nb">exit </span>4</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>20 is the number of attempts to check if the TXT record has been updated.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Without this extra wait sometime Certbot won&#8217;t pick up the updated TXT value.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>How long to wait between attempts.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create the <code>dns-challenge-cleanup.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/certbot/dns-challenge-cleanup.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>

<span class="nv">ACME_SUBDOMAIN</span><span class="o">=</span><span class="s2">"_acme-challenge"</span>
<span class="nv">DOMAIN</span><span class="o">=</span><span class="sb">`</span><span class="nb">awk</span> <span class="nt">-F</span> <span class="s1">'.'</span> <span class="s1">'{print $(NF-1)"."$NF}'</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">"</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span><span class="sb">`</span> <span class="o">||</span> <span class="nb">exit </span>1
<span class="nv">NS</span><span class="o">=</span><span class="sb">`</span>dig <span class="s2">"</span><span class="nv">$DOMAIN</span><span class="s2">"</span> NS +short | <span class="nb">head</span> <span class="nt">-1</span><span class="sb">`</span> <span class="o">||</span> <span class="nb">exit </span>2
<span class="nb">echo</span> <span class="s2">"Performing DNS Challenge Cleanup for domain: </span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2"> in </span><span class="nv">$DOMAIN</span><span class="s2"> with authoritative NS </span><span class="nv">$NS</span><span class="s2">"</span>
docker run <span class="nt">--rm</span> <span class="nt">--network</span> common <span class="nt">--cpus</span><span class="o">=</span><span class="s2">"1"</span> <span class="nt">-v</span> /root/silverbox/namesilo:/secrets dns-updater <span class="nt">-k</span> /secrets/api-key <span class="nt">-a</span> update-txt <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$ACME_SUBDOMAIN</span><span class="s2">.</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span> <span class="nt">-t</span> <span class="s2">"none"</span> <span class="o">||</span> <span class="nb">exit </span>3 <i class="conum" data-value="1"></i><b>(1)</b>
<span class="nb">echo</span> <span class="s2">"Record cleaned up"</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this example, <code>none</code> value is used as the new TXT record value (since empty value is not allowed).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assign the following permissions to these files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 770 /root/silverbox/certbot/dns-challenge-auth.sh
sudo chmod 770 /root/silverbox/certbot/dns-challenge-cleanup.sh</pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to create renewal hooks that will stop Apache web server before renewal
and start it once new certificate is obtained.</p>
</div>
<div class="paragraph">
<p>To create directories for the renewal hooks run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certificates</pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>/etc/letsencrypt/renewal-hooks/post/nextcloud-web-restart.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/letsencrypt/renewal-hooks/post/nextcloud-web-restart.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"{NEXTCLOUD_DOMAIN}"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then <i class="conum" data-value="1"></i><b>(1)</b>
    </span><span class="nb">echo</span> <span class="s2">"Restarting Nextcloud web server"</span>
    docker compose <span class="nt">-f</span> /root/silverbox/containers/nextcloud/docker-compose.yml restart nextcloud-web
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Skipping Nextcloud web server restart - different domain: </span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span>
<span class="k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> with the actual domain name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This script will be executed automatically by Certbot during the renewal of a certificate,
and if the renewal is for the Nextcloud certificate it will restart Nextcloud&#8217;s web server
to use the new certificate.</p>
</div>
<div class="paragraph">
<p>And assign the following permissions to this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 770 /etc/letsencrypt/renewal-hooks/post/nextcloud-web-restart.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, install the <code>dnsutils</code> package which contains <code>dig</code> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install dnsutils</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_test_certificate">11.2.4. Test Certificate</h4>
<div class="paragraph">
<p>To test that domain validation and certificate renewal works, it is possible to use Let&#8217;s Encrypt test server
to generate test (not trusted) certificate.</p>
</div>
<div class="paragraph">
<p>To get test certificate run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certonly --test-cert \
    --agree-tos \
    -m {YOUR_EMAIL_ADDR} \ <i class="conum" data-value="1"></i><b>(1)</b>
    --manual \
    --preferred-challenges=dns \
    --manual-auth-hook /root/silverbox/certbot/dns-challenge-auth.sh \
    --manual-cleanup-hook /root/silverbox/certbot/dns-challenge-cleanup.sh \
    --must-staple \
    -d {NEXTCLOUD_DOMAIN} <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{YOUR_EMAIL_ADDR}</code> with the email address you wish to use for certificate generation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> with the actual domain name.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This may take a while.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To view information about the generated certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certificates</pre>
</div>
</div>
<div class="paragraph">
<p>To test certificate renewal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot renew --test-cert --dry-run --cert-name {NEXTCLOUD_DOMAIN}</pre>
</div>
</div>
<div class="paragraph">
<p>To revoke and delete the test certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot revoke --test-cert --cert-name {NEXTCLOUD_DOMAIN}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getting_real_certificate">11.2.5. Getting Real Certificate</h4>
<div class="paragraph">
<p>To get the real certificate run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certonly \
    --agree-tos \
    -m {YOUR_EMAIL_ADDR} \
    --manual \
    --preferred-challenges=dns \
    --manual-auth-hook /root/silverbox/certbot/dns-challenge-auth.sh \
    --manual-cleanup-hook /root/silverbox/certbot/dns-challenge-cleanup.sh \
    --must-staple \
    -d {NEXTCLOUD_DOMAIN}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_certificate_renewal">11.2.6. Automatic Certificate Renewal</h4>
<div class="paragraph">
<p>The certificate should be automatically renewed by the Certbot&#8217;s Systemd service.
The service should run automatically triggered by the corresponding timer.
To check the status of the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">systemctl status certbot.timer</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_4">11.3. Installation</h3>
<div class="paragraph">
<p>This section describes how to install and run Nextcloud.</p>
</div>
<div class="sect3">
<h4 id="_preparing_directory_structure_2">11.3.1. Preparing Directory Structure</h4>
<div class="paragraph">
<p>The very first step is to create directories that will be mapped inside Nextcloud Docker containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir -p /srv/nextcloud/db
sudo mkdir /srv/nextcloud/html
sudo mkdir /srv/nextcloud/data
sudo chown 33 /srv/nextcloud/data <i class="conum" data-value="1"></i><b>(1)</b>
sudo chmod 750 -R /srv/nextcloud</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>33</code> is the UID of the <code>www-data</code> user (inside Apache httpd and Nextcloud FPM containers).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All the Nextcloud data (including database, static files and user data)
will be stored under the <code>/srv/nextcloud</code> directory in the following way:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">db</dt>
<dd>
<p>The <code>db</code> subdirectory will store PostgreSQL database files.</p>
</dd>
<dt class="hdlist1">html</dt>
<dd>
<p>The <code>html</code> subdirectory will store static HTML/PHP files.</p>
</dd>
<dt class="hdlist1">data</dt>
<dd>
<p>The <code>data</code> subdirectory will store user&#8217;s data.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to keep these directories owned by the root and have restrictive permissions
since content inside them will be owned by the <code>www-data</code> (UID <code>33</code>) user from the Docker containers.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_images">11.3.2. Preparing Images</h4>
<div class="paragraph">
<p>Create a directory for Nextcloud containers files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/nextcloud
sudo chmod 700 /root/silverbox/containers/nextcloud</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create the <code>docker-compose.yml</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/nextcloud/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">nextcloud</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
    <span class="na">ipam</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">subnet</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">DOCKER_NEXTCLOUD_NETWORK</span><span class="pi">}</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">nextcloud-db</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">nextcloud-db</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:14.3</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:5</span>
    <span class="na">shm_size</span><span class="pi">:</span> <span class="s">256mb</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
        <span class="na">max-file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/srv/nextcloud/db:/var/lib/postgresql/data</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_USER=nextcloud</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD={POSTGRES_PASSWORD}</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="pi">-</span> <span class="s">POSTGRES_DB=nextcloud</span>
      <span class="pi">-</span> <span class="s">POSTGRES_INITDB_ARGS="--data-checksums"</span>

  <span class="na">nextcloud-fpm</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">nextcloud-fpm</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./nextcloud-fpm</span>
      <span class="na">network</span><span class="pi">:</span> <span class="s">common</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">24.0.1-fpm'</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:5</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
        <span class="na">max-file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nextcloud-db</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/srv/nextcloud/html:/var/www/html</span>
      <span class="pi">-</span> <span class="s">/srv/nextcloud/data:/data</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_HOST=nextcloud-db</span>
      <span class="pi">-</span> <span class="s">POSTGRES_DB=nextcloud</span>
      <span class="pi">-</span> <span class="s">POSTGRES_USER=nextcloud</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD={POSTGRES_PASSWORD}</span> <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="pi">-</span> <span class="s">NEXTCLOUD_DATA_DIR=/data</span>
      <span class="pi">-</span> <span class="s">NEXTCLOUD_UPDATE=1</span>
      <span class="pi">-</span> <span class="s">NEXTCLOUD_TRUSTED_DOMAINS='{NEXTCLOUD_DOMAIN}:{NEXTCLOUD_PORT}'</span> <i class="conum" data-value="7"></i><b>(7)</b>

  <span class="na">nextcloud-web</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">nextcloud-web</span>
    <span class="na">build</span><span class="pi">:</span>
      <span class="na">context</span><span class="pi">:</span> <span class="s">./httpd</span>
      <span class="na">network</span><span class="pi">:</span> <span class="s">common</span>
      <span class="na">args</span><span class="pi">:</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2.4.53'</span> <i class="conum" data-value="8"></i><b>(8)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:5</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
        <span class="na">max-file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nextcloud-fpm</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/srv/nextcloud/html:/usr/local/apache2/htdocs</span>
      <span class="pi">-</span> <span class="s">/etc/letsencrypt/live/{NEXTCLOUD_DOMAIN}:/certs/live/{NEXTCLOUD_DOMAIN}</span> <i class="conum" data-value="9"></i><b>(9)</b>
      <span class="pi">-</span> <span class="s">/etc/letsencrypt/archive/{NEXTCLOUD_DOMAIN}:/certs/archive/{NEXTCLOUD_DOMAIN}</span> <i class="conum" data-value="10"></i><b>(10)</b>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">{SERVER_IP_ADDR}:{NEXTCLOUD_PORT}:443"</span> <i class="conum" data-value="11"></i><b>(11)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{DOCKER_NEXTCLOUD_NETWORK}</code> with the actual subnet you want to use for the Nextcloud.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>14.3</code> with the actual latest <code>postgres</code> (Debian based) image version (can be checked at the Docker Hub).
You can double check if this version is supported by the Nextcloud in the Nextcloud documentation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{POSTGRES_PASSWORD}</code> with some random password.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>To build <code>nextcloud-fpm</code> image (same as for <code>nextcloud-web</code> image), <code>common</code> docker network is used.
If you skipped over <a href="#domain_name">Domain Name</a> section where this network is created, create it now as described in that section.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Replace <code>24.0.1-fpm</code> with the actual latest <code>nextcloud-fpm</code> (Debian based) image version (can be checked at the Docker Hub).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Replace <code>{POSTGRES_PASSWORD}</code> with the same password as above.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> with your Nextcloud domain name and
<code>{NEXTCLOUD_PORT}</code> with the port number you chose to use for the Nextcloud
(the Nextcloud web server will listen on this port).</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Replace <code>2.4.53</code> with the actual latest <code>httpd</code> (Debian based) image version (can be checked at the Docker Hub).</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> with the actual domain name for the Nextcloud.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Same as above.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>Replace <code>{SERVER_IP_ADDR}</code> and <code>{NEXTCLOUD_PORT}</code> with the actual values.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="nextcloud_httpd_config">HTTPD</h5>
<div class="paragraph">
<p>Create a directory for the customized Apache HTTPD image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/nextcloud/httpd
sudo chmod 700 /root/silverbox/containers/nextcloud/httpd</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create the <code>Dockerfile</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/nextcloud/httpd/Dockerfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="dockerfile"><span class="k">ARG</span><span class="s"> version=latest</span>

<span class="k">FROM</span><span class="s"> httpd:$version</span>

<span class="k">ARG</span><span class="s"> WWW_DATA_UID=33 </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="k">ARG</span><span class="s"> WWW_DATA_GID=33</span>

<span class="k">RUN </span><span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> www-data<span class="si">)</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s2">"</span><span class="nv">$WWW_DATA_UID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> www-data<span class="si">)</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s2">"</span><span class="nv">$WWW_DATA_GID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit </span>1 <i class="conum" data-value="2"></i><b>(2)</b>

<span class="k">COPY</span><span class="s"> httpd.conf /usr/local/apache2/conf/httpd.conf</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>These UID and GID are currently standard Debian based HTTPD image.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extra precaution to ensure that <code>www-data</code> UID/GID are what we expect (in case they change in newer images).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, create the <code>httpd.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/nextcloud/httpd/httpd.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="apache"><span class="nc">ServerName</span> {NEXTCLOUD_DOMAIN}:{NEXTCLOUD_PORT} <i class="conum" data-value="1"></i><b>(1)</b>
<span class="ss">ServerRoot</span> "/usr/local/apache2"

<span class="nc">Listen</span> 443

<span class="nc">LoadModule</span> mpm_event_module modules/mod_mpm_event.so
<span class="nc">LoadModule</span> authz_core_module modules/mod_authz_core.so
<span class="nc">LoadModule</span> authz_host_module modules/mod_authz_host.so
<span class="nc">LoadModule</span> mime_module modules/mod_mime.so
<span class="nc">LoadModule</span> log_config_module modules/mod_log_config.so
<span class="nc">LoadModule</span> env_module modules/mod_env.so
<span class="nc">LoadModule</span> headers_module modules/mod_headers.so
<span class="nc">LoadModule</span> setenvif_module modules/mod_setenvif.so
<span class="nc">LoadModule</span> proxy_module modules/mod_proxy.so
<span class="nc">LoadModule</span> proxy_fcgi_module modules/mod_proxy_fcgi.so
<span class="nc">LoadModule</span> unixd_module modules/mod_unixd.so
<span class="nc">LoadModule</span> dir_module modules/mod_dir.so
<span class="nc">LoadModule</span> rewrite_module modules/mod_rewrite.so
<span class="nc">LoadModule</span> socache_shmcb_module modules/mod_socache_shmcb.so
<span class="nc">LoadModule</span> ssl_module modules/mod_ssl.so
<span class="nc">LoadModule</span> status_module modules/mod_status.so
<span class="nc">LoadModule</span> http2_module modules/mod_http2.so

<span class="nc">User</span> www-data
<span class="nc">Group</span> www-data

<span class="nc">Protocols</span> h2 http/1.1

<span class="nc">SSLEngine</span> <span class="ss">On</span>
<span class="nc">SSLCipherSuite</span> EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
<span class="nc">SSLHonorCipherOrder</span> <span class="ss">On</span>
<span class="nc">SSLProtocol</span> -all +TLSv1.3 +TLSv1.2
<span class="nc">SSLUseStapling</span> <span class="ss">on</span>
<span class="nc">SSLStaplingCache</span> "shmcb:/usr/local/apache2/logs/ssl_stapling(128000)"
<span class="nc">SSLSessionTickets</span> <span class="ss">Off</span>
<span class="nc">SSLSessionCache</span> "shmcb:/usr/local/apache2/logs/ssl_scache(512000)"
<span class="nc">SSLSessionCacheTimeout</span> 300
<span class="nc">SSLCertificateFile</span> /certs/live/{NEXTCLOUD_DOMAIN}/fullchain.pem <i class="conum" data-value="2"></i><b>(2)</b>
<span class="ss">SSLCertificateKeyFile</span> /certs/live/{NEXTCLOUD_DOMAIN}/privkey.pem <i class="conum" data-value="3"></i><b>(3)</b>

&lt;Directory /&gt;
    <span class="nc">AllowOverride</span> <span class="ss">none</span>
    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span>
<span class="nc">DocumentRoot</span> "/usr/local/apache2/htdocs"
<span class="nc">DirectoryIndex</span> index.html

<span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> "/usr/local/apache2/htdocs"</span><span class="p">&gt;
</span>    <span class="nc">Options</span> <span class="ss">FollowSymLinks</span>
    <span class="nc">AllowOverride</span> <span class="ss">All</span>
    <span class="nc">Require</span> <span class="ss">all</span> granted

    <span class="p">&lt;</span><span class="nl">FilesMatch</span><span class="sr"> \.php$</span><span class="p">&gt;
</span>        <span class="nc">ProxyFCGISetEnvIf</span> "true" SCRIPT_FILENAME "/var/www/html%{reqenv:SCRIPT_NAME}"
        <span class="nc">SetHandler</span> proxy:fcgi://nextcloud-fpm:9000
    <span class="p">&lt;/</span><span class="nl">FilesMatch</span><span class="p">&gt;
</span>
    <span class="nc">Header</span> <span class="ss">always</span> <span class="ss">set</span> Strict-Transport-Security "max-age=15552000; includeSubDomains; preload"
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span>
<span class="p">&lt;</span><span class="nl">Location</span><span class="sr"> "/apache-server-status.html"</span><span class="p">&gt;
</span>    <span class="nc">SetHandler</span> server-status
    <span class="nc">Require</span> ip {SERVER_IP_ADDR} <i class="conum" data-value="4"></i><b>(4)</b>
&lt;/Location&gt;

<span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> ".ht*"</span><span class="p">&gt;
</span>    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span>
<span class="nc">ProxyTimeout</span> 3600

<span class="p">&lt;</span><span class="nl">Proxy</span><span class="sr"> "fcgi://nextcloud-fpm/"</span><span class="p">&gt;
&lt;/</span><span class="nl">Proxy</span><span class="p">&gt;
</span>
<span class="nc">RewriteEngine</span> <span class="ss">on</span>
<span class="nc">RewriteCond</span> %{QUERY_STRING} ^monit$ <i class="conum" data-value="5"></i><b>(5)</b>
<span class="ss">RewriteCond</span> %{REQUEST_METHOD} HEAD
<span class="nc">RewriteCond</span> %{REQUEST_URI} ^/$
<span class="nc">RewriteRule</span> .* - [env=dont_log]

<span class="nc">SetEnvIf</span> <span class="ss">Request_URI</span> "^/apache-server-status.html$" dont_log <i class="conum" data-value="6"></i><b>(6)</b>

<span class="ss">ErrorLog</span> /proc/self/fd/2
<span class="nc">LogLevel</span> warn
<span class="nc">LogFormat</span> "%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
<span class="nc">LogFormat</span> "%h %l %u %t \"%r\" %&gt;s %b" common
<span class="nc">CustomLog</span> /proc/self/fd/1 common env=!dont_log

<span class="nc">TypesConfig</span> conf/mime.types
<span class="nc">AddType</span> application/x-compress .Z
<span class="nc">AddType</span> application/x-gzip .gz .tgz

<span class="nc">Include</span> conf/extra/httpd-mpm.conf

<span class="nc">RewriteEngine</span> <span class="ss">On</span>
<span class="nc">RewriteCond</span> %{REQUEST_METHOD} ^TRACK
<span class="nc">RewriteRule</span> .* - [F]

<span class="nc">RequestHeader</span> <span class="ss">unset</span> <span class="ss">Proxy</span> <span class="ss">early</span>

<span class="nc">ServerTokens</span> Prod
<span class="nc">TraceEnable</span> <span class="ss">off</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> and <code>{NEXTCLOUD_PORT}</code> with the actual values.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Same as above.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>{SERVER_IP_ADDR}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>This rewrite block matches HEAD requests to root with query string equal to "monit" and sets environment variable
<code>dont_log</code> that is later used to filter such requests from the web server logs.
This is useful to filter out requests done by Monit from log, as they will flood logs otherwise.
For security reasons, you can replace "monit" string in the first <code>RewriteCond</code> with a random alphanumeric string,
that you will also put in the Monit configuration for Nextcloud monitoring.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>This rule is used to filter out requests to Apache server status page from logs, as it only used by Monit.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you decide to customize this config file and add some extra modules, make sure you are not using
modules that don&#8217;t work well with Nextcloud.
More info here: <a href="https://docs.nextcloud.com/server/stable/admin_manual/issues/general_troubleshooting.html#web-server-and-php-modules" class="bare">https://docs.nextcloud.com/server/stable/admin_manual/issues/general_troubleshooting.html#web-server-and-php-modules</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_nextcloud_php_fpm">Nextcloud PHP FPM</h5>
<div class="paragraph">
<p>Create a directory for the customized Nextcloud PHP FPM image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/nextcloud/nextcloud-fpm
sudo chmod 700 /root/silverbox/containers/nextcloud/nextcloud-fpm</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create the <code>Dockerfile</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/nextcloud/nextcloud-fpm/Dockerfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="dockerfile"><span class="k">ARG</span><span class="s"> version=fpm</span>

<span class="k">FROM</span><span class="s"> nextcloud:$version</span>

<span class="k">ARG</span><span class="s"> NFSSHARE_GID={GID} </span><i class="conum" data-value="1"></i><b>(1)</b>

<span class="k">ARG</span><span class="s"> WWW_DATA_UID=33 </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="k">ARG</span><span class="s"> WWW_DATA_GID=33</span>

<span class="k">ARG</span><span class="s"> PHP_FPM_CONF=/usr/local/etc/php-fpm.d/www.conf</span>

<span class="k">RUN </span><span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span> www-data<span class="si">)</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s2">"</span><span class="nv">$WWW_DATA_UID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span> www-data<span class="si">)</span><span class="s2">"</span> <span class="nt">-eq</span> <span class="s2">"</span><span class="nv">$WWW_DATA_GID</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="nb">exit </span>1 <i class="conum" data-value="3"></i><b>(3)</b>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-install-recommends</span> supervisor libmagickcore-6.q16-6-extra <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mkdir</span> /var/log/supervisord /var/run/supervisord <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">'s/-l\s\+[0-9]\+/-l 5/'</span> /cron.sh <span class="o">&amp;&amp;</span> <span class="se">\ </span><i class="conum" data-value="4"></i><b>(4)</b>
    sed -i 's/^\(pm.max_children\s*=\)\s*[0-9]\+/\1 20/' ${PHP_FPM_CONF} &amp;&amp; \ <i class="conum" data-value="5"></i><b>(5)</b>
    sed -i 's/^\(pm.start_servers\s*=\)\s*[0-9]\+/\1 5/' ${PHP_FPM_CONF} &amp;&amp; \
    sed -i 's/^\(pm.min_spare_servers\s*=\)\s*[0-9]\+/\1 4/' ${PHP_FPM_CONF} &amp;&amp; \
    sed -i 's/^\(pm.max_spare_servers\s*=\)\s*[0-9]\+/\1 10/' ${PHP_FPM_CONF} &amp;&amp; \
    addgroup --gid ${NFSSHARE_GID} nfsshare &amp;&amp; \
    usermod www-data -aG nfsshare

<span class="k">COPY</span><span class="s"> supervisord.conf /etc/supervisor/supervisord.conf</span>

<span class="k">CMD</span><span class="s"> ["/usr/bin/supervisord", "-c", "/etc/supervisor/supervisord.conf"]</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace the <code>{GID}</code> with the GID of your <code>{NFS_SHARE_GROUP}</code> group.
This is so that Nextcloud can access files in the NFS directory owned by the <code>{NFS_SHARE_GROUP}</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>These UID and GID are currently standard Debian based image.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Extra precaution to ensure that <code>www-data</code> UID/GID are what we expect (in case they change in newer images).</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This is to reduce verbosity of the Cron logs to 5. Adjust if necessary.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Update PHP FPM configuration, feel free to adjust these values according to your needs.
More information at Nextcloud [server tuning](<a href="https://docs.nextcloud.com/server/stable/admin_manual/installation/server_tuning.html#tune-php-fpm" class="bare">https://docs.nextcloud.com/server/stable/admin_manual/installation/server_tuning.html#tune-php-fpm</a>) documentation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create the <code>supervisord.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/nextcloud/nextcloud-fpm/supervisord.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="ini"><span class="nn">[supervisord]</span>
<span class="py">nodaemon</span><span class="p">=</span><span class="s">true</span>
<span class="py">logfile</span><span class="p">=</span><span class="s">/var/log/supervisord/supervisord.log</span>
<span class="py">pidfile</span><span class="p">=</span><span class="s">/var/run/supervisord/supervisord.pid</span>
<span class="py">childlogdir</span><span class="p">=</span><span class="s">/var/log/supervisord/</span>
<span class="py">logfile_maxbytes</span><span class="p">=</span><span class="s">10MB</span>
<span class="py">logfile_backups</span><span class="p">=</span><span class="s">0</span>
<span class="py">loglevel</span><span class="p">=</span><span class="s">info</span>
<span class="py">user</span><span class="p">=</span><span class="s">root</span>

<span class="nn">[program:php-fpm]</span>
<span class="py">stdout_logfile</span><span class="p">=</span><span class="s">/dev/stdout</span>
<span class="py">stdout_logfile_maxbytes</span><span class="p">=</span><span class="s">0</span>
<span class="py">stderr_logfile</span><span class="p">=</span><span class="s">/dev/stderr</span>
<span class="py">stderr_logfile_maxbytes</span><span class="p">=</span><span class="s">0</span>
<span class="py">command</span><span class="p">=</span><span class="s">php-fpm</span>

<span class="nn">[program:cron]</span>
<span class="py">stdout_logfile</span><span class="p">=</span><span class="s">/dev/stdout</span>
<span class="py">stdout_logfile_maxbytes</span><span class="p">=</span><span class="s">0</span>
<span class="py">stderr_logfile</span><span class="p">=</span><span class="s">/dev/stderr</span>
<span class="py">stderr_logfile_maxbytes</span><span class="p">=</span><span class="s">0</span>
<span class="py">command</span><span class="p">=</span><span class="s">/cron.sh</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_firewall_rule_3">11.3.3. Adding Firewall Rule</h4>
<div class="paragraph">
<p>To add Firewall rule to allow accessing the Nextcloud do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw allow proto tcp to any port {NEXTCLOUD_PORT} comment "Nextcloud"</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_port_forwarding_rule">11.3.4. Adding Port Forwarding Rule</h4>
<div class="paragraph">
<p>To access Nextcloud from the outside, add the port forwarding rule on your router,
to forward port <code>{NEXTCLOUD_PORT}</code> to <code>{SERVER_IP_ADDR}:{NEXTCLOUD_PORT}</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_nextcloud">11.3.5. Running Nextcloud</h4>
<div class="paragraph">
<p>To pull/build all necessary images and run the containers do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml up -d</pre>
</div>
</div>
<div class="paragraph">
<p>Verify that all containers have started successfully and check logs for errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker ps
sudo docker logs nextcloud-db
sudo docker logs nextcloud-web
sudo docker logs nextcloud-fpm</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There might be some errors in the PostgreSQL container logs, related to the unique constrain violation
on the <code>lock_key_index</code>.
This is due to the following bug in the Nextcloud: <a href="https://github.com/nextcloud/server/issues/6343" class="bare">https://github.com/nextcloud/server/issues/6343</a>.
Hopefully, this bug will eventually be fixed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Open Nextcloud web interface <code><a href="https://{NEXTCLOUD_DOMAIN}:{NEXTCLOUD_PORT}" class="bare">https://{NEXTCLOUD_DOMAIN}:{NEXTCLOUD_PORT}</a></code> and create admin account.</p>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_containers_startup">11.3.6. Automatic Containers Startup</h4>
<div class="paragraph">
<p>To start containers automatically (in the correct order)
on boot create the <code>/etc/systemd/system/nextcloud-start.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/nextcloud-start.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Start Nextcloud
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml up -d

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
<div class="paragraph">
<p>Enable the service, so that it will be started on system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable nextcloud-start.service</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_3">11.4. Configuration</h3>
<div class="paragraph">
<p>This section only describes some generic post-install configuration
as your configuration will highly depend on the use case.</p>
</div>
<div class="sect3">
<h4 id="_fixing_security_and_setup_warnings">11.4.1. Fixing Security and Setup Warnings</h4>
<div class="paragraph">
<p>Navigate to <em>Settings &#8594; Overview</em> page and check the &#8220;Security &amp; setup warnings&#8221; section.</p>
</div>
<div class="paragraph">
<p>Most likely you&#8217;ll see at least one warning here: <code>Some columns in the database are missing a conversion to big int</code>.
To fix it, run the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml exec --user www-data nextcloud-fpm php occ maintenance:mode --on
sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml exec --user www-data nextcloud-fpm php occ db:convert-filecache-bigint --no-interaction
sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml exec --user www-data nextcloud-fpm php occ maintenance:mode --off</pre>
</div>
</div>
<div class="paragraph">
<p>Verify that warning disappeared.</p>
</div>
<div class="paragraph">
<p>If there are any other warnings, refer to the Nextcloud Admin Guide for resolutions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_editing_nextcloud_config_file">11.4.2. Editing Nextcloud Config File</h4>
<div class="paragraph">
<p>Edit the <code>/srv/nextcloud/html/config/config.php</code> file and add/modify the following parameters:</p>
</div>
<div class="listingblock">
<div class="title">/srv/nextcloud/html/config/config.php</div>
<div class="content">
<pre class="nowrap">'loglevel' =&gt; 1, <i class="conum" data-value="1"></i><b>(1)</b>
'overwrite.cli.url' =&gt; 'https://{NEXTCLOUD_DOMAIN}:{NEXTCLOUD_PORT}', <i class="conum" data-value="2"></i><b>(2)</b>
'htaccess.RewriteBase' =&gt; '/', <i class="conum" data-value="3"></i><b>(3)</b>
'default_language' =&gt; 'en',
'default_locale' =&gt; 'en_CA',
'knowledgebaseenabled' =&gt; false, <i class="conum" data-value="4"></i><b>(4)</b>
'token_auth_enforced' =&gt; true, <i class="conum" data-value="5"></i><b>(5)</b>
'default_phone_region' =&gt; 'CA' <i class="conum" data-value="6"></i><b>(6)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sets log level to <em>info</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This and the next line will enable pretty URLs (essentially eliminating <code>index.php</code> from the URLs).
More info: <a href="https://docs.nextcloud.com/server/stable/admin_manual/installation/source_installation.html#pretty-urls" class="bare">https://docs.nextcloud.com/server/stable/admin_manual/installation/source_installation.html#pretty-urls</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Same as above.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>This line disables arguably useless knowledge base page.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Enforces token authentication for API clients for better security (will block requests using the user password).</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set to your country code (more in the Nextcloud documentation).</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml exec --user www-data nextcloud-fpm php occ maintenance:update:htaccess</pre>
</div>
</div>
<div class="paragraph">
<p>And restart Nextcloud:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml restart</pre>
</div>
</div>
<div class="paragraph">
<p>Refresh the Nextcloud page and verify that pretty URLs work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_background_jobs_email_delivery">11.4.3. Background Jobs, Email Delivery</h4>
<div class="paragraph">
<p>Navigate to <em>Settings &#8594; Basic settings</em> page.</p>
</div>
<div class="paragraph">
<p>Make sure Background Jobs scheduling is set to <strong>Cron</strong> and last run was within 15 minutes.</p>
</div>
<div class="paragraph">
<p>Also, on this page you can configure Email server parameters and test email delivery.</p>
</div>
</div>
<div class="sect3">
<h4 id="_access_to_nfs_share">11.4.4. Access to NFS Share</h4>
<div class="paragraph">
<p>It may be convenient to be able to access some directories that are shared with NFS from the Nextcloud.
It can be done with the &#8220;External storage support&#8221; Nextcloud app,
that allows mounting local directories inside the Nextcloud.</p>
</div>
<div class="paragraph">
<p>However, since Nextcloud is running inside a container, it is isolated from the host file system
and won&#8217;t be able to access the NFS directories unless they are explicitly mounted inside the container.</p>
</div>
<div class="paragraph">
<p>To mount some directories into the Nextcloud container,
edit the <code>/root/silverbox/containers/nextcloud/docker-compose.yml</code> file and append the directories to the
<code>volumes</code> list of the <code>nextcloud-fpm</code> service. For example:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/nextcloud/docker-compose.yml</div>
<div class="content">
<pre class="nowrap">...
nextcloud-fpm:
  ...
  volumes:
    ...
    - /srv/nfs/videos:/nfs/videos
    - /srv/nfs/photos:/nfs/photos
...</pre>
</div>
</div>
<div class="paragraph">
<p>To apply changes do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml stop
sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml kill nextcloud-fpm
sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml up -d</pre>
</div>
</div>
<div class="paragraph">
<p>To add these directories to Nextcloud navigate to <em>Settings &#8594; External Storages</em> and add two
&#8220;Local&#8221; storage entries for <code>/nfs/videos</code> and <code>/nfs/photos</code>.</p>
</div>
<div class="sect4">
<h5 id="_permissions">Permissions</h5>
<div class="paragraph">
<p>There are some permissions issues when accessing files created via NFS from the Nextcloud and vice versa.</p>
</div>
<div class="paragraph">
<p>In particular, files created inside NFS directories from the Nextcloud will be owned by <code>www-data:www-data</code> (<code>33:33</code>)
and with default <code>umask</code> will only allow modifications by the owner.
Thus, users accessing these files over NFS won&#8217;t be able to modify them.</p>
</div>
<div class="paragraph">
<p>The permissions/ownership for such files can be adjusted with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo find /srv/nfs -uid 33 -exec chown {SERVER_USER}:{NFS_SHARE_GROUP} \{} \; -exec chmod g+w {} \; -exec echo {} \;</pre>
</div>
</div>
<div class="paragraph">
<p>This example command changes ownership for all files under <code>/srv/nfs</code> directory that are currently owned by UID <code>33</code>,
to be owned by your user and <code>{NFS_SHARE_GROUP}</code> group, and also adds write permissions to the group.</p>
</div>
<div class="paragraph">
<p>There is a similar issue with the files created via NFS and accessed via Nextcloud.
Such files by default will have ownership <code>{SERVER_USER}:{SERVER_USER}</code> and won&#8217;t be modifiable by the Nextcloud
(unless your <code>umask</code> allows modification by everyone).
One way to allow modifications from the Nextcloud is to set ownership to <code>{SERVER_USER}:{NFS_SHARE_GROUP}</code>,
which can be done with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo find /srv/nfs -user $USER -group $USER -exec chgrp {NFS_SHARE_GROUP} {} \; -exec echo {} \;</pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When creating files from outside of the Nextcloud (e.g. over NFS), the files won&#8217;t be immediately visible
in the Nextcloud. Similarly, the changed permissions on such files won&#8217;t be immediately noticed by the Nextcloud.
To force Nextcloud to rescan the files use the following command:
<code>sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml exec --user www-data nextcloud-fpm php occ files:scan admin</code>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If desired, the permission correction can be automated with <code>inotify-tools</code> or similar tools</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_security_scanning">11.4.5. Security Scanning</h4>
<div class="paragraph">
<p>It may be useful to run some security scanners against the Nextcluod.
Here are some example:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Nextcloud Security Scanner</dt>
<dd>
<p><a href="https://scan.nextcloud.com" class="bare">https://scan.nextcloud.com</a>.</p>
</dd>
<dt class="hdlist1">SSL Labs Scanner</dt>
<dd>
<p><a href="https://www.ssllabs.com/ssltest" class="bare">https://www.ssllabs.com/ssltest</a>. Note that it only works over default HTTPS port 443, so to use it
you can temporary change port forwarding rule to forward from external port 443 to internal port <code>{NEXTCLOUD_PORT}</code>.</p>
</dd>
<dt class="hdlist1">ImmuniWeb SSL Scanner</dt>
<dd>
<p><a href="https://www.immuniweb.com/ssl" class="bare">https://www.immuniweb.com/ssl</a></p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="_reduce_autovacuum_frequency">11.4.6. Reduce Autovacuum Frequency</h4>
<div class="paragraph">
<p>This is completely optional step, but it may help to minimize disk writes.
In the default configuration, PostgreSQL autovacuum runs every minute,
which I find extremely excessive for my limited Nextcloud use.
Running it so frequently produces excessive disk writes by the <code>postgres: stats collector</code> process.</p>
</div>
<div class="paragraph">
<p>To reduce autovaccum frequency, edit the <code>/srv/nextcloud/db/postgresql.conf</code> file and change the
<code>autovacuum_naptime</code> parameter to desired value, for example:</p>
</div>
<div class="listingblock">
<div class="title">/srv/nextcloud/db/postgresql.conf</div>
<div class="content">
<pre class="nowrap">autovacuum_naptime = 15min</pre>
</div>
</div>
<div class="paragraph">
<p>Restart the Nextcloud database for the setting to take effect.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_7">11.5. Monitoring</h3>
<div class="paragraph">
<p>To monitor Nextcloud status with Monit create the <code>/etc/monit/conf.d/70-nextcloud</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/70-nextcloud</div>
<div class="content">
<pre class="nowrap"># Containers status
check program nextcloud_web with path "/usr/local/etc/monit/scripts/container_status.sh nextcloud-web .State.Status running"
  if status != 0 for 5 cycles then alert

check program nextcloud_fpm with path "/usr/local/etc/monit/scripts/container_status.sh nextcloud-fpm .State.Status running"
  if status != 0 for 5 cycles then alert

check program nextcloud_db with path "/usr/local/etc/monit/scripts/container_status.sh nextcloud-db .State.Status running"
  if status != 0 for 5 cycles then alert

# HTTPS &amp; Certificate check
check host nextcloud with address {NEXTCLOUD_DOMAIN} every 5 cycles <i class="conum" data-value="1"></i><b>(1)</b>
  if failed port {NEXTCLOUD_PORT} protocol https request /?monit and certificate valid &gt; 15 days for 2 cycles then alert <i class="conum" data-value="2"></i><b>(2)</b>

# Apache status
check host nextcloud_local with address {SERVER_IP_ADDR} every 5 cycles <i class="conum" data-value="3"></i><b>(3)</b>
  if failed port {NEXTCLOUD_PORT} protocol apache-status path /apache-server-status.html <i class="conum" data-value="4"></i><b>(4)</b>
    replylimit &gt; 50% or
    requestlimit &gt; 50% or
    closelimit &gt; 50% or
    gracefullimit &gt; 50% or
    waitlimit &lt; 20%
    with ssl options {verify: disable}
    for 2 cycles
  then alert</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{NEXTCLOUD_DOMAIN}</code> with the actual Nextcloud domain name.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{NEXTCLOUD_PORT}</code> with the actual value.
Also, if you changed query parameter in rewrite condition for filtering Monit logs in the <a href="#nextcloud_httpd_config">HTTPD</a> section
to some random string, replace <code>monit</code> in the <code>request /?monit</code> part with the exact same string.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{SERVER_IP_ADDR}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>{NEXTCLOUD_PORT}</code> with the actual value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart Monit and verify that Nextcloud monitoring is working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_git_server">12. Git Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to configure the server to host some private Git repositories.</p>
</div>
<div class="paragraph">
<p>Having your own private Git repositories can be very helpful for keeping configuration files organized,
notes, personal projects or forks that you prefer to keep private.
Keeping your Git repositories locally on the server (as opposed to cloud services such as Github or Gitlab)
has an advantage of being able to access them even when the cloud service or the internet connection is down.
Server backups (described in section <a href="#backup">Backup</a>) can be utilized for backing up Git repositories.</p>
</div>
<div class="sect2">
<h3 id="_overview_2">12.1. Overview</h3>
<div class="paragraph">
<p>There are many ways to host Git repositories.
One of the approaches it to host complete collaborative software development platform that usually includes
version control, issue tracking, documentation (e.g. wiki), code review, CI/CD pipelines,
fine-grained permission control etc.
Some of the popular open-source options include Gitlab, Gitea and Gogs.</p>
</div>
<div class="paragraph">
<p>However, hosting a full-blown platform like this has its disadvantages:
it increases complexity of the setup and hardware resource consumption,
requires maintenance to keep platform secure and up-to-date,
complicates configuration and "vendor-locks" you into a specific platform.
I find that extra complexity of running such platforms is hardly justified,
as for home setup most of the extra features provided are rarely needed.</p>
</div>
<div class="paragraph">
<p>Instead, this guide describes how to run bare Git repositories accessible over SSH
(that has been configured in the <a href="#openssh_server_configuration">OpenSSH Server Configuration</a> section).
This approach doesn&#8217;t depend on any third-party solutions and only requires Git and SSH to function.
It is very simple, transparent and maintenance-free.</p>
</div>
<div class="paragraph">
<p>The configuration described below is very similar to the one described in the Git Book&#8217;s section
on setting up the Git server <a href="#git_server">[18]</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_4">12.2. Configuration</h3>
<div class="paragraph">
<p>First, install <code>git</code> on the server (if you don&#8217;t have it installed already):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt update
sudo apt install git</pre>
</div>
</div>
<div class="paragraph">
<p>Create <code>gitusers</code> group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo addgroup --system gitusers</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A separate group is needed so that it would be possible to have more than just one user with access to Git repositories.
This can be helpful, for instance, if you need to provide another user access under different permissions
(for example, read-only access to repositories, as described in the next section).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a directory where all of the Git repositories will reside, and assign proper ownership and permissions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /srv/git
sudo chgrp gitusers /srv/git
sudo chmod 750 /srv/git</pre>
</div>
</div>
<div class="sect3">
<h4 id="_create_git_user_account">12.2.1. Create Git User Account</h4>
<div class="paragraph">
<p>In this model, all repositories under <code>/srv/git</code> directory will be accessible by <code>git</code> account created on the server.
To give someone read/write access to Git repositories a separate SSH key pair needs to be generated and its public key
added to <code>git</code> authorized SSH keys list.</p>
</div>
<div class="paragraph">
<p>Create <code>git</code> user account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo adduser --disabled-password --gecos "" --shell `which git-shell` git</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Having <code>git-shell</code> as the <code>git</code> user shell will only allow to execute Git related commands
over SSH and nothing else (also no SCP).
You can additionally customize the message that user will see on an attempt to SSH as the <code>git</code> user.
To do this, create executable script <code>git-shell-commands/no-interactive-login</code> under <code>git</code> user&#8217;s home directory,
that prints desired message and exits.
For more details see <a href="https://git-scm.com/docs/git-shell" class="bare">https://git-scm.com/docs/git-shell</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Make <code>git</code> user a member of the <code>gitusers</code> group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo usermod -a -G gitusers git</pre>
</div>
</div>
<div class="paragraph">
<p>Login as <code>git</code> user and create <code>.ssh</code> directory and <code>authorized_keys</code> file with proper permissions,
as well as <code>.hushlogin</code> file to suppress default Ubuntu MOTD (message of the day) banner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo su --shell $SHELL git
cd
mkdir .ssh &amp;&amp; chmod 700 .ssh
touch .ssh/authorized_keys &amp;&amp; chmod 600 .ssh/authorized_keys
touch .hushlogin
exit</pre>
</div>
</div>
<div class="paragraph">
<p>As <code>root</code> user edit the <code>/etc/ssh/sshd_config</code> file and add <code>git</code> user to the list of allowed users:</p>
</div>
<div class="listingblock">
<div class="title">/etc/ssh/sshd_config</div>
<div class="content">
<pre class="nowrap">AllowUsers {SERVER_USER} git</pre>
</div>
</div>
<div class="paragraph">
<p>Restart <code>sshd</code> service for the changes to take effect: <code>sudo systemctl restart sshd.service</code>.</p>
</div>
<div class="sect4">
<h5 id="_read_only_access">Read-Only Access</h5>
<div class="paragraph">
<p>As mentioned above, the <code>git</code> user account will have read/write access to all Git repositories on the server.
However, sometimes it might be necessary to give someone read-only access,
so that they can read (clone) from all repositories but not write (push).</p>
</div>
<div class="paragraph">
<p>One way this can be achieved is by creating one more account on the server,
for example <code>gitro</code> (where <code>ro</code> stands for read only), and adding this account to the <code>gitusers</code> group.
Since repositories are owned by the <code>git</code> user (as you will see in the next section) and not <code>gitro</code>,
the <code>gitro</code> won&#8217;t be able to write.
But because <code>gitro</code> belongs to <code>gitusers</code> group, it will be able to read.</p>
</div>
<div class="paragraph">
<p>To create such <code>gitro</code> account follow the same steps as above for creating <code>git</code> account.
You will also need to generate SSH keys for the <code>gitro</code> account in the same way as for <code>git</code> account
(as described in the sections below).</p>
</div>
<div class="paragraph">
<p>Additionally, you can put individual repositories in read-only mode for everyone by using Git server-side hooks
(such as <code>pre-receive</code> hook).
For more information on how to do this check Git documentation.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_git_repository">12.2.2. Creating Git Repository</h4>
<div class="paragraph">
<p>To create a new Git repository on the server, first create a directory for it
(the repository is called <code>example</code> in this case).
Make this directory owned by the <code>git</code> user and read-only accessible by the members of <code>gitusers</code> group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /srv/git/example
sudo chown git:gitusers /srv/git/example
sudo chmod 750 /srv/git/example</pre>
</div>
</div>
<div class="paragraph">
<p>Login as <code>git</code> user and initialize empty Git repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo su --shell $SHELL git
cd /srv/git/example
git init --bare --shared=0640 <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>--shared=0640</code> argument means that the repository will be shared in such a way
that it is writeable by owner (<code>git</code> user), and readable (and only readable) by anyone in the <code>gitusers</code> group.
See <code>man git-init</code> for more information.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_providing_access_to_git">12.2.3. Providing Access to Git</h4>
<div class="paragraph">
<p>Git over SSH uses SSH keys for authentication.
To provide access to someone to all Git repositories on the server (under either <code>git</code> or <code>gitro</code> user, if you created one),
this person&#8217;s public key must be added to the list of authorized SSH keys for the <code>git</code>
(or <code>gitro</code>, but this section will assume <code>git</code>) account.
Below is an example of how to give yourself read/write access from your client PC to all Git repositories on the server.</p>
</div>
<div class="paragraph">
<p>First, generate a new key pair on your client PC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">ssh-keygen -t ed25519 -f ~/.ssh/silverbox-git -C "Silverbox Git key"</pre>
</div>
</div>
<div class="paragraph">
<p>This will generate a pair of keys: private <code>~/.ssh/silverbox-git</code> and public <code>~/.ssh/silverbox-git.pub</code>.</p>
</div>
<div class="paragraph">
<p>Copy generated public key to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">scp ~/.ssh/silverbox-git.pub $USER@{SERVER_IP_ADDR}:.</pre>
</div>
</div>
<div class="paragraph">
<p>Login to the server as your user and run the following command to add the public key to the list of authorized keys for <code>git</code> user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo bash -c "printf '%s ' 'no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty' | cat - /home/$USER/silverbox-git.pub &gt;&gt; /home/git/.ssh/authorized_keys" <i class="conum" data-value="1"></i><b>(1)</b>
rm silverbox-git.pub</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This also disables SSH tunneling, X forwarding
(although it should be disabled in your sshd config if you followed this guide) and PTY for the <code>git</code> user.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On your client PC edit the <code>~/.ssh/config</code> file and add the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">host silverbox-git
  HostName {SERVER_IP_ADDR} <i class="conum" data-value="1"></i><b>(1)</b>
  IdentityFile ~/.ssh/silverbox-git
  User git</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace this with your server IP address or hostname.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now to clone example repository run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">git clone silverbox-git:/srv/git/example</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="reverse_proxy">13. Reverse Proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are some services described in this guide (such as Monit Web UI or Transmission Web UI)
that are internal and only intended to be accessible from inside the home (LAN) network.
In addition, you may want to install some other services, not described in the guide, which should only be accessible from inside.
As described in this guide, the suggested way of accessing such services securely (with authentication and encryption)
is by establishing an SSH tunnel to each service first, and then accessing the service over the tunnel.</p>
</div>
<div class="paragraph">
<p>While this approach works, it may become quite inconvenient to access internal services this way, especially for the larger number of services.
This section describes an alternative approach: using internal reverse proxy to provide access to all internal services in secure way.</p>
</div>
<div class="sect2">
<h3 id="_overview_3">13.1. Overview</h3>
<div class="paragraph">
<p>Below is a diagram with an overview how such reverse proxy could be deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">                                                       Silverbox Server
                                                      --------------------------------------------
                                                     |    --------                                |
monit.home.example.com ------\                       |   | Apache |---&gt; Internal Monit Addr       |
transmission.home.example.com--[HTTPS, Basic Auth]------&gt;| HTTP   |---&gt; Internal Transmission Addr|
service-a.home.example.com --/                       |   | Server |---&gt; Internal Service A Addr   |
                                                     |    --------                                |
                                                     |        |                                   |
                                                     |    {/certs}                                |
                                                     |        |                                   |
                                                     |        V                                   |
                                                     | /etc/letsencrypt - *.home.example.com      |
                                                      --------------------------------------------</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the diagram above, a path inside curly braces indicates a path as it seen inside Docker container,
while path without curly braces indicates the real path on the host file system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This diagram assumes you have domain for your home services <code>home.example.com</code> and three services:
Monit, Transmission and some hypothetical Service A (DNS names for these services need to be configured in Unbound).</p>
</div>
<div class="paragraph">
<p>Apache web server serves as HTTPS to HTTP reverse proxy, while also (optionally) performing Basic HTTP Authentication.
Wildcard Let&#8217;s Encrypt certificate for <code>*.home.example.com</code> is used for HTTPS in this example, thus allowing easy addition of services without the need to get new certificates.</p>
</div>
<div class="paragraph">
<p>This approach allows to have both authentication (using HTTP Basic Auth which is secure when used with HTTPS) and encryption (HTTPS).
The basic auth can be turned off for some services if they offer strong built-in authentication.</p>
</div>
<div class="paragraph">
<p>Additionally, the reverse proxy enables HTTP2 and adds some common security headers.</p>
</div>
<div class="paragraph">
<p>This section is completely optional, as for many people who may only have one or two services which they rarely use it maybe not worth the effort of initial configuration.
But if you plan on running many selfhosted services it may be very convenient to have such reverse proxy with easily expandable rules to add additional services.</p>
</div>
</div>
<div class="sect2">
<h3 id="_certificate">13.2. Certificate</h3>
<div class="paragraph">
<p>This section describes how to obtain and maintain wildcard certificate that the reverse proxy will use to setup HTTPS for all services
(hence the need for wildcard and not just regular certificate).</p>
</div>
<div class="paragraph">
<p>The process is very similar to what was described in the <a href="#nextcloud_certificate">Certificate</a> section for Nextcloud and it relies on that section being done.</p>
</div>
<div class="sect3">
<h4 id="_preparing_domain_name_2">13.2.1. Preparing Domain Name</h4>
<div class="paragraph">
<p>It&#8217;s assumed that the wildcard certificate will be obtained on your internal domain name <code>{INTERNAL_DOMAIN}</code>.
If this is not the case, adjust instructions below accordingly.</p>
</div>
<div class="paragraph">
<p>The individual services will be sub-domains of the <code>{INTERNAL_DOMAIN}</code>.
For example, if your <code>{INTERNAL_DOMAIN}</code> is <code>home.example.com</code> then service addresses will look like <code>service-name.home.example.com</code>.</p>
</div>
<div class="paragraph">
<p>Since it&#8217;s intended that the services will be only accessible from the internal network,
there is no need to create any public A or CNAME records for the <code>{INTERNAL_DOMAIN}</code>.</p>
</div>
<div class="paragraph">
<p>Only the TXT DNS record for the <code>_acme-challenge.{INTERNAL_DOMAIN}</code> with any value
(the value is just a placeholder and will be replaced with the actual DNS ACME challenge during
domain validation) needs to be created.</p>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_certbot_scripts_2">13.2.2. Preparing Certbot Scripts</h4>
<div class="paragraph">
<p>Create the <code>/etc/letsencrypt/renewal-hooks/post/reverse-proxy-restart.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/letsencrypt/renewal-hooks/post/reverse-proxy-restart.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"{INTERNAL_DOMAIN}"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then <i class="conum" data-value="1"></i><b>(1)</b>
    </span><span class="nb">echo</span> <span class="s2">"Restarting reverse proxy server"</span>
    docker compose <span class="nt">-f</span> /root/silverbox/containers/reverse-proxy/docker-compose.yml restart proxy
<span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"Skipping reverse proxy server restart - different domain: </span><span class="nv">$CERTBOT_DOMAIN</span><span class="s2">"</span>
<span class="k">fi</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual domain name.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This script will be executed automatically by Certbot during the renewal of a certificate,
and if the renewal is for the reverse proxy certificate it will restart reverse proxy server
to use the new certificate.</p>
</div>
<div class="paragraph">
<p>And assign the following permissions to this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 770 /etc/letsencrypt/renewal-hooks/post/reverse-proxy-restart.sh</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_test_certificate_2">13.2.3. Test Certificate</h4>
<div class="paragraph">
<p>To test that domain validation and certificate renewal works, it is possible to use Let&#8217;s Encrypt test server
to generate test (not trusted) certificate.</p>
</div>
<div class="paragraph">
<p>To get test certificate run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certonly --test-cert \
    --agree-tos \
    -m {YOUR_EMAIL_ADDR} \ <i class="conum" data-value="1"></i><b>(1)</b>
    --manual \
    --preferred-challenges=dns \
    --manual-auth-hook /root/silverbox/certbot/dns-challenge-auth.sh \
    --manual-cleanup-hook /root/silverbox/certbot/dns-challenge-cleanup.sh \
    --must-staple \
    -d *.{INTERNAL_DOMAIN} <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{YOUR_EMAIL_ADDR}</code> with the email address you wish to use for certificate generation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual domain name. The <code>*.</code> before domain name is significant - it is needed to request wildcard certificate.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This may take a while.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To view information about the generated certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certificates</pre>
</div>
</div>
<div class="paragraph">
<p>To test certificate renewal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot renew --test-cert --dry-run --cert-name {INTERNAL_DOMAIN}</pre>
</div>
</div>
<div class="paragraph">
<p>To revoke and delete the test certificate:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot revoke --test-cert --cert-name {INTERNAL_DOMAIN}</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_getting_real_certificate_2">13.2.4. Getting Real Certificate</h4>
<div class="paragraph">
<p>To get the real certificate run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo certbot certonly \
    --agree-tos \
    -m {YOUR_EMAIL_ADDR} \ <i class="conum" data-value="1"></i><b>(1)</b>
    --manual \
    --preferred-challenges=dns \
    --manual-auth-hook /root/silverbox/certbot/dns-challenge-auth.sh \
    --manual-cleanup-hook /root/silverbox/certbot/dns-challenge-cleanup.sh \
    --must-staple \
    -d *.{INTERNAL_DOMAIN} <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{YOUR_EMAIL_ADDR}</code> with the email address you wish to use for certificate generation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual domain name. The <code>*.</code> before domain name is significant - it is needed to request wildcard certificate.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_certificate_renewal_2">13.2.5. Automatic Certificate Renewal</h4>
<div class="paragraph">
<p>The certificate should be automatically renewed by the Certbot&#8217;s Systemd service.
The service should run automatically triggered by the corresponding timer.
To check the status of the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">systemctl status certbot.timer</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_5">13.3. Installation</h3>
<div class="paragraph">
<p>This section describes how to install and run the reverse proxy server.</p>
</div>
<div class="sect3">
<h4 id="_preparing_container">13.3.1. Preparing Container</h4>
<div class="paragraph">
<p>Create a directory for the reverse proxy container files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/reverse-proxy
sudo chmod 700 /root/silverbox/containers/reverse-proxy</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create the <code>docker-compose.yml</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/reverse-proxy/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">proxy</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">reverse-proxy</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">httpd:2.4.53'</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:5</span>
    <span class="na">network_mode</span><span class="pi">:</span> <span class="s">host</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
        <span class="na">max-file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/etc/letsencrypt/live/{INTERNAL_DOMAIN}:/certs/live/{INTERNAL_DOMAIN}:ro</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="pi">-</span> <span class="s">/etc/letsencrypt/archive/{INTERNAL_DOMAIN}:/certs/archive/{INTERNAL_DOMAIN}:ro</span> <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="pi">-</span> <span class="s">./httpd.conf:/usr/local/apache2/conf/httpd.conf:ro</span>
      <span class="pi">-</span> <span class="s">./htpasswd:/usr/local/apache2/.htpasswd:ro</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>2.4.53</code> with the actual latest <code>httpd</code> (Debian based) image version (can be checked at the Docker Hub).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This puts container on the host network, rather than creating bridge network.
While it may be not perfect from the isolation standpoint, it makes it very easy to proxy traffic to different services,
regardless of what interface they are listening on.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual domain name.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Same as above.</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_configuring_httpd">Configuring HTTPD</h5>
<div class="paragraph">
<p>Create the <code>/root/silverbox/containers/reverse-proxy/httpd.conf</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/reverse-proxy/httpd.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="apache"><span class="nc">Listen</span> 443

<span class="nc">LoadModule</span> mpm_event_module modules/mod_mpm_event.so
<span class="nc">LoadModule</span> authn_core_module modules/mod_authn_core.so
<span class="nc">LoadModule</span> authz_core_module modules/mod_authz_core.so
<span class="nc">LoadModule</span> authz_host_module modules/mod_authz_host.so
<span class="nc">LoadModule</span> authz_user_module modules/mod_authz_user.so
<span class="nc">LoadModule</span> auth_basic_module modules/mod_auth_basic.so
<span class="nc">LoadModule</span> authn_file_module modules/mod_authn_file.so
<span class="nc">LoadModule</span> mime_module modules/mod_mime.so
<span class="nc">LoadModule</span> log_config_module modules/mod_log_config.so
<span class="nc">LoadModule</span> env_module modules/mod_env.so
<span class="nc">LoadModule</span> headers_module modules/mod_headers.so
<span class="nc">LoadModule</span> proxy_module modules/mod_proxy.so
<span class="nc">LoadModule</span> proxy_http_module modules/mod_proxy_http.so
<span class="nc">LoadModule</span> unixd_module modules/mod_unixd.so
<span class="nc">LoadModule</span> socache_shmcb_module modules/mod_socache_shmcb.so
<span class="nc">LoadModule</span> ssl_module modules/mod_ssl.so
<span class="nc">LoadModule</span> http2_module modules/mod_http2.so

<span class="nc">User</span> www-data
<span class="nc">Group</span> www-data

<span class="nc">Protocols</span> h2 http/1.1

<span class="nc">SSLEngine</span> <span class="ss">On</span>
<span class="nc">SSLCipherSuite</span> EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH
<span class="nc">SSLHonorCipherOrder</span> <span class="ss">On</span>
<span class="nc">SSLProtocol</span> -all +TLSv1.3 +TLSv1.2
<span class="nc">SSLUseStapling</span> <span class="ss">on</span>
<span class="nc">SSLStaplingCache</span> "shmcb:/usr/local/apache2/logs/ssl_stapling(128000)"
<span class="nc">SSLSessionTickets</span> <span class="ss">Off</span>
<span class="nc">SSLSessionCache</span> "shmcb:/usr/local/apache2/logs/ssl_scache(512000)"
<span class="nc">SSLSessionCacheTimeout</span> 300
<span class="nc">SSLCertificateFile</span> /certs/live/{INTERNAL_DOMAIN}/fullchain.pem <i class="conum" data-value="1"></i><b>(1)</b>
<span class="ss">SSLCertificateKeyFile</span> /certs/live/{INTERNAL_DOMAIN}/privkey.pem

<span class="p">&lt;</span><span class="nl">Directory</span><span class="sr"> /</span><span class="p">&gt;
</span>    <span class="nc">AllowOverride</span> <span class="ss">none</span>
    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Directory</span><span class="p">&gt;
</span>
<span class="nc">DocumentRoot</span> "/usr/local/apache2/htdocs"

<span class="nc">Header</span> <span class="ss">always</span> <span class="ss">set</span> Strict-Transport-Security "max-age=15552000; includeSubDomains; preload" <i class="conum" data-value="2"></i><b>(2)</b>
<span class="ss">Header</span> <span class="ss">always</span> <span class="ss">set</span> X-Frame-Options "DENY"
<span class="nc">Header</span> <span class="ss">always</span> <span class="ss">set</span> X-Content-Type-Options "nosniff"
<span class="nc">Header</span> <span class="ss">always</span> <span class="ss">set</span> X-XSS-Protection "1; mode=block"

<span class="nc">RequestHeader</span> <span class="ss">set</span> X-Forwarded-Proto "https"

<span class="c"># Monit</span>
<span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:443</span><span class="p">&gt;
</span>    <span class="nc">ServerName</span> monit.{INTERNAL_DOMAIN} <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="ss">ProxyPass</span>        "/" "http://127.0.0.1:{MONIT_PORT}/" <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="ss">ProxyPassReverse</span> "/" "http://127.0.0.1:{MONIT_PORT}/"
    <span class="p">&lt;</span><span class="nl">Proxy</span><span class="sr"> *</span><span class="p">&gt;
</span>        <span class="nc">Authtype</span> <span class="ss">Basic</span>
        <span class="nc">Authname</span> "Authentication required"
        <span class="nc">AuthUserFile</span> /usr/local/apache2/.htpasswd
        <span class="nc">Require</span> valid-user
    <span class="p">&lt;/</span><span class="nl">Proxy</span><span class="p">&gt;
&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span>
<span class="c"># Transmission</span>
<span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:443</span><span class="p">&gt;
</span>    <span class="nc">ServerName</span> transmission.{INTERNAL_DOMAIN} <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="ss">ProxyPass</span>        "/" "http://127.0.0.1:{TRANSMISSION_UI_PORT}/" <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="ss">ProxyPassReverse</span> "/" "http://127.0.0.1:{TRANSMISSION_UI_PORT}/"
    <span class="p">&lt;</span><span class="nl">Proxy</span><span class="sr"> *</span><span class="p">&gt;
</span>        <span class="nc">Authtype</span> <span class="ss">Basic</span>
        <span class="nc">Authname</span> "Authentication required"
        <span class="nc">AuthUserFile</span> /usr/local/apache2/.htpasswd
        <span class="nc">Require</span> valid-user
    <span class="p">&lt;/</span><span class="nl">Proxy</span><span class="p">&gt;
&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;
</span>
<span class="p">&lt;</span><span class="nl">Files</span><span class="sr"> ".ht*"</span><span class="p">&gt;
</span>    <span class="nc">Require</span> <span class="ss">all</span> denied
<span class="p">&lt;/</span><span class="nl">Files</span><span class="p">&gt;
</span>
<span class="nc">ErrorLog</span> /proc/self/fd/2
<span class="nc">LogLevel</span> warn
<span class="nc">LogFormat</span> "%h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
<span class="nc">LogFormat</span> "%h %l %u %t \"%r\" %&gt;s %b" common
<span class="nc">CustomLog</span> /proc/self/fd/1 common env=!dont_log

<span class="nc">Include</span> conf/extra/httpd-mpm.conf

<span class="nc">ServerTokens</span> Prod
<span class="nc">TraceEnable</span> <span class="ss">off</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> in this and next line with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This and next three lines add some of the standard security-related headers for all proxied services.
Feel free to customize this.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>{MONIT_PORT}</code> in this and next line with the actual port number you&#8217;ve chosen for Monit UI.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Replace <code>{SB_TRANSMISSION_PORT}</code> in this and next line with the actual port number you&#8217;ve chosen for Transmission UI.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to add additional services to the proxy, it can be done in the similar manner, by adding <code>VirtualHost</code> block for each service.</p>
</div>
</div>
<div class="sect4">
<h5 id="_adding_users">Adding Users</h5>
<div class="paragraph">
<p>Install the <code>apache2-utils</code> package that contains <code>htpasswd</code> utility that is needed to generate file containing users and hashed passwords:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install apache2-utils</pre>
</div>
</div>
<div class="paragraph">
<p>Create the users database file, initially containing one user (you will be prompted for user&#8217;s password):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo htpasswd -B -c /root/silverbox/containers/reverse-proxy/htpasswd {USERNAME} <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{USERNAME}</code> with the actual desired username.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To add more users, refer to <code>htpasswd</code> documentation <a href="#htpasswd">[19]</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_firewall_rule_4">13.3.2. Adding Firewall Rule</h4>
<div class="paragraph">
<p>To add Firewall rule to allow accessing the reverse proxy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo ufw allow proto tcp to any port 443 comment "Reverse proxy"</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_dns">13.3.3. Configuring DNS</h4>
<div class="paragraph">
<p>This part assumes you have configured local DNS zone as described in <a href="#nfs_configuring_dns">Configuring Local DNS Zone</a>.</p>
</div>
<div class="paragraph">
<p>To add DNS records for the services that go through the reverse proxy edit the
<code>/etc/unbound/unbound.conf.d/dns-config.conf</code> file and add <code>local-data</code> record
pointing to the server IP <code>{SERVER_IP_ADDR}</code> for each service you want to proxy.</p>
</div>
<div class="paragraph">
<p>Below are example records for Monit and Transmission:</p>
</div>
<div class="listingblock">
<div class="title">/etc/unbound/unbound.conf.d/dns-config.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">server</span><span class="pi">:</span>
 <span class="na">local-data</span><span class="pi">:</span> <span class="s2">"</span><span class="s">monit.{INTERNAL_DOMAIN}.</span><span class="nv">        </span><span class="s">IN</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">{SERVER_IP_ADDR}"</span> <i class="conum" data-value="1"></i><b>(1)</b>
 <span class="na">local-data</span><span class="pi">:</span> <span class="s2">"</span><span class="s">transmission.{INTERNAL_DOMAIN}.</span><span class="nv"> </span><span class="s">IN</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">{SERVER_IP_ADDR}"</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this and the next line replace <code>{INTERNAL_DOMAIN}</code> and <code>{SERVER_IP_ADDR}</code> with the actual values.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart the Unbound server to apply the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart unbound.service</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_reverse_proxy_server">13.3.4. Running Reverse Proxy Server</h4>
<div class="paragraph">
<p>To start the reverse proxy server do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/reverse-proxy/docker-compose.yml up -d</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_container_startup_3">13.3.5. Automatic Container Startup</h4>
<div class="paragraph">
<p>To start the reverse proxy container automatically on boot create the
<code>/etc/systemd/system/reverse-proxy-start.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/reverse-proxy-start.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Start Apache Reverse Proxy
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker compose -f /root/silverbox/containers/reverse-proxy/docker-compose.yml up -d

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
<div class="paragraph">
<p>Enable the service, so that it will be started on system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable reverse-proxy-start.service</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_8">13.4. Monitoring</h3>
<div class="paragraph">
<p>To monitor the reverse proxy server with Monit create the <code>/etc/monit/conf.d/70-reverse-proxy</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/70-reverse-proxy</div>
<div class="content">
<pre class="nowrap"># Container status
check program reverse_proxy with path "/usr/local/etc/monit/scripts/container_status.sh reverse-proxy .State.Status running"
  if status != 0 for 5 cycles then alert

# HTTPS &amp; Certificate check
check host reverse_proxy_monit with address monit.{INTERNAL_DOMAIN} every 5 cycles <i class="conum" data-value="1"></i><b>(1)</b>
  if failed port 443 protocol https request / status = 401 and certificate valid &gt; 15 days for 2 cycles then alert <i class="conum" data-value="2"></i><b>(2)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual value.
In this example, Monit UI host is used to check the certificate.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Port 443 is used here, change it if you used different port for the proxy.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart Monit and verify that the reverse proxy monitoring is working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_firefly_iii">14. Firefly III</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to install and configure Firefly III (open source personal finances manager) <a href="#firefly">[20]</a> on the server.</p>
</div>
<div class="paragraph">
<p>This section depends on the following sections: <a href="#docker">Docker</a>, <a href="#domain_name">Domain Name</a>, <a href="#reverse_proxy">Reverse Proxy</a>.</p>
</div>
<div class="sect2">
<h3 id="_overview_4">14.1. Overview</h3>
<div class="paragraph">
<p>The Firefly III will be deployed using Docker Compose with two Docker containers:
one is the database (PostgreSQL) and the other is the official Firefly III container
(which contains Apache web server and PHP application server).</p>
</div>
<div class="paragraph">
<p>Below is a diagram that shows high level overview of the Firefly III deployment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">firefly.home.example.com
    |                        Firefly III Docker Network
    |                      --------------------------------------------------------
    |                     |            ------------             ------------       |
    | HTTPS   ---------   |   HTTP    |            | 5432/tcp  |            |      |
    \-------&gt;| Reverse |-------------&gt;| Firefly III|----------&gt;| PostgreSQL |      |
             |  Proxy  |  |           |            |           |            |      |
              ---------   |            ------------             ------------       |
                          |                  |                       |             |
                          |   {/var/www/html/storage/upload}         |             |
                          |                  |          {/var/lib/postgresql/data} |
                          |                  |                       |             |
                          |                  v                       v             |
                          |        /srv/firefly/uploads       /srv/firefly/db      |
                          |                                                        |
                           --------------------------------------------------------</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this diagram <code>home.example.com</code> is used as an example value for your <code>{INTERNAL_DOMAIN}</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In the diagram above, a path inside curly braces indicates a path as it seen inside Docker container,
while path without curly braces indicates the real path on the host file system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both containers are stateless (i.e. don&#8217;t contain any important data inside the container),
since all user data is stored on the host file system and mounted inside containers.
This way containers can be safely deleted and re-deployed, which makes upgrades very easy.</p>
</div>
<div class="paragraph">
<p>In this setup, Firefly III will only be accessible from the internal network via the reverse proxy
(as configured in <a href="#reverse_proxy">Reverse Proxy</a>).
Not exposing Firefly III to the internet is a deliberate decision, partially due to security concerns,
but also for simplicity of the setup and because it seems to me that having it publicly accessible doesn&#8217;t add to much of convenience.
If you wish Firefly III to be accessible from the internet you can either implement similar setup as was done for Nextcloud,
or rely on VPN/WireGuard to get access to the internal network from the internet.</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation_6">14.2. Installation</h3>
<div class="paragraph">
<p>This section describes how to install and run Firefly III.</p>
</div>
<div class="sect3">
<h4 id="_preparing_directory_structure_3">14.2.1. Preparing Directory Structure</h4>
<div class="paragraph">
<p>The very first step is to create directories that will be mapped inside the Docker containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir -p /srv/firefly/db
sudo mkdir /srv/firefly/uploads
sudo chown 33 /srv/firefly/uploads <i class="conum" data-value="1"></i><b>(1)</b>
sudo chmod 750 -R /srv/firefly</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>33</code> is the UID of the <code>www-data</code> user inside the Firefly III container.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>All the Firefly III data (including database and uploaded files)
will be stored under the <code>/srv/firefly</code> directory in the following way:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">db</dt>
<dd>
<p>The <code>db</code> subdirectory will store PostgreSQL database files.</p>
</dd>
<dt class="hdlist1">uploads</dt>
<dd>
<p>The <code>uploads</code> subdirectory will store uploaded files.</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is important to keep <code>/src/firefly</code> directory owned by the root and have restrictive permissions
since some content inside it will be owned by the <code>www-data</code> (UID <code>33</code>) user from the Docker containers.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_images_2">14.2.2. Preparing Images</h4>
<div class="paragraph">
<p>Create a directory for Firefly III containers files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/containers/firefly
sudo chmod 700 /root/silverbox/containers/firefly</pre>
</div>
</div>
<div class="paragraph">
<p>Inside it, create the <code>docker-compose.yml</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/firefly/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3.8'</span>

<span class="na">networks</span><span class="pi">:</span>
  <span class="na">default</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">firefly</span>
    <span class="na">driver</span><span class="pi">:</span> <span class="s">bridge</span>
    <span class="na">ipam</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">subnet</span><span class="pi">:</span> <span class="pi">{</span><span class="nv">DOCKER_FIREFLY_NETWORK</span><span class="pi">}</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="na">services</span><span class="pi">:</span>
  <span class="na">firefly-db</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">firefly-db</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">postgres:14.3</span> <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:5</span>
    <span class="na">shm_size</span><span class="pi">:</span> <span class="s">256mb</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
        <span class="na">max-file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/srv/firefly/db:/var/lib/postgresql/data</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">POSTGRES_USER=firefly</span>
      <span class="pi">-</span> <span class="s">POSTGRES_PASSWORD={POSTGRES_PASSWORD}</span> <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="pi">-</span> <span class="s">POSTGRES_DB=firefly</span>
      <span class="pi">-</span> <span class="s">POSTGRES_INITDB_ARGS="--data-checksums"</span>

  <span class="na">firefly-app</span><span class="pi">:</span>
    <span class="na">container_name</span><span class="pi">:</span> <span class="s">firefly-app</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">jc5x/firefly-iii:version-5.5.13</span> <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="na">restart</span><span class="pi">:</span> <span class="s">on-failure:5</span>
    <span class="na">logging</span><span class="pi">:</span>
      <span class="na">driver</span><span class="pi">:</span> <span class="s">json-file</span>
      <span class="na">options</span><span class="pi">:</span>
        <span class="na">max-size</span><span class="pi">:</span> <span class="s">10mb</span>
        <span class="na">max-file</span><span class="pi">:</span> <span class="s1">'</span><span class="s">3'</span>
    <span class="na">depends_on</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">firefly-db</span>
    <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">/srv/firefly/uploads:/var/www/html/storage/upload</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">127.0.0.1:{FIREFLY_UI_PORT}:8080/tcp</span> <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">DB_HOST=firefly-db</span>
      <span class="pi">-</span> <span class="s">DB_PORT=5432</span>
      <span class="pi">-</span> <span class="s">DB_CONNECTION=pgsql</span>
      <span class="pi">-</span> <span class="s">DB_DATABASE=firefly</span>
      <span class="pi">-</span> <span class="s">DB_USERNAME=firefly</span>
      <span class="pi">-</span> <span class="s">DB_PASSWORD={POSTGRES_PASSWORD}</span> <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="pi">-</span> <span class="s">APP_KEY={APP_KEY}</span> <i class="conum" data-value="7"></i><b>(7)</b>
      <span class="pi">-</span> <span class="s">SITE_OWNER=mail@example.com</span> <i class="conum" data-value="8"></i><b>(8)</b>
      <span class="pi">-</span> <span class="s">TZ=America/Toronto</span> <i class="conum" data-value="9"></i><b>(9)</b>
      <span class="pi">-</span> <span class="s">TRUSTED_PROXIES=**</span>
      <span class="pi">-</span> <span class="s">APP_URL=https://firefly.{INTERNAL_DOMAIN}</span> <i class="conum" data-value="10"></i><b>(10)</b>
      <span class="pi">-</span> <span class="s">MAIL_MAILER=smtp</span> <i class="conum" data-value="11"></i><b>(11)</b>
      <span class="pi">-</span> <span class="s">MAIL_HOST=smtp.example.com</span>
      <span class="pi">-</span> <span class="s">MAIL_PORT=2525</span>
      <span class="pi">-</span> <span class="s">MAIL_FROM=changeme@example.com</span>
      <span class="pi">-</span> <span class="s">MAIL_USERNAME=foo</span>
      <span class="pi">-</span> <span class="s">MAIL_PASSWORD=bar</span>
      <span class="pi">-</span> <span class="s">MAIL_ENCRYPTION=tls</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{DOCKER_FIREFLY_NETWORK}</code> with the actual subnet you want to use for the Firefly III.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>14.3</code> with the actual latest <code>postgres</code> (Debian based) image version (can be checked at the Docker Hub).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Replace <code>{POSTGRES_PASSWORD}</code> with some random password.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Replace <code>version-5.5.13</code> with the actual latest <code>jc5x/firefly-iii</code> image version (can be checked at the Docker Hub).</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Replace <code>{FIREFLY_UI_PORT}</code> with the actual port number you chose for Firefly III.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Replace <code>{POSTGRES_PASSWORD}</code> with the same password as above.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Replace <code>{APP_KEY}</code> with random alphanumeric string exactly 32 characters long.
Such string can be obtained by running the following command: <code>head /dev/urandom | LANG=C tr -dc 'A-Za-z0-9' | head -c 32</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Replace <code>mail@example.com</code> with your email address.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Replace <code>America/Toronto</code> with your preferred timezone. To check system timezone run: <code>cat /etc/timezone</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>This block of variables refers to email delivery configuration.
Configure it accordingly to your email delivery settings.
Refer to Firefly III documentation for more information.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_running_firefly_iii">14.2.3. Running Firefly III</h4>
<div class="paragraph">
<p>To start all the containers do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/firefly/docker-compose.yml up -d</pre>
</div>
</div>
<div class="paragraph">
<p>Verify that all containers have started successfully and check logs for errors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker ps
sudo docker logs firefly-db
sudo docker logs firefly-app</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_firefly_iii_cron">14.2.4. Firefly III Cron</h4>
<div class="paragraph">
<p>Firefly III container doesn&#8217;t include cron or anything else for running periodic jobs.
Therefore a Systemd timer will be used to trigger periodic jobs for Firefly III.</p>
</div>
<div class="paragraph">
<p>Create the <code>/etc/systemd/system/firefly-iii-cron.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/firefly-iii-cron.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Run Firefly III cron jobs
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker exec --user www-data firefly-app /usr/local/bin/php /var/www/html/artisan firefly-iii:cron</pre>
</div>
</div>
<div class="paragraph">
<p>You can run the service once to verify that it runs successfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl start firefly-iii-cron.service</pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/systemd/system/firefly-iii-cron.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/firefly-iii-cron.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Run Firefly III cron jobs

[Timer]
OnBootSec=15min <i class="conum" data-value="1"></i><b>(1)</b>
OnCalendar=daily <i class="conum" data-value="2"></i><b>(2)</b>

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>First time the timer runs 15 minutes after boot.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>After first run, the timer will run daily, as suggested in the Firefly III documentation.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable firefly-iii-cron.timer
sudo systemctl start firefly-iii-cron.timer</pre>
</div>
</div>
<div class="paragraph">
<p>You can do <code>sudo systemctl list-timers</code> to verify that the timer appears in the output and to check the time till next activation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_containers_startup_2">14.2.5. Automatic Containers Startup</h4>
<div class="paragraph">
<p>To start containers automatically (in the correct order)
on boot create the <code>/etc/systemd/system/firefly-start.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/firefly-start.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Start Firefly III
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker compose -f /root/silverbox/containers/firefly/docker-compose.yml up -d

[Install]
WantedBy=multi-user.target</pre>
</div>
</div>
<div class="paragraph">
<p>Enable the service, so that it will be started on system boot:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable firefly-start.service</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_dns_record">14.2.6. Adding DNS Record</h4>
<div class="paragraph">
<p>To add internal DNS record for the Firefly III edit the
<code>/etc/unbound/unbound.conf.d/dns-config.conf</code> file and add <code>local-data</code> record
pointing to the server IP <code>{SERVER_IP_ADDR}</code>:</p>
</div>
<div class="listingblock">
<div class="title">/etc/unbound/unbound.conf.d/dns-config.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">local-data</span><span class="pi">:</span> <span class="s2">"</span><span class="s">firefly.{INTERNAL_DOMAIN}.</span><span class="nv"> </span><span class="s">IN</span><span class="nv"> </span><span class="s">A</span><span class="nv"> </span><span class="s">{SERVER_IP_ADDR}"</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this and the next line replace <code>{INTERNAL_DOMAIN}</code> and <code>{SERVER_IP_ADDR}</code> with the actual values.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart the Unbound server to apply the changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl restart unbound.service</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_adding_reverse_proxy_configuration">14.2.7. Adding Reverse Proxy Configuration</h4>
<div class="paragraph">
<p>To add Firefly III to the reverse proxy configuration edit the <code>/root/silverbox/containers/reverse-proxy/httpd.conf</code> file
and add the following <code>VirtualHost</code> section to it:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/reverse-proxy/httpd.conf</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="apache"><span class="c"># Firefly III</span>
<span class="p">&lt;</span><span class="nl">VirtualHost</span><span class="sr"> *:443</span><span class="p">&gt;
</span>    <span class="nc">ServerName</span> firefly.{INTERNAL_DOMAIN} <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="ss">ProxyPass</span>        "/" "http://127.0.0.1:{FIREFLY_UI_PORT}/" <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="ss">ProxyPassReverse</span> "/" "http://127.0.0.1:{FIREFLY_UI_PORT}/"
<span class="p">&lt;/</span><span class="nl">VirtualHost</span><span class="p">&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{INTERNAL_DOMAIN}</code> with the actual value.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{FIREFLY_UI_PORT}</code> in this and next line with the actual port number you&#8217;ve chosen for the Firefly III.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This <code>VirtualHost</code> section above doesn&#8217;t include basic authentication configuration.
This is deliberate, as Firefly III has its own authentication.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart reverse proxy container to pick up new changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker restart reverse-proxy</pre>
</div>
</div>
<div class="paragraph">
<p>You should now be able to access Firefly III at <code><a href="https://firefly.{INTERNAL_DOMAIN}" class="bare">https://firefly.{INTERNAL_DOMAIN}</a></code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_9">14.3. Monitoring</h3>
<div class="paragraph">
<p>To monitor Firefly III status with Monit create the <code>/etc/monit/conf.d/70-firefly</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/70-firefly</div>
<div class="content">
<pre class="nowrap"># Containers status
check program firefly_app with path "/usr/local/etc/monit/scripts/container_status.sh firefly-app .State.Status running"
  if status != 0 for 5 cycles then alert

check program firefly_db with path "/usr/local/etc/monit/scripts/container_status.sh firefly-db .State.Status running"
  if status != 0 for 5 cycles then alert

# HTTP
check host firefly with address localhost every 5 cycles
  if failed port {FIREFLY_UI_PORT} protocol http request / status = 302 for 2 cycles then alert <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{FIREFLY_UI_PORT}</code> with the actual value.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart Monit and verify that Firefly III monitoring is working.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="backup">15. Backup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to configure secure automatic backup of valuable files
from the server to external drive and to the cloud.</p>
</div>
<div class="sect2">
<h3 id="_overview_5">15.1. Overview</h3>
<div class="paragraph">
<p>Below is a diagram that describes the general backup strategy for the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">    Silverbox
  --------------             On-Site Backup         Off-Site Backup
 |  ----------  |              ----------           ----------------
 | | Internal | | Borg Backup | External | Rclone  |  Cloud (OVH)   |
 | |  Drive   |--------------&gt;|  Drive   |--------&gt;| Object Storage |
 |  ----------  |    (1)       ----------    (2)    ----------------
  --------------</pre>
</div>
</div>
<div class="paragraph">
<p>As this diagram shows, the backup process consists of two steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the first step all valuable information backed up using Borg Backup <a href="#borgbackup">[14]</a>
to an external drive that is connected via USB.
This step includes de-duplication, compression and encryption.</p>
</li>
<li>
<p>In the second step backup is synced from the external drive to the OVH cloud object storage <a href="#ovh_object_storage">[15]</a>
using Rclone tool <a href="#rclone">[16]</a>.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While this guide uses OVH cloud, it is possible to use any other cloud that is supported by the Rclone tool.
The only difference will be in Rclone configuration but the main process will be the same.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this model, data leaves the server already encrypted
and thus can be safely stored on an unencrypted external disk and in public cloud.</p>
</div>
<div class="paragraph">
<p>In the case of main drive failure, the data can be restored from the external drive.
In the case of total failure of main and external drives simultaneously, the data can be restored from the cloud.</p>
</div>
</div>
<div class="sect2">
<h3 id="_disk_preparation">15.2. Disk Preparation</h3>
<div class="paragraph">
<p>The first step is to partition and format the external drive in <code>ext4</code> filesystem.
There are plenty of excellent guides available online so these steps are out of scope of this document.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Setting up <code>dmcrypt</code>, <code>ecryptfs</code> or other encryption solutions on this drive is not necessary,
since backup files will be already encrypted. But you may still do it if you want.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_automatic_disk_mount">15.2.1. Automatic Disk Mount</h4>
<div class="paragraph">
<p>Once partitioned and formatted, connect the disk to the server.</p>
</div>
<div class="paragraph">
<p>Identify what name was assigned to the disk and partition by either looking at <code>dmesg | tail</code>
output right after the disk was connected, or by looking at the output of <code>lsblk</code> command.</p>
</div>
<div class="paragraph">
<p>For example, the following output indicates that the device name is <code>sdb</code> and partition name is <code>sdb1</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">$ lsblk
<em>sdb                        8:00   0 465.8G  0 disk</em>
<em>└─sdb1                     8:00   0 442.4G  0 part</em></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to get the UUID of the partition from the output of <code>blkid</code> command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">&gt; sudo blkid /dev/sdb1 <i class="conum" data-value="1"></i><b>(1)</b>
<em>/defv/sdb1: LABEL="label" UUID="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" TYPE="ext4" PARTUUID="XXXXXXX"</em></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/dev/sdb1</code> with the partition device name from the previous step.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Create a directory where the partition will be mounted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /mnt/backup</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, add the following line to the <code>/etc/fstab</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">UUID=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX /mnt/backup ext4 auto,lazytime,nodev,nofail,errors=remount-ro 0 2 <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX</code> with the actual UUID value.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this example, mount options include <code>lazytime</code> option, which is not necessary if you use HDD drive
instead of SSD and can be removed in this case.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Reboot the system and confirm that the backup partition was automatically mounted under <code>/mnt/backup</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">&gt; lsblk
<em>sda                        8:0    0 465.8G  0 disk</em>
<em>└─sda1                     8:1    0 442.4G  0 part  /mnt/backup</em></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The device name (i.e. <code>/dev/sda</code>) can be different after reboot.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_trim_2">15.2.2. TRIM</h4>
<div class="paragraph">
<p>While TRIM should automatically work on all mounted drives that support it (thanks to default <code>fstrim.service</code>),
it most likely will not work on drives connected via USB due to issues with USB &lt;&gt; SATA commands translation.</p>
</div>
<div class="paragraph">
<p>If your drive supports TRIM you can check whether it works by doing <code>sudo fstrim /mnt/backup</code>,
but most likely you&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">fstrim: /mnt/backup: the discard operation is not supported</pre>
</div>
</div>
<div class="paragraph">
<p>Unfortunately, it looks like there is no way to fix this issue at the moment.
However, TRIM support is not critical for backup drive as maximum write performance is not very important in this case.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_5">15.3. Configuration</h3>
<div class="paragraph">
<p>This section describes how to install all the necessary software and configure backup to the external drive and to the cloud.</p>
</div>
<div class="sect3">
<h4 id="_borg_backup">15.3.1. Borg Backup</h4>
<div class="paragraph">
<p>Borg backup will be used to backup valuable files from the server to the external drive.</p>
</div>
<div class="sect4">
<h5 id="_installation_7">Installation</h5>
<div class="paragraph">
<p>Borg backup can be installed directly from the repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install borgbackup</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_backup_repository_creation">Backup Repository Creation</h5>
<div class="paragraph">
<p>Borg backups files to what it calls repository, which is essentially a directory on disk.</p>
</div>
<div class="paragraph">
<p>Initialize a new empty Borg repository on the external drive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo borg init --encryption=repokey /mnt/backup/borgrepo</pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll be prompted for a passphrase that will be used to generate encryption key for the backups.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Store this passphrase somewhere outside of the server,
so that it can be used to decrypt backups in the case of total server failure.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_automatic_backup_creation">Automatic Backup Creation</h5>
<div class="paragraph">
<p>Create a directory where backup related scripts will be stored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo mkdir /root/silverbox/backup
sudo chmod 700 /root/silverbox/backup</pre>
</div>
</div>
<div class="paragraph">
<p>Create the <code>/root/silverbox/backup/backup.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/backup/backup.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="k">if </span>pidof <span class="nt">-x</span> borg <span class="o">&gt;</span>/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"borg is already running"</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">OCC_OUTPUT</span><span class="o">=</span><span class="si">$(</span>docker <span class="nb">exec</span> <span class="nt">--user</span> www-data nextcloud-fpm php occ maintenance:mode<span class="si">)</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="nt">-ne</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"failed to check if Nextcloud is already in maintenance mode"</span>
    <span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">!</span> <span class="nb">printf</span> <span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$OCC_OUTPUT</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"Maintenance mode is currently disabled"</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"unexpected occ output: </span><span class="nv">$OCC_OUTPUT</span><span class="s2">"</span>
    <span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">!</span> docker <span class="nb">exec</span> <span class="nt">--user</span> www-data nextcloud-fpm php occ maintenance:mode <span class="nt">--on</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"failed to enable Nextcloud maintenance mode"</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">BORG_PASSPHRASE</span><span class="o">=</span><span class="s1">'{BORG_PASSPHRASE}'</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="c"># Create backup</span>
borg create <span class="nt">-v</span> <span class="nt">--stats</span> /mnt/backup/borgrepo::<span class="s1">'{hostname}-{now:%Y-%m-%d}'</span> <span class="se">\ </span><i class="conum" data-value="2"></i><b>(2)</b>
    /etc/letsencrypt/archive <span class="se">\ </span><i class="conum" data-value="3"></i><b>(3)</b>
    /srv/nextcloud <span class="se">\</span>
    /srv/nfs <span class="se">\</span>
    /srv/git <span class="se">\</span>
    /srv/firefly <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nfs/torrents'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nextcloud/html'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nextcloud/data/*.log'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nextcloud/data/*/preview'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nextcloud/db/*.pid'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nextcloud/db/*.opts'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/nextcloud/db/pg_stat_tmp'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/firefly/db/*.pid'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/firefly/db/*.opts'</span> <span class="se">\</span>
    <span class="nt">--exclude</span> <span class="s1">'/srv/firefly/db/pg_stat_tmp'</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="nt">-ne</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"borg create failed"</span>
    <span class="nb">exit </span>2
<span class="k">fi

if</span> <span class="o">!</span> docker <span class="nb">exec</span> <span class="nt">--user</span> www-data nextcloud-fpm php occ maintenance:mode <span class="nt">--off</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"failed to disable Nextcloud maintenance mode"</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># Prune old backups</span>
borg prune <span class="nt">-v</span> <span class="nt">--list</span> /mnt/backup/borgrepo <span class="nt">--keep-daily</span><span class="o">=</span>3 <span class="nt">--keep-weekly</span><span class="o">=</span>4 <span class="nt">--keep-monthly</span><span class="o">=</span>6 <i class="conum" data-value="4"></i><b>(4)</b>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="nt">-ne</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"borg prune failed"</span>
    <span class="nb">exit </span>3
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"backup completed"</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>{BORG_PASSPHRASE}</code> to your Borg passphrase.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Feel free to adjust the mask controlling how backups will be names.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This list of what to backup is just an example, adjust it according to your needs.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Feel free to adjust backup retention settings according to your needs.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mark this file as executable and only accessible by root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 700 /root/silverbox/backup/backup.sh</pre>
</div>
</div>
<div class="paragraph">
<p>To run backup script automatically on a schedule a Systemd timer is used.
Create the <code>/etc/systemd/system/borg-backup.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/borg-backup.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Create backup using Borg backup

[Service]
Type=oneshot
ExecStart=/bin/sh -c "/root/silverbox/backup/backup.sh"</pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/systemd/system/borg-backup.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/borg-backup.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Create backup using Borg backup

[Timer]
OnCalendar=*-*-* 00:00:00 <i class="conum" data-value="1"></i><b>(1)</b>
AccuracySec=1h
Persistent=true

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this configuration backup is created daily at midnight.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable borg-backup.timer
sudo systemctl start borg-backup.timer</pre>
</div>
</div>
<div class="paragraph">
<p>To create the first backup and verify that everything works run the service manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl start borg-backup.service</pre>
</div>
</div>
<div class="paragraph">
<p>The first backup creation may take very long time.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_rclone">15.3.2. Rclone</h4>
<div class="paragraph">
<p>Rclone is a tool that can synchronize local files with remote cloud storage.
In this deployment it is used to sync backup files generated by Borg to remote cloud storage.</p>
</div>
<div class="paragraph">
<p>The prerequisite to this section is to have cloud storage configured and ready for use.
I chose to use OVH object storage, but you can chose any storage that is supported by Rclone
(list of supported storages available on Rclone website, see link in the references section).</p>
</div>
<div class="sect4">
<h5 id="_installation_8">Installation</h5>
<div class="paragraph">
<p>Rclone can be installed directly from the repositories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install rclone</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_storage_configuration">Storage Configuration</h5>
<div class="paragraph">
<p>After installation, Rclone needs to be configured to work with your cloud storage.
This can either be done by running <code>rclone config</code>
or by putting configuration into the <code>/root/.config/rclone/rclone.conf</code> file.</p>
</div>
<div class="paragraph">
<p>Since the configuration depends on what cloud provider you use, it is not described in this document.
For OVH, there is a helpful article mentioned in the references to this section.</p>
</div>
<div class="paragraph">
<p>Once Rclone is configured, you can test that it has access to the storage by doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo rclone ls {REMOTE_STORAGE}:{STORAGE_PATH} -v <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{REMOTE_STORAGE}</code> and <code>{STORAGE_PATH}</code> with remote storage that you configured and path respectively.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_automatic_backup_sync">Automatic Backup Sync</h5>
<div class="paragraph">
<p>Create the <code>/root/silverbox/backup/sync.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/backup/sync.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="k">if </span>pidof <span class="nt">-x</span> borg <span class="o">&gt;</span>/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"borg is already running"</span>
    <span class="nb">exit </span>1
<span class="k">fi

if </span>pidof <span class="nt">-x</span> rclone <span class="o">&gt;</span>/dev/null<span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"rclone is already running"</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">export </span><span class="nv">BORG_PASSPHRASE</span><span class="o">=</span><span class="s1">'{BORG_PASSPHRASE}'</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="c"># Check backup for consistency before syncing to the cloud</span>
borg check <span class="nt">-v</span> /mnt/backup/borgrepo

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="nt">-ne</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"borg check failed"</span>
    <span class="nb">exit </span>2
<span class="k">fi</span>

<span class="c"># Sync backup</span>
rclone <span class="nt">-v</span> <span class="nb">sync</span> /mnt/backup/borgrepo <span class="o">{</span>REMOTE_STORAGE<span class="o">}</span>:<span class="o">{</span>STORAGE_PATH<span class="o">}</span> <i class="conum" data-value="2"></i><b>(2)</b>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$?</span><span class="s2">"</span> <span class="nt">-ne</span> <span class="s2">"0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"rclone sync failed"</span>
    <span class="nb">exit </span>3
<span class="k">fi

</span><span class="nb">echo</span> <span class="s2">"backup sync completed"</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set <code>{BORG_PASSPHRASE}</code> to your Borg passphrase.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace <code>{REMOTE_STORAGE}</code> and <code>{STORAGE_PATH}</code> with the actual values.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Mark this file as executable and only accessible by root:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 700 /root/silverbox/backup/sync.sh</pre>
</div>
</div>
<div class="paragraph">
<p>To run backup sync script automatically on a schedule a Systemd timer is used.
Create the <code>/etc/systemd/system/sync-backup.service</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/sync-backup.service</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Sync backup files to the cloud

[Service]
Type=oneshot
ExecStart=/bin/sh -c "/root/silverbox/backup/sync.sh"</pre>
</div>
</div>
<div class="paragraph">
<p>Next, create the <code>/etc/systemd/system/sync-backup.timer</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/systemd/system/sync-backup.timer</div>
<div class="content">
<pre class="nowrap">[Unit]
Description=Sync backup files to the cloud

[Timer]
OnCalendar=Mon *-*-* 03:00:00 <i class="conum" data-value="1"></i><b>(1)</b>
AccuracySec=1h
Persistent=true

[Install]
WantedBy=timers.target</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In this configuration backup is synced every Monday at 3 am.
The reason sync is done only once a week is to save some bandwidth and data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Enable and start the timer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl daemon-reload
sudo systemctl enable sync-backup.timer
sudo systemctl start sync-backup.timer</pre>
</div>
</div>
<div class="paragraph">
<p>To run the initial sync and verify that everything works run the service manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl start sync-backup.service</pre>
</div>
</div>
<div class="paragraph">
<p>The first sync may take very long time (depending on your internet bandwidth and backup size).</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_10">15.4. Monitoring</h3>
<div class="paragraph">
<p>The monitoring for backups consists of three parts: monitoring backup disk status (space use, temperature, health),
monitoring Borg service status and monitoring Rclone service status.</p>
</div>
<div class="sect3">
<h4 id="_backup_disk_monitoring">15.4.1. Backup Disk Monitoring</h4>
<div class="paragraph">
<p>The backup disk monitoring can be done exactly the same way as the main disk monitoring,
as described in <a href="#basic_system_monitoring">Basic System Monitoring</a> section (assuming your disk has temperature sensor).
However, my disk wasn&#8217;t in the <code>hddtemp</code> database so it had to be added manually.</p>
</div>
<div class="paragraph">
<p>First check if the disk is supported by <code>smartctl</code> and if any extra parameters has to be added
(in the case of my disk the <code>-d sat</code> extra parameter has to be passed to <code>smartctl</code>).
For the list of USB disks supported by <code>smartctl</code> see the references section.</p>
</div>
<div class="paragraph">
<p>To find in what field disk reports temperature check the output of:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo smartctl -a -d sat /dev/sda <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/dev/sda</code> with your backup disk device.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then append the following line to the <code>/etc/hddtemp.db</code> file:</p>
</div>
<div class="listingblock">
<div class="title">/etc/hddtemp.db</div>
<div class="content">
<pre class="nowrap">"Samsung Portable SSD T5" 190 C "Samsung Portable SSD T5 500GB" <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace disk name with the name as it was reported by <code>smartctl</code>
and replace <code>190</code> with the temperature field number.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To monitor backup disk with Monit, append the following to the <code>/etc/monit/conf.d/10-system</code> file:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/10-system</div>
<div class="content">
<pre class="nowrap"># Backup Filesystem
check filesystem backupfs with path /mnt/backup
    if space usage &gt; 70% then alert
    if inode usage &gt; 60% then alert
    if read rate &gt; 2 MB/s for 10 cycles then alert
    if write rate &gt; 1 MB/s for 30 cycles then alert

# Backup disk temperature
check program backup_disk_temp with path "/usr/local/etc/monit/scripts/disk_temp.sh {PART_UUID}" <i class="conum" data-value="1"></i><b>(1)</b>
    if status &gt; 60 then alert
    if status &lt; 15 then alert</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>{PART_UUID}</code> with your backup partition UUID.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Restart Monit with <code>sudo systemctl restart monit</code> and verify that monitoring works.</p>
</div>
<div class="paragraph">
<p>Additionally, you can add backup disk temperature and health status reporting to the summary email
(see <a href="#email_content_generation">Email Content Generation</a> section).
Copy the lines for main disk status reporting and replace UUID with your backup disk UUID.
Don&#8217;t forget to add extra parameters to <code>smartctl</code> command if needed (e.g. <code>-d sat</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="_borg_rclone_monitoring">15.4.2. Borg &amp; Rclone Monitoring</h4>
<div class="paragraph">
<p>To monitor status of Borg and Rclone services,
create the <code>/etc/monit/conf.d/80-backup</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/etc/monit/conf.d/80-backup</div>
<div class="content">
<pre class="nowrap">check program borg_backup with path "/usr/local/etc/monit/scripts/is_systemd_unit_failed.sh borg-backup.service" every 60 cycles
  if status != 0 for 2 cycles then alert

check program sync_backup with path "/usr/local/etc/monit/scripts/is_systemd_unit_failed.sh sync-backup.service" every 60 cycles
  if status != 0 for 2 cycles then alert</pre>
</div>
</div>
<div class="paragraph">
<p>Restart Monit to update the rules and verify that monitoring works.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_restore_procedure">15.5. Restore Procedure</h3>
<div class="paragraph">
<p>The exact restore procedures depend on the type of failure that occurred.</p>
</div>
<div class="paragraph">
<p>To get files from the cloud, use <code>rclone</code> tool or download files manually.</p>
</div>
<div class="paragraph">
<p>To extract particular backup from the Borg repository use <code>borg extract</code> command.</p>
</div>
<div class="paragraph">
<p>Normally, the restored files can be just copied over lost or damaged files.
For more details, please refer to references section below.</p>
</div>
</div>
<div class="sect2">
<h3 id="_references">15.6. References</h3>
<div class="ulist">
<ul>
<li>
<p>Borg documentation: <a href="https://borgbackup.readthedocs.io/en/stable/index.html" class="bare">https://borgbackup.readthedocs.io/en/stable/index.html</a></p>
</li>
<li>
<p>Rclone documentation: <a href="https://rclone.org/docs" class="bare">https://rclone.org/docs</a></p>
</li>
<li>
<p>Article on configuring Rclone with OVH object storage: <a href="https://docs.ovh.com/ca/en/storage/sync-rclone-object-storage" class="bare">https://docs.ovh.com/ca/en/storage/sync-rclone-object-storage</a></p>
</li>
<li>
<p>Article on using Borg and Rclone for backup: <a href="https://opensource.com/article/17/10/backing-your-machines-borg" class="bare">https://opensource.com/article/17/10/backing-your-machines-borg</a></p>
</li>
<li>
<p>Nextcloud documentation on restoring from backup: <a href="https://docs.nextcloud.com/server/latest/admin_manual/maintenance/restore.html" class="bare">https://docs.nextcloud.com/server/latest/admin_manual/maintenance/restore.html</a></p>
</li>
<li>
<p>USB disks supported by <code>smartctl</code>: <a href="https://www.smartmontools.org/wiki/Supported_USB-Devices" class="bare">https://www.smartmontools.org/wiki/Supported_USB-Devices</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_maintenance">16. Maintenance</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section describes some basic maintenance procedures that will hopefully help to keep the server up to date,
healthy and running.
However, don&#8217;t consider this to be a complete checklist.</p>
</div>
<div class="sect2">
<h3 id="_keeping_system_up_to_date">16.1. Keeping System Up to Date</h3>
<div class="paragraph">
<p>This section describes how to keep the system and services running on it up-to-date.</p>
</div>
<div class="sect3">
<h4 id="_ubuntu">16.1.1. Ubuntu</h4>
<div class="paragraph">
<p>Ubuntu will install security updates automatically, but other updates have to be installed manually.</p>
</div>
<div class="paragraph">
<p>To update package information database do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt update</pre>
</div>
</div>
<div class="paragraph">
<p>To install all available upgrades do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt upgrade</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Some upgrades may require system reboot.
To check if system reboot is required, check if the file <code>/var/run/reboot-required</code> exists,
for example with <code>ls /var/run/reboot-required</code> command.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_docker_docker_compose">16.1.2. Docker &amp; Docker Compose</h4>
<div class="paragraph">
<p>Docker engine will be updated as part of the regular Ubuntu packages update.</p>
</div>
<div class="paragraph">
<p>To update Docker Compose, first check what is the current installed version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">docker compose version</pre>
</div>
</div>
<div class="paragraph">
<p>Next, check what is the latest release version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">curl --silent https://api.github.com/repos/docker/compose/releases/latest | grep tag_name</pre>
</div>
</div>
<div class="paragraph">
<p>If newer version available, it can be installed the same way as described in the <a href="#docker_compose_install">Docker Compose</a> section.</p>
</div>
</div>
<div class="sect3">
<h4 id="_docker_images">16.1.3. Docker Images</h4>
<div class="paragraph">
<p>The first step is to check if newer Docker images (including base images) are available.
Unfortunately, at the moment of writing Docker didn&#8217;t have such functionality out of the box.
One workaround would be to use 3rd party tools that can do the job, such as Watchtower <a href="#watchtower">[17]</a>,
but I decided not to use it due to lack of flexibility and security considerations
(as it requires access to the Docker engine).</p>
</div>
<div class="paragraph">
<p>While available Docker image versions can be checked on the Docker Hub website,
it is not very convenient way to do this if you have to check multiple images.
Arguably better solution is to use the script below that checks image version locally
and compares it against image versions fetched from the Docker Hub.
It then presents sorted lists of local and remote image tags (versions)
in a format that makes it easy to identify what (if any) newer images are available.
This is not the best solution,
as ideally I would like this script to simply give an answer if a newer version is available or not,
but at the moment I found no easy way to do this via Docker registry API.</p>
</div>
<div class="paragraph">
<p>Since the script uses <code>jq</code> tool to parse JSON, it needs to be installed first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt install jq</pre>
</div>
</div>
<div class="paragraph">
<p>To create this script, create the <code>/usr/local/sbin/check-docker-tags.sh</code> file with the following content:</p>
</div>
<div class="listingblock">
<div class="title">/usr/local/sbin/check-docker-tags.sh</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="bash"><span class="c">#!/bin/sh</span>

<span class="c"># List of images to check</span>
<span class="nv">IMAGES</span><span class="o">=</span><span class="s2">"debian httpd postgres"</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span class="k">for </span>IMAGE <span class="k">in</span> <span class="nv">$IMAGES</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">echo</span> <span class="s2">"&gt; Checking Image: </span><span class="nv">$IMAGE</span><span class="s2">"</span>
    <span class="nv">LOCAL_TAGS</span><span class="o">=</span><span class="sb">`</span><span class="nb">sudo </span>docker images <span class="nv">$IMAGE</span> <span class="nt">--format</span><span class="o">=</span><span class="s2">"{{.Tag}}"</span> | <span class="nb">sort</span> <span class="nt">-V</span> <span class="nt">-r</span><span class="sb">`</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$LOCAL_TAGS</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"&gt; No image tags found locally"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"&gt; Local Tags:"</span>
        <span class="k">for </span>LOCAL_TAG <span class="k">in</span> <span class="nv">$LOCAL_TAGS</span><span class="p">;</span> <span class="k">do
            </span><span class="nb">echo</span> <span class="s2">"      </span><span class="nv">$LOCAL_TAG</span><span class="s2">"</span>
        <span class="k">done

        </span><span class="nv">REMOTE_TAGS</span><span class="o">=</span><span class="sb">`</span>curl <span class="nt">-s</span> https://registry.hub.docker.com/v2/repositories/library/<span class="nv">$IMAGE</span>/tags/?page<span class="o">=</span>1<span class="se">\&amp;</span><span class="nv">page_size</span><span class="o">=</span>25 | jq .results[].name | <span class="nb">sort</span> <span class="nt">-V</span> <span class="nt">-r</span> | xargs<span class="sb">`</span>

        <span class="nb">echo</span> <span class="s2">"&gt; Remote Tags:"</span>
        <span class="k">for </span>REMOTE_TAG <span class="k">in</span> <span class="nv">$REMOTE_TAGS</span><span class="p">;</span> <span class="k">do
            </span><span class="nv">FOUND</span><span class="o">=</span>0
            <span class="k">for </span>LOCAL_TAG <span class="k">in</span> <span class="nv">$LOCAL_TAGS</span><span class="p">;</span> <span class="k">do
                if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$LOCAL_TAG</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$REMOTE_TAG</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                    </span><span class="nv">FOUND</span><span class="o">=</span>1
                    <span class="nb">break
                </span><span class="k">fi
            done</span>
            <span class="o">[</span> <span class="nv">$FOUND</span> <span class="nt">-eq</span> 1 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"    &gt; "</span>
            <span class="o">[</span> <span class="nv">$FOUND</span> <span class="nt">-eq</span> 0 <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"      "</span>
            <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$REMOTE_TAG</span><span class="s2">"</span>
        <span class="k">done
    fi
    </span><span class="nb">echo</span> <span class="s2">""</span>
<span class="k">done</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Set this variable to the list of images that you want to check.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Assign the following permissions to the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo chmod 755 /usr/local/sbin/check-docker-tags.sh</pre>
</div>
</div>
<div class="paragraph">
<p>To run the script simply do <code>check-docker-tags.sh</code>.</p>
</div>
<div class="paragraph">
<p>The sections below describe how to update Docker images when new image or new base image version is available.</p>
</div>
<div class="sect4">
<h5 id="_updating_socks5_proxy_image">Updating SOCKS5 Proxy Image</h5>
<div class="paragraph">
<p>Edit the <code>/root/silverbox/containers/vpn-proxy/docker-compose.yaml</code> file
and update the Debian image version in the build arguments:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/vpn-proxy/docker-compose.yaml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">args</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11.3-slim'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Stop the container, rebuild the image and start new container from the new image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/vpn-proxy/docker-compose.yaml down
sudo docker compose -f /root/silverbox/containers/vpn-proxy/docker-compose.yaml build --pull
sudo docker compose -f /root/silverbox/containers/vpn-proxy/docker-compose.yaml up -d</pre>
</div>
</div>
<div class="paragraph">
<p>Since the SSH host identity key is stored outside of the container on disk, proxy should reconnect seamlessly.</p>
</div>
</div>
<div class="sect4">
<h5 id="_updating_dns_updater_image">Updating DNS Updater Image</h5>
<div class="paragraph">
<p>Edit the <code>/root/silverbox/containers/dns-updater/Dockerfile</code> file and update the Debian image version:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/dns-updater/Dockerfile</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="docker"><span class="k">FROM</span><span class="s"> debian:11.3-slim</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Build the new image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker build -t dns-updater --network common /root/silverbox/containers/dns-updater</pre>
</div>
</div>
<div class="paragraph">
<p>Since the image is only used in a disposable container,
the new image will be picked up automatically next time the service runs.</p>
</div>
</div>
<div class="sect4">
<h5 id="_updating_transmission_image">Updating Transmission Image</h5>
<div class="paragraph">
<p>Edit the <code>/root/silverbox/containers/transmission/docker-compose.yaml</code> file
and update the Debian image version in the build arguments:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/transmission/docker-compose.yaml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">args</span><span class="pi">:</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">11.3-slim'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Stop the container, rebuild the image and start new container from the new image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/transmission/docker-compose.yaml down
sudo docker compose -f /root/silverbox/containers/transmission/docker-compose.yaml build --pull
sudo docker compose -f /root/silverbox/containers/transmission/docker-compose.yaml up -d</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_updating_reverse_proxy_image">Updating Reverse Proxy Image</h5>
<div class="paragraph">
<p>Edit the <code>/root/silverbox/containers/reverse-proxy/docker-compose.yml</code> file
and update the Apache httpd image version:</p>
</div>
<div class="listingblock">
<div class="title">/root/silverbox/containers/reverse-proxy/docker-compose.yml</div>
<div class="content">
<pre class="rouge highlight nowrap"><code data-lang="yaml"><span class="na">image</span><span class="pi">:</span> <span class="s1">'</span><span class="s">httpd:2.4.53'</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Stop the container, pull the new image and start new container from the new image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/reverse-proxy/docker-compose.yml down
sudo docker compose -f /root/silverbox/containers/reverse-proxy/docker-compose.yml pull
sudo docker compose -f /root/silverbox/containers/reverse-proxy/docker-compose.yml up -d</pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_nextcloud_2">16.1.4. Nextcloud</h4>
<div class="paragraph">
<p>By default, Nextcloud will automatically show notification when new version is available.
This can also be checked on the <em>Settings &#8594; Overview</em> page.</p>
</div>
<div class="paragraph">
<p>The upgrade procedures for Nextcloud are described in the Nextcloud admin guide
(<a href="https://docs.nextcloud.com/server/stable/admin_manual/maintenance/upgrade.html" class="bare">https://docs.nextcloud.com/server/stable/admin_manual/maintenance/upgrade.html</a>)
and in the Nextcloud Docker images repository readme (<a href="https://github.com/nextcloud/docker#update-to-a-newer-version" class="bare">https://github.com/nextcloud/docker#update-to-a-newer-version</a>).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
While Nextcloud supports skipping point releases (e.g. upgrading from 15.0.1 to 15.0.3 while skipping 15.0.2),
the admin guide recommends installing all point releases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before upgrading, it is good idea to consult changelog (<a href="https://nextcloud.com/changelog" class="bare">https://nextcloud.com/changelog</a>)
to see what is new in the new release and check if any extra steps are required during an upgrade.</p>
</div>
<div class="paragraph">
<p>To upgrade Nextcloud, first tear down the existing containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml down</pre>
</div>
</div>
<div class="paragraph">
<p>Edit the <code>/root/silverbox/containers/nextcloud/docker-compose.yml</code> file
and update Docker image version for <code>nextcloud-fpm</code>.
You can also update images for the Postgres database (<code>nextcloud-db</code>)
and the Apache httpd web server (<code>nextcloud-web</code>), if newer versions are available.
If upgrading Postgres image, make sure that the new version is supported by the Nextcloud
and check the Postgres documentation to see if any extra upgrade steps are required.</p>
</div>
<div class="paragraph">
<p>Pull and build new images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml pull
sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml build --pull</pre>
</div>
</div>
<div class="paragraph">
<p>Start Nextcloud:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/nextcloud/docker-compose.yml up -d</pre>
</div>
</div>
<div class="paragraph">
<p>Open the Nextcloud UI and upgrade prompt should appear. Upgrade can be initiated from this prompt.</p>
</div>
<div class="paragraph">
<p>After upgrade, navigate to the <em>Settings &#8594; Overview</em> page and see if any new warnings have appeared.
If you see any warnings, consult Nextcloud admin guide on how to fix them.</p>
</div>
</div>
<div class="sect3">
<h4 id="_firefly_iii_2">16.1.5. Firefly III</h4>
<div class="paragraph">
<p>Checking for a new version can be done in the Web UI.
Navigate to <em>Options &#8594; Administration &#8594; Check for updates</em> page and click <em>Check Now!</em> button under the <em>Check for updates now</em> section.</p>
</div>
<div class="paragraph">
<p>The upgrade instructions for Firefly III are described in the documentation
(<a href="https://docs.firefly-iii.org/advanced-installation/upgrade" class="bare">https://docs.firefly-iii.org/advanced-installation/upgrade</a>).
For Docker Compose deployment it is simply updating Docker images.</p>
</div>
<div class="paragraph">
<p>Before upgrading, it is good idea to consult changelog (<a href="https://github.com/firefly-iii/firefly-iii/blob/main/changelog.md" class="bare">https://github.com/firefly-iii/firefly-iii/blob/main/changelog.md</a>)
to see what is new in the new release and check if any extra steps are required during an upgrade.</p>
</div>
<div class="paragraph">
<p>To upgrade Firefly III, first tear down the existing containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/firefly/docker-compose.yml down</pre>
</div>
</div>
<div class="paragraph">
<p>Edit the <code>/root/silverbox/containers/firefly/docker-compose.yml</code> file
and update Docker image version for <code>firefly-app</code>.
You can also update image for the Postgres database (<code>firefly-db</code>), if newer image is available.</p>
</div>
<div class="paragraph">
<p>Pull new images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/firefly/docker-compose.yml pull</pre>
</div>
</div>
<div class="paragraph">
<p>Start Firefly III:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker compose -f /root/silverbox/containers/firefly/docker-compose.yml up -d</pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring_11">16.2. Monitoring</h3>
<div class="paragraph">
<p>This section gives some ideas on how to monitor system health and overall status.</p>
</div>
<div class="sect3">
<h4 id="_monit_2">16.2.1. Monit</h4>
<div class="paragraph">
<p>Monit has a lot of useful information about the system and running services,
and it worth checking it from time to time.</p>
</div>
<div class="paragraph">
<p>This information can either be viewed in the Monit web interface, or via the <code>sudo monit status</code> command.</p>
</div>
</div>
<div class="sect3">
<h4 id="_logs">16.2.2. Logs</h4>
<div class="paragraph">
<p>Logs from the system and different services can provide a lot of useful information
and should be checked periodically for anomalies and errors.</p>
</div>
<div class="sect4">
<h5 id="_system_logs">System Logs</h5>
<div class="paragraph">
<p>Ubuntu collects system logs with Systemd Journald service, so most of the logs can be viewed using <code>journalctl</code> tool.</p>
</div>
<div class="paragraph">
<p>For example, to view all log messages since system boot with priority level warning or above do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">journalctl -p warning -b</pre>
</div>
</div>
<div class="paragraph">
<p>For more examples on how to use <code>journalctl</code> to view logs refer to <code>journalctl</code> documentation.</p>
</div>
<div class="paragraph">
<p>Some logs are also written into files under <code>/var/log</code> directory
and can be viewed with any text editor or with <code>cat</code>/<code>tail</code> commands.</p>
</div>
</div>
<div class="sect4">
<h5 id="_systemd_service_logs">Systemd Service Logs</h5>
<div class="paragraph">
<p>Logs from Systemd services can be viewed with the <code>journalctl</code> command as well.
For example, to view Docker service logs do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">journalctl -u docker.service</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_docker_logs">Docker Logs</h5>
<div class="paragraph">
<p>By convention, processes running inside Docker containers write log output to the standard output stream.
These logs then collected by the Docker engine and can be viewed with <code>docker logs</code> command.
For example, to view Nextcloud&#8217;s PostgreSQL container logs do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker logs nextcloud-db</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_nextcloud_logs">Nextcloud Logs</h5>
<div class="paragraph">
<p>Apart from the Nextcloud containers logs,
Nextcloud maintains its own log that can be viewed on the <em>Settings &#8594; Logging</em> page.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_disk_health">16.2.3. Disk Health</h4>
<div class="paragraph">
<p>Monitoring disk status and health is crucial in preventing data loss and diagnosing performance issues.
It is especially important for SSDs since every SSD cell have limited number of times it can be erased and written.</p>
</div>
<div class="paragraph">
<p>Some information about disks and file systems is available in Monit.</p>
</div>
<div class="paragraph">
<p>To view how much data was read/written to the disk since system boot you can use <code>vmstat -d</code> command.
The output of this command is in sectors rather than bytes.
To find sector size check the output of <code>sudo fdisk -l</code> command.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It appears that the system counts discarded blocks
(i.e. free blocks reported to SSD when <code>fstrim</code> is done, by default once a week) as writes,
thus inflating total sectors written count as reported by the <code>vmstat -d</code> command.
This means that the <code>vmstat -d</code> output will only be accurate since reboot until the first <code>fstrim</code> run.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To view what processes are utilizing the disk you can use <code>iotop</code> tool, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo iotop -aoP</pre>
</div>
</div>
<div class="paragraph">
<p>To install <code>iotop</code> do: <code>sudo apt install iotop</code>.</p>
</div>
<div class="paragraph">
<p>To retrieve SMART (Self-Monitoring, Analysis and Reporting Technology) data from the disk you can use <code>smartctl</code> tool
from the <code>smartmontools</code> package.</p>
</div>
<div class="paragraph">
<p>To read SMART data from the disk do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo smartctl -a /dev/sda <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Replace <code>/dev/sda</code> with the actual disk device.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The actual output of this command will depend on the disk model and manufacturer.
Usually it has a lot of useful information such as total number of blocks written, media wearout, errors, etc.</p>
</div>
<div class="paragraph">
<p>However, the output from <code>smartctl</code> is only accurate if the disk is present in the <code>smartctl</code> database so that
SMART fields can be decoded and interpreted correctly.
Usually the database has most of the consumer SSDs, however, Ubuntu uses extremely outdated version of this database
so there is a good chance you disk won&#8217;t be there.
If in the <code>smartctl</code> output you see line similar to this: <code>Device is: Not in smartctl database</code>,
this means your disk is not in the current database and you cannot really trust the output.</p>
</div>
<div class="paragraph">
<p>Normally the <code>smartctl</code> database can be easily updated using <code>update-smart-drivedb</code> script, however,
for dubious reasons Ubuntu package maintainers decided not to include this script in the <code>smartmontools</code> package.
Fortunately, this database is just a single file that can be downloaded from the <code>smartmontools</code> GitHub mirror:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">wget https://github.com/mirror/smartmontools/raw/master/drivedb.h</pre>
</div>
</div>
<div class="paragraph">
<p>This new database file can then be passed to <code>smartctl</code> like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo smartctl -a /dev/sda -B drivedb.h</pre>
</div>
</div>
<div class="paragraph">
<p>It is very important to monitor SSD media wearout and quickly find and diagnose abnormally high write rates
to prevent possible unexpected data loss and disk failure.
Even though modern SSDs are quite durable and smart about wear leveling,
one service writing tons of logs non stop could be enough to wear the disk prematurely.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_keeping_system_clean">16.3. Keeping System Clean</h3>
<div class="paragraph">
<p>This section gives some ideas on how to keep the system clean
and how to prevent accumulation of unnecessary or obsolete information.</p>
</div>
<div class="sect3">
<h4 id="_cleaning_system_packages">16.3.1. Cleaning System Packages</h4>
<div class="paragraph">
<p>To remove no longer required packages do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo apt autoremove</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cleaning_docker">16.3.2. Cleaning Docker</h4>
<div class="paragraph">
<p>To view how much space is used by Docker:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker system df</pre>
</div>
</div>
<div class="paragraph">
<p>A lot of unused Docker images can accumulate after upgrades.
To remove all dangling images do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker image prune</pre>
</div>
</div>
<div class="paragraph">
<p>This, however, only removes dangling images, but leaves images that are not dangling but can still be unused.
All unused images can be removed with the <code>-a</code> flag,
but this is dangerous as some images that are <em>not used</em> at the moment
can still be required later (for example, the <code>dns-updater</code> image).</p>
</div>
<div class="paragraph">
<p>One solution is to remove all currently unused images semi-manually:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker rmi `sudo docker images -q nextcloud:*`
sudo docker rmi `sudo docker images -q httpd:*`
sudo docker rmi `sudo docker images -q postgres:*`</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This will generate errors and skip deletion of images that are currently in use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To clean Docker build cache do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo docker builder prune</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cleaning_and_minimizing_logs">16.3.3. Cleaning and Minimizing Logs</h4>
<div class="sect4">
<h5 id="_cleaning_old_system_logs">Cleaning Old System Logs</h5>
<div class="paragraph">
<p>System logs will grow over time.
To check size of all Journald logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">journalctl --disk-usage</pre>
</div>
</div>
<div class="paragraph">
<p>Journald logs can be easily cleaned by size:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo journalctl --vacuum-size=500M</pre>
</div>
</div>
<div class="paragraph">
<p>or by time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo journalctl --vacuum-time=2years</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_adjusting_journald_configuration">Adjusting Journald Configuration</h5>
<div class="paragraph">
<p>In the default Journald configuration in Ubuntu the Journald messages are also forwarded to syslog,
which is unnecessary (unless you use specific tools that rely on that).
This can be disabled by setting <code>ForwardToSyslog</code> parameter to <code>no</code> in the <code>/etc/systemd/journald.conf</code> file.</p>
</div>
<div class="paragraph">
<p>Additionally, to potentially reduce writes to disk you can increase <code>SyncIntervalSec</code> parameter
in the <code>/etc/systemd/journald.conf</code> file.
This parameter controls how frequently Journald messages are synced to disk,
so only increase it if the server is connected to reliable UPS and unexpected shutdowns are unlikely.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_disabling_motd_news">16.3.4. Disabling Motd-News</h4>
<div class="paragraph">
<p>By default, Ubuntu will fetch news daily to show them in the message of the day (motd),
which I find rather annoying and unnecessary flooding the logs.
To disable it, edit the <code>/etc/default/motd-news</code> file and change <code>ENABLED</code> parameter to <code>0</code>.
While this removes news from the motd, it doesn&#8217;t stop <code>motd-news</code> timer.
To stop and disable the timer, do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="nowrap">sudo systemctl stop motd-news.timer
sudo systemctl disable motd-news.timer</pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_references_2">References</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="changelog"></a>[1] &#8220;Silverbox Changelog&#8221;: <a href="https://github.com/ovk/silverbox/blob/master/CHANGELOG" class="bare">https://github.com/ovk/silverbox/blob/master/CHANGELOG</a></p>
</li>
<li>
<p><a id="nut_hcl"></a>[2] &#8220;Network UPS Tools: Hardware compatibility list&#8221;: <a href="https://networkupstools.org/stable-hcl.html" class="bare">https://networkupstools.org/stable-hcl.html</a></p>
</li>
<li>
<p><a id="arch_wiki_ssd"></a>[3] &#8220;Arch Wiki: Solid state drive&#8221;: <a href="https://wiki.archlinux.org/index.php/Solid_state_drive" class="bare">https://wiki.archlinux.org/index.php/Solid_state_drive</a></p>
</li>
<li>
<p><a id="ssh_audit"></a>[4] &#8220;ssh-audit script&#8221;: <a href="https://github.com/arthepsy/ssh-audit" class="bare">https://github.com/arthepsy/ssh-audit</a></p>
</li>
<li>
<p><a id="arch_wiki_hddtemp"></a>[5] &#8220;Arch Wiki: Hddtemp&#8221;: <a href="https://wiki.archlinux.org/index.php/Hddtemp" class="bare">https://wiki.archlinux.org/index.php/Hddtemp</a></p>
</li>
<li>
<p><a id="unbound"></a>[6] &#8220;Unbound DNS Server&#8221;: <a href="https://nlnetlabs.nl/projects/unbound" class="bare">https://nlnetlabs.nl/projects/unbound</a></p>
</li>
<li>
<p><a id="cloudflare_dns"></a>[7] &#8220;Cloudflare DNS Server&#8221;: <a href="https://www.cloudflare.com/learning/dns/what-is-1.1.1.1" class="bare">https://www.cloudflare.com/learning/dns/what-is-1.1.1.1</a></p>
</li>
<li>
<p><a id="docker_compose"></a>[8] &#8220;Docker Compose&#8221;: <a href="https://docs.docker.com/compose" class="bare">https://docs.docker.com/compose</a></p>
</li>
<li>
<p><a id="name_silo"></a>[9] &#8220;NameSilo&#8221;: <a href="https://namesilo.com" class="bare">https://namesilo.com</a></p>
</li>
<li>
<p><a id="transmission"></a>[10] &#8220;Transmission&#8221;: <a href="https://transmissionbt.com" class="bare">https://transmissionbt.com</a></p>
</li>
<li>
<p><a id="nextcloud"></a>[11] &#8220;Nextcloud&#8221;: <a href="https://nextcloud.com" class="bare">https://nextcloud.com</a></p>
</li>
<li>
<p><a id="lets_encrypt"></a>[12] &#8220;Let&#8217;s Encrypt&#8221;: <a href="https://letsencrypt.org" class="bare">https://letsencrypt.org</a></p>
</li>
<li>
<p><a id="certbot"></a>[13] &#8220;Certbot&#8221;: <a href="https://certbot.eff.org" class="bare">https://certbot.eff.org</a></p>
</li>
<li>
<p><a id="borgbackup"></a>[14] &#8220;Borg Backup&#8221;: <a href="https://www.borgbackup.org" class="bare">https://www.borgbackup.org</a></p>
</li>
<li>
<p><a id="ovh_object_storage"></a>[15] &#8220;OVH Object Storage&#8221;: <a href="https://www.ovh.com/world/public-cloud/storage/object-storage" class="bare">https://www.ovh.com/world/public-cloud/storage/object-storage</a></p>
</li>
<li>
<p><a id="rclone"></a>[16] &#8220;Rclone&#8221;: <a href="https://rclone.org" class="bare">https://rclone.org</a></p>
</li>
<li>
<p><a id="watchtower"></a>[17] &#8220;Watchtower&#8221;: <a href="https://containrrr.github.io/watchtower" class="bare">https://containrrr.github.io/watchtower</a></p>
</li>
<li>
<p><a id="git_server"></a>[18] &#8220;Git Book: Git Server&#8221;: <a href="https://git-scm.com/book/en/v2/Git-on-the-Server-Setting-Up-the-Server" class="bare">https://git-scm.com/book/en/v2/Git-on-the-Server-Setting-Up-the-Server</a></p>
</li>
<li>
<p><a id="htpasswd"></a>[19] &#8220;htpasswd&#8221;: <a href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html" class="bare">https://httpd.apache.org/docs/2.4/programs/htpasswd.html</a></p>
</li>
<li>
<p><a id="firefly"></a>[20] &#8220;Firefly III&#8221;: <a href="https://www.firefly-iii.org" class="bare">https://www.firefly-iii.org</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. The name <em>"silverbox"</em> originates from some Intel NUCs visual appearance - literally a little silver box.
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. <a href="https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=519700" class="bare">https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=519700</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://certbot.eff.org/lets-encrypt/ubuntubionic-other" class="bare">https://certbot.eff.org/lets-encrypt/ubuntubionic-other</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.3.2<br>
</div>
</div>
</body>
</html>